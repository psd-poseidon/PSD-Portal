<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSD Portal</title>
  <style>
    :root{
      --bg:#0b1020; --card:#101a35; --txt:#eaf0ff; --muted:#9fb0d6; --line:rgba(255,255,255,.12);
      --accent:#3b82f6; --accentSoft:rgba(59,130,246,.16); --shadow:0 12px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt);
      background:
        radial-gradient(1100px 800px at 20% 10%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 30%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1300px;margin:0 auto;padding:16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#22c55e);box-shadow:var(--shadow)}
    .title b{display:block;font-size:16px}
    .title span{display:block;font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}
    .card{background:rgba(16,26,53,.85);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .hd{padding:14px 14px 0 14px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .hd h2{margin:0;font-size:15px}
    .hd p{margin:6px 0 0 0;font-size:12px;color:var(--muted)}
    .bd{padding:14px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:980px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(6,10,22,.72);color:var(--txt);outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(147,197,253,.6);box-shadow:0 0 0 4px rgba(59,130,246,.18)}
    textarea{min-height:90px;resize:vertical}
    .btn{
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:transparent;color:var(--txt);cursor:pointer;user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .primary{background:var(--accentSoft);border-color:rgba(59,130,246,.45)}
    .success{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.45)}
    .danger{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.45)}
    .warn{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.45)}
    .small{padding:7px 10px;border-radius:10px;font-size:12px}
    .hidden{display:none !important}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .modes{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:980px){.modes{grid-template-columns:1fr}}
    .mode{
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(6,10,22,.68), rgba(6,10,22,.40));
      cursor:pointer;
    }
    .mode.active{border-color:rgba(147,197,253,.6);background:linear-gradient(180deg, rgba(59,130,246,.20), rgba(6,10,22,.40))}
    .mode b{display:block}
    .mode span{font-size:12px;color:var(--muted)}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(6,10,22,.45);color:var(--muted);cursor:pointer;font-size:12px}
    .chip.active{background:var(--accentSoft);border-color:rgba(147,197,253,.6);color:var(--txt)}
    .report{
      border:1px solid var(--line);border-radius:16px;padding:12px;
      background:linear-gradient(180deg, rgba(6,10,22,.64), rgba(6,10,22,.35));
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start
    }
    .report b{display:block}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:9px 8px;text-align:left;font-size:12px;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .console{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:99;
      border-radius:16px;border:1px solid var(--line);background:rgba(6,10,22,.92);
      box-shadow:var(--shadow);overflow:hidden
    }
    .console .chd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
    .console pre{margin:0;padding:10px 12px;max-height:180px;overflow:auto;font-size:11px;color:#dbe7ff}
    .swatches{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .sw{width:22px;height:22px;border-radius:8px;border:1px solid var(--line);cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>PSD Portal</b>
        <span>Normal · Super User · Admin | Firma + Rol bazlı rapor erişimi</span>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
      <div class="swatches">
        <span class="pill">Tema</span>
        <div class="sw" style="background:#3b82f6" onclick="setTheme('#3b82f6')"></div>
        <div class="sw" style="background:#22c55e" onclick="setTheme('#22c55e')"></div>
        <div class="sw" style="background:#f59e0b" onclick="setTheme('#f59e0b')"></div>
        <div class="sw" style="background:#a855f7" onclick="setTheme('#a855f7')"></div>
        <div class="sw" style="background:#ef4444" onclick="setTheme('#ef4444')"></div>
      </div>

      <span class="pill" id="dbPill">DB: —</span>
      <button class="btn small" id="logoutBtn" onclick="logout()" style="display:none;">Çıkış</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="row" id="loginRow">
    <div class="card" style="flex:1.2;min-width:340px">
      <div class="hd">
        <div>
          <h2>Giriş</h2>
          <p>Normal / Super User / Admin</p>
        </div>
        <span class="badge" id="modeBadge">NORMAL</span>
      </div>
      <div class="bd grid" style="gap:12px">
        <div class="modes">
          <div class="mode active" id="m_NORMAL" onclick="setMode('NORMAL')">
            <b>Normal Kullanıcı</b><span>Firma zorunlu · Firma + rol bazlı rapor</span>
          </div>
          <div class="mode" id="m_SUPER" onclick="setMode('SUPER')">
            <b>Super User</b><span>Firma bağımsız · Tüm raporlar</span>
          </div>
          <div class="mode" id="m_ADMIN" onclick="setMode('ADMIN')">
            <b>Admin</b><span>Firma/rol/kullanıcı/rapor yönetimi</span>
          </div>
        </div>

        <div class="grid g2">
          <div>
            <label>Kullanıcı adı</label>
            <input id="inUser" autocomplete="username">
          </div>
          <div>
            <label>Şifre</label>
            <input id="inPass" type="password" autocomplete="current-password">
          </div>
        </div>

        <div id="firmWrap">
          <label>Firma (Normal için)</label>
          <input id="inFirm" placeholder="Örn: Sudesan">
        </div>

        <div class="right">
          <button class="btn primary" onclick="login()">Giriş Yap</button>
          <button class="btn" onclick="fillDemo()">Demo doldur</button>
          <button class="btn warn" onclick="hardReset()">DB Sıfırla</button>
        </div>

        <div style="font-size:12px;color:var(--muted);line-height:1.45">
          Not: Bu sürüm <b>LocalStorage</b> kullanır. Tarayıcı/site verisi temizlenirse veri “silinmiş” gibi görünür.
        </div>
      </div>
    </div>

    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Özet</h2>
          <p>DB içeriği</p>
        </div>
      </div>
      <div class="bd">
        <div class="chipRow">
          <span class="badge" id="kF">Firms: 0</span>
          <span class="badge" id="kR">Roles: 0</span>
          <span class="badge" id="kU">Users: 0</span>
          <span class="badge" id="kS">Super: 0</span>
          <span class="badge" id="kP">Reports: 0</span>
        </div>
        <div class="hr"></div>
        <div style="font-size:12px;color:var(--muted)">
          Eğer altta “Hata Konsolu”nda kırmızı hata görürsen, kopyalayıp buraya at.
        </div>
      </div>
    </div>
  </div>

  <!-- PORTAL -->
  <div class="row hidden" id="mainRow">
    <div class="card" style="flex:2.2;min-width:340px">
      <div class="hd">
        <div>
          <h2 id="mainTitle">Portal</h2>
          <p id="mainSub">—</p>
        </div>
        <div class="right">
          <button class="btn small" onclick="render()">Yenile</button>
          <button class="btn small warn hidden" id="openAdminBtn" onclick="openAdmin()">Admin</button>
        </div>
      </div>
      <div class="bd grid" style="gap:10px">
        <!-- Normal user: category buttons -->
        <div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Kategoriler</div>
          <div class="chipRow" id="catChips"></div>
        </div>

        <div class="grid g3">
          <div>
            <label>Arama</label>
            <input id="qSearch" placeholder="rapor adı..." oninput="renderReports()">
          </div>
          <div>
            <label>Kategori</label>
            <select id="catSel" onchange="syncChipFromSel();renderReports()"></select>
          </div>
          <div>
            <label>Sıralama</label>
            <select id="sortSel" onchange="renderReports()">
              <option value="cat">Kategori + Ad</option>
              <option value="name">Ad</option>
            </select>
          </div>
        </div>

        <div class="grid" id="repList"></div>
      </div>
    </div>

    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Oturum</h2>
          <p>Kimlik ve yetki</p>
        </div>
        <span class="badge" id="sessBadge">—</span>
      </div>
      <div class="bd grid" style="gap:10px">
        <div>
          <div style="font-size:12px;color:var(--muted)">Kullanıcı</div>
          <div style="font-weight:700" id="sessUser">—</div>
        </div>
        <div class="grid g2">
          <div>
            <div style="font-size:12px;color:var(--muted)">Mod</div>
            <div id="sessMode">—</div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--muted)">Firma</div>
            <div id="sessFirm">—</div>
          </div>
        </div>
        <div>
          <div style="font-size:12px;color:var(--muted)">Roller</div>
          <div id="sessRoles" style="font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px">—</div>
        </div>
        <div class="hr"></div>
        <div style="font-size:12px;color:var(--muted);line-height:1.45">
          Normal kullanıcı sadece <b>kendi firmasına</b> ve <b>rolüne</b> atanmış raporları görür.
          Super User tüm raporları görür.
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="card hidden" id="adminCard" style="margin-top:14px">
    <div class="hd">
      <div>
        <h2>Admin Paneli</h2>
        <p>Değişiklikler sadece <b>Kaydet</b> basınca aktif olur.</p>
      </div>
      <div class="right">
        <span class="badge" id="dirtyBadge" style="display:none;border-color:rgba(245,158,11,.55)">Kaydedilmemiş</span>
        <button class="btn success" onclick="saveDraft()">Kaydet</button>
        <button class="btn" onclick="closeAdmin()">Kapat</button>
      </div>
    </div>
    <div class="bd">
      <div class="chipRow" id="adminTabs"></div>
      <div class="hr"></div>
      <div id="adminBody"></div>
    </div>
  </div>
</div>

<!-- Visible error console -->
<div class="console" id="consoleBox">
  <div class="chd">
    <span class="pill">Hata Konsolu (çalışmazsa burayı kopyala)</span>
    <div class="right">
      <button class="btn small" onclick="clearLog()">Temizle</button>
      <button class="btn small" onclick="toggleConsole()">Gizle/Göster</button>
    </div>
  </div>
  <pre id="log"></pre>
</div>

<script>
/* =============================
  ERROR LOG
============================= */
const logEl = document.getElementById("log");
function log(msg){ logEl.textContent += msg + "\n"; }
function clearLog(){ logEl.textContent=""; }
function toggleConsole(){
  const box = document.getElementById("consoleBox");
  const pre = document.getElementById("log");
  pre.style.display = (pre.style.display==="none") ? "block" : "none";
}
window.addEventListener("error", (e)=>{
  log("❌ ERROR: " + (e.message || "unknown") + " @ " + (e.filename||"") + ":" + (e.lineno||0));
});
window.addEventListener("unhandledrejection", (e)=>{
  log("❌ PROMISE: " + (e.reason?.message || e.reason || "unknown"));
});

/* =============================
  STATE
============================= */
const LS_DB="psd_portal_db_v3";
const LS_THEME="psd_portal_theme_v1";

let DB = null;
let DRAFT = null;
let DIRTY = false;

let MODE="NORMAL";
let SESSION=null;
let ACTIVE_CAT="ALL";
let ACTIVE_TAB="firms";

/* =============================
  THEME
============================= */
function setTheme(accent){
  document.documentElement.style.setProperty("--accent", accent);
  document.documentElement.style.setProperty("--accentSoft", hexToRgba(accent, .16));
  localStorage.setItem(LS_THEME, accent);
}
function loadTheme(){
  const t = localStorage.getItem(LS_THEME);
  if(t) setTheme(t);
}
function hexToRgba(hex, a){
  try{
    const h=hex.replace("#","").trim();
    const r=parseInt(h.slice(0,2),16);
    const g=parseInt(h.slice(2,4),16);
    const b=parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }catch(_){ return "rgba(59,130,246,.16)"; }
}

/* =============================
  DB SEED
============================= */
function seed(){
  return {
    meta:{version:3, updatedAt:new Date().toISOString()},
    firms:[
      {firmKey:"SUDESAN", name:"Sudesan", aliases:["Sudesan","sudesan","SUDESAN"]},
      {firmKey:"ELIDA", name:"Elida", aliases:["Elida","elida","ELIDA"]}
    ],
    roles:[
      {roleKey:"VIEWER", name:"Viewer"},
      {roleKey:"MANAGER", name:"Manager"},
      {roleKey:"PLANNER", name:"Planner"},
      {roleKey:"ADMIN", name:"Admin"}
    ],
    users:[
      {userId:"u_admin", username:"admin", password:"admin123", fullName:"Admin", isAdmin:true, isSuper:false},
      {userId:"u_super", username:"super", password:"super123", fullName:"Super User", isAdmin:false, isSuper:true},
      {userId:"u_user",  username:"user",  password:"1234",     fullName:"Normal User", isAdmin:false, isSuper:false}
    ],
    // user->firm membership
    userFirms:[
      {id:gid("uf"), userId:"u_user", firmKey:"SUDESAN"}
    ],
    // user roles
    userRoles:[
      {id:gid("ur"), userId:"u_user", roleKey:"MANAGER"},
      {id:gid("ur"), userId:"u_admin", roleKey:"ADMIN"}
    ],
    // firm login rules (NORMAL): which roles can login to that firm
    firmAccessRoles:[
      {id:gid("far"), firmKey:"SUDESAN", roleKey:"MANAGER"},
      {id:gid("far"), firmKey:"SUDESAN", roleKey:"PLANNER"}
    ],
    categories:[
      {catKey:"SCM", name:"Tedarik Zinciri"},
      {catKey:"OPS", name:"Operasyon"},
      {catKey:"FIN", name:"Finans"}
    ],
    reports:[
      {reportId:"r1", name:"Stok & Servis Seviyesi", url:"https://lookerstudio.google.com/", catKey:"SCM"},
      {reportId:"r2", name:"Operasyon KPI", url:"https://lookerstudio.google.com/", catKey:"OPS"},
      {reportId:"r3", name:"Nakit Akışı", url:"https://lookerstudio.google.com/", catKey:"FIN"}
    ],
    reportFirms:[
      {id:gid("rf"), reportId:"r1", firmKey:"SUDESAN"},
      {id:gid("rf"), reportId:"r2", firmKey:"SUDESAN"},
      {id:gid("rf"), reportId:"r3", firmKey:"ELIDA"}
    ],
    // report access rules: if none for a report -> all firm members can see
    reportAccess:[
      {id:gid("ra"), reportId:"r1", allowedRoleKeys:["MANAGER","PLANNER"], allowedUserIds:[]}
    ]
  };
}
function gid(p){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }

function loadDB(){
  try{
    const raw = localStorage.getItem(LS_DB);
    if(!raw){ DB=seed(); saveDB(DB); return; }
    DB = JSON.parse(raw);
    if(!DB || !DB.meta){ DB=seed(); saveDB(DB); }
  }catch(e){
    log("DB load error: "+e.message);
    DB=seed(); saveDB(DB);
  }
}
function saveDB(db){
  db.meta = db.meta || {};
  db.meta.version = 3;
  db.meta.updatedAt = new Date().toISOString();
  localStorage.setItem(LS_DB, JSON.stringify(db));
  document.getElementById("dbPill").textContent = "DB: LocalStorage ✓";
  updateKPIs();
}
function hardReset(){
  if(!confirm("DB sıfırlansın mı?")) return;
  localStorage.removeItem(LS_DB);
  loadDB();
  updateKPIs();
  alert("DB sıfırlandı.");
}

/* =============================
  LOGIN
============================= */
function setMode(m){
  MODE=m;
  ["NORMAL","SUPER","ADMIN"].forEach(x=>{
    document.getElementById("m_"+x).classList.toggle("active", x===m);
  });
  document.getElementById("modeBadge").textContent = m;
  document.getElementById("firmWrap").classList.toggle("hidden", m!=="NORMAL");
}
function fillDemo(){
  const u=document.getElementById("inUser");
  const p=document.getElementById("inPass");
  const f=document.getElementById("inFirm");
  if(MODE==="ADMIN"){ u.value="admin"; p.value="admin123"; f.value=""; }
  if(MODE==="SUPER"){ u.value="super"; p.value="super123"; f.value=""; }
  if(MODE==="NORMAL"){ u.value="user"; p.value="1234"; f.value="Sudesan"; }
}
function findUser(username){
  const u=(username||"").trim().toLowerCase();
  return DB.users.find(x=>(x.username||"").toLowerCase()===u) || null;
}
function rolesOf(userId){
  return Array.from(new Set(DB.userRoles.filter(x=>x.userId===userId).map(x=>x.roleKey)));
}
function firmKeyFromInput(name){
  const s=(name||"").trim().toLowerCase();
  if(!s) return null;
  for(const f of DB.firms){
    if((f.firmKey||"").toLowerCase()===s) return f.firmKey;
    if((f.name||"").toLowerCase()===s) return f.firmKey;
    for(const a of (f.aliases||[])){ if((a||"").toLowerCase()===s) return f.firmKey; }
  }
  return null;
}
function isFirmMember(userId, firmKey){
  return DB.userFirms.some(x=>x.userId===userId && x.firmKey===firmKey);
}
function firmLoginAllowed(firmKey, userRoleKeys){
  const rules = DB.firmAccessRoles.filter(x=>x.firmKey===firmKey).map(x=>x.roleKey);
  if(rules.length===0) return true;
  return userRoleKeys.some(r=>rules.includes(r));
}

function login(){
  const username=document.getElementById("inUser").value;
  const pass=document.getElementById("inPass").value;
  const firm=document.getElementById("inFirm").value;

  const u=findUser(username);
  if(!u || u.password!==pass){ alert("Kullanıcı adı/şifre hatalı"); return; }

  const rks=rolesOf(u.userId);

  if(MODE==="ADMIN"){
    if(!(u.isAdmin || rks.includes("ADMIN"))){ alert("Admin yetkisi yok"); return; }
    SESSION={mode:"ADMIN", userId:u.userId, username:u.username, fullName:u.fullName, firmKey:null, roles:rks, isSuper:!!u.isSuper, isAdmin:true};
  }
  if(MODE==="SUPER"){
    if(!u.isSuper){ alert("Super User değil"); return; }
    SESSION={mode:"SUPER", userId:u.userId, username:u.username, fullName:u.fullName, firmKey:null, roles:rks, isSuper:true, isAdmin:!!u.isAdmin};
  }
  if(MODE==="NORMAL"){
    const fk=firmKeyFromInput(firm);
    if(!fk){ alert("Firma bulunamadı"); return; }
    if(!isFirmMember(u.userId, fk)){ alert("Kullanıcı bu firmaya bağlı değil"); return; }
    if(!firmLoginAllowed(fk, rks)){ alert("Bu rollerle bu firmaya giriş izni yok"); return; }
    SESSION={mode:"NORMAL", userId:u.userId, username:u.username, fullName:u.fullName, firmKey:fk, roles:rks, isSuper:!!u.isSuper, isAdmin:!!u.isAdmin};
  }

  document.getElementById("loginRow").classList.add("hidden");
  document.getElementById("mainRow").classList.remove("hidden");
  document.getElementById("logoutBtn").style.display="inline-flex";
  document.getElementById("openAdminBtn").classList.toggle("hidden", SESSION.mode!=="ADMIN");
  render();
}
function logout(){
  SESSION=null;
  closeAdmin();
  document.getElementById("mainRow").classList.add("hidden");
  document.getElementById("loginRow").classList.remove("hidden");
  document.getElementById("logoutBtn").style.display="none";
}

/* =============================
  PORTAL VIEW
============================= */
function firmName(fk){
  const f=DB.firms.find(x=>x.firmKey===fk);
  return f ? f.name : (fk||"—");
}
function catName(ck){
  const c=DB.categories.find(x=>x.catKey===ck);
  return c ? c.name : (ck||"—");
}
function accessibleReports(){
  if(!SESSION) return [];
  if(SESSION.mode==="SUPER") return DB.reports.slice();
  if(SESSION.mode==="ADMIN") return DB.reports.slice();

  const fk=SESSION.firmKey;
  const ids=new Set(DB.reportFirms.filter(x=>x.firmKey===fk).map(x=>x.reportId));
  let list=DB.reports.filter(r=>ids.has(r.reportId));

  // role/user access layer
  const roleSet=new Set(SESSION.roles);
  list=list.filter(r=>{
    const rule=DB.reportAccess.find(x=>x.reportId===r.reportId);
    if(!rule) return true; // default: firm members can see
    const allowUsers=new Set(rule.allowedUserIds||[]);
    const allowRoles=new Set(rule.allowedRoleKeys||[]);
    if(allowUsers.has(SESSION.userId)) return true;
    if(allowUsers.size===0 && allowRoles.size===0) return true;
    for(const rk of roleSet){ if(allowRoles.has(rk)) return true; }
    return false;
  });

  return list;
}
function render(){
  document.getElementById("mainTitle").textContent="Portal";
  document.getElementById("mainSub").textContent =
    SESSION.mode==="NORMAL"
      ? `Firma: ${firmName(SESSION.firmKey)} · Firma+rol bazlı raporlar`
      : (SESSION.mode==="SUPER" ? "Super User · Firma bağımsız tüm raporlar" : "Admin · Yönetim paneli aktif");

  document.getElementById("sessBadge").textContent=SESSION.mode;
  document.getElementById("sessUser").textContent=SESSION.fullName||SESSION.username;
  document.getElementById("sessMode").textContent=SESSION.mode;
  document.getElementById("sessFirm").textContent=SESSION.firmKey ? firmName(SESSION.firmKey) : "—";
  document.getElementById("sessRoles").textContent=(SESSION.roles||[]).join(", ") || "—";

  buildCategories();
  renderReports();
}
function buildCategories(){
  const list=accessibleReports();
  const catKeys = Array.from(new Set(list.map(r=>r.catKey))).sort();

  // select
  const sel=document.getElementById("catSel");
  sel.innerHTML="";
  sel.append(new Option("Tümü","ALL"));
  catKeys.forEach(k=> sel.append(new Option(catName(k), k)));
  if(!catKeys.includes(ACTIVE_CAT)) ACTIVE_CAT="ALL";
  sel.value=ACTIVE_CAT;

  // chips
  const chips=document.getElementById("catChips");
  chips.innerHTML="";
  chips.append(chip("ALL","Tümü"));
  catKeys.forEach(k=> chips.append(chip(k, catName(k))));
}
function chip(key,label){
  const el=document.createElement("div");
  el.className="chip"+(ACTIVE_CAT===key?" active":"");
  el.textContent=label;
  el.onclick=()=>{
    ACTIVE_CAT=key;
    document.getElementById("catSel").value=key;
    buildCategories();
    renderReports();
  };
  return el;
}
function syncChipFromSel(){
  ACTIVE_CAT=document.getElementById("catSel").value;
  buildCategories();
}
function renderReports(){
  const q=(document.getElementById("qSearch").value||"").trim().toLowerCase();
  const sort=document.getElementById("sortSel").value;
  let list=accessibleReports();

  if(ACTIVE_CAT!=="ALL") list=list.filter(r=>r.catKey===ACTIVE_CAT);
  if(q) list=list.filter(r=>(r.name||"").toLowerCase().includes(q) || (r.url||"").toLowerCase().includes(q) || catName(r.catKey).toLowerCase().includes(q));

  if(sort==="name") list.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  else list.sort((a,b)=>(catName(a.catKey)+a.name).localeCompare(catName(b.catKey)+b.name));

  const box=document.getElementById("repList");
  box.innerHTML="";
  if(list.length===0){
    const div=document.createElement("div");
    div.style.color="var(--muted)"; div.style.fontSize="12px";
    div.textContent="Erişilebilir rapor bulunamadı.";
    box.append(div);
    return;
  }

  list.forEach(r=>{
    const div=document.createElement("div");
    div.className="report";
    const left=document.createElement("div");
    left.innerHTML=`<b>${escapeHTML(r.name||"(isimsiz)")}</b>
      <div class="meta">Kategori: ${escapeHTML(catName(r.catKey))}</div>
      <div class="meta" style="font-family:ui-monospace,Menlo,Consolas,monospace">${escapeHTML(r.url||"")}</div>`;
    const right=document.createElement("div");
    right.className="right";
    const a=document.createElement("a");
    a.className="btn small primary";
    a.textContent="Aç";
    a.href=r.url||"#";
    a.target="_blank";
    a.rel="noopener";
    right.append(a);
    div.append(left,right);
    box.append(div);
  });
}
function escapeHTML(s){
  return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =============================
  ADMIN (11 madde)
============================= */
const TABS=[
  {k:"firms", t:"Firmalar"},
  {k:"roles", t:"Roller"},
  {k:"users", t:"Kullanıcılar"},
  {k:"userFirms", t:"Kullanıcı→Firma"},
  {k:"userRoles", t:"Kullanıcı→Rol"},
  {k:"firmAccess", t:"Firma Giriş Rolleri"},
  {k:"categories", t:"Kategoriler"},
  {k:"reports", t:"Raporlar"},
  {k:"reportFirms", t:"Rapor→Firma"},
  {k:"reportAccess", t:"Rapor Yetkileri"},
];

function openAdmin(){
  if(!SESSION || SESSION.mode!=="ADMIN"){ alert("Admin değil"); return; }
  DRAFT = JSON.parse(JSON.stringify(DB));
  DIRTY=false; setDirty(false);
  document.getElementById("adminCard").classList.remove("hidden");
  buildAdminTabs();
  setTab(ACTIVE_TAB);
}
function closeAdmin(){
  document.getElementById("adminCard").classList.add("hidden");
  DRAFT=null; DIRTY=false; setDirty(false);
}
function setDirty(v){
  DIRTY=v;
  document.getElementById("dirtyBadge").style.display = v ? "inline-flex" : "none";
}
function buildAdminTabs(){
  const bar=document.getElementById("adminTabs");
  bar.innerHTML="";
  TABS.forEach(x=>{
    const b=document.createElement("div");
    b.className="chip"+(ACTIVE_TAB===x.k?" active":"");
    b.textContent=x.t;
    b.onclick=()=>setTab(x.k);
    bar.append(b);
  });
}
function setTab(k){
  ACTIVE_TAB=k;
  buildAdminTabs();
  renderAdmin();
}
function saveDraft(){
  if(!DRAFT) return;
  DB = JSON.parse(JSON.stringify(DRAFT));
  saveDB(DB);
  setDirty(false);
  // portal da anında güncellensin
  render();
  alert("Kaydedildi. Portal güncellendi.");
}
function renderAdmin(){
  const body=document.getElementById("adminBody");
  body.innerHTML="";
  if(!DRAFT) return;

  // helpers
  const h = (title, sub="")=>{
    const div=document.createElement("div");
    div.innerHTML=`<div style="font-weight:700">${escapeHTML(title)}</div><div style="font-size:12px;color:var(--muted)">${escapeHTML(sub)}</div>`;
    div.style.marginBottom="10px";
    return div;
  };
  const addRow = (el)=>{ body.append(el); body.append(hr()); };
  const hr = ()=>{ const d=document.createElement("div"); d.className="hr"; return d; };

  if(ACTIVE_TAB==="firms"){
    body.append(h("1) Firma ekle/düzenle/sil","Alias ekleyerek normal login’de firma yazımı serbestleşir."));
    body.append(firmEditor());
    return;
  }
  if(ACTIVE_TAB==="roles"){
    body.append(h("2) Kullanıcı rolü ekle/düzenle/sil","RoleKey benzersiz olmalı."));
    body.append(roleEditor());
    return;
  }
  if(ACTIVE_TAB==="users"){
    body.append(h("3) Kullanıcı ekle/düzenle/sil","Admin ve Super işaretlenebilir."));
    body.append(userEditor());
    return;
  }
  if(ACTIVE_TAB==="userFirms"){
    body.append(h("4) Kullanıcıyı firmaya ekle/düzenle/sil","Normal login için üyelik şart."));
    body.append(userFirmEditor());
    return;
  }
  if(ACTIVE_TAB==="userRoles"){
    body.append(h("5) Kullanıcıya rol ekle/düzenle/sil","Rapor ve firma giriş kuralları için kullanılır."));
    body.append(userRoleEditor());
    return;
  }
  if(ACTIVE_TAB==="firmAccess"){
    body.append(h("6) Kullanıcı rollerine göre firmaya giriş","Bir firmada kural yoksa: üyelik + herhangi rol yeterli."));
    body.append(firmAccessEditor());
    return;
  }
  if(ACTIVE_TAB==="categories"){
    body.append(h("11) Kategoriler","Rapor eklerken kategori zorunlu."));
    body.append(categoryEditor());
    return;
  }
  if(ACTIVE_TAB==="reports"){
    body.append(h("7) Rapor ekle/düzenle/sil","URL + kategori zorunlu."));
    body.append(reportEditor());
    return;
  }
  if(ACTIVE_TAB==="reportFirms"){
    body.append(h("7) Raporu firmaya ata","Firma havuzu: report→firma."));
    body.append(reportFirmEditor());
    return;
  }
  if(ACTIVE_TAB==="reportAccess"){
    body.append(h("8) Rapor erişimi (kullanıcı + yetki)","Kural yoksa: firmadaki herkes görür."));
    body.append(reportAccessEditor());
    return;
  }

  body.append(h("Tab bulunamadı"));
}

/* ====== Editors (minimal + stable) ====== */
function firmEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>FirmKey</label><input id="f_key" placeholder="SUDESAN"></div>
      <div><label>Firma Adı</label><input id="f_name" placeholder="Sudesan"></div>
      <div><label>Aliases (virgül)</label><input id="f_alias" placeholder="Sudesan,sudesan,SUDESAN"></div>
    </div>
    <div class="right"><button class="btn success" id="f_add">Ekle</button></div>
    <div class="hr"></div>
    <table>
      <thead><tr><th>FirmKey</th><th>Ad</th><th>Aliases</th><th></th></tr></thead>
      <tbody id="f_tb"></tbody>
    </table>
  `;
  box.querySelector("#f_add").onclick=()=>{
    const key=(box.querySelector("#f_key").value||"").trim().toUpperCase();
    const name=(box.querySelector("#f_name").value||"").trim();
    const aliases=(box.querySelector("#f_alias").value||"").split(",").map(x=>x.trim()).filter(Boolean);
    if(!key||!name){ alert("FirmKey ve Ad zorunlu"); return; }
    if(DRAFT.firms.some(x=>x.firmKey===key)){ alert("FirmKey zaten var"); return; }
    DRAFT.firms.push({firmKey:key,name,aliases});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#f_tb");
  DRAFT.firms.forEach(f=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(f.firmKey)}</td>
      <td><input value="${escapeHTML(f.name)}" data-k="${escapeHTML(f.firmKey)}" data-f="name"></td>
      <td><input value="${escapeHTML((f.aliases||[]).join(", "))}" data-k="${escapeHTML(f.firmKey)}" data-f="aliases"></td>
      <td class="right"><button class="btn small danger" data-del="${escapeHTML(f.firmKey)}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.oninput=(e)=>{
    const el=e.target;
    const k=el.dataset.k, fld=el.dataset.f;
    const f=DRAFT.firms.find(x=>x.firmKey===k);
    if(!f) return;
    if(fld==="name") f.name=el.value;
    if(fld==="aliases") f.aliases=el.value.split(",").map(x=>x.trim()).filter(Boolean);
    setDirty(true);
  };
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    if(!confirm("Firma silinsin mi?")) return;
    DRAFT.firms=DRAFT.firms.filter(x=>x.firmKey!==del);
    // cleanup mappings
    DRAFT.userFirms=DRAFT.userFirms.filter(x=>x.firmKey!==del);
    DRAFT.firmAccessRoles=DRAFT.firmAccessRoles.filter(x=>x.firmKey!==del);
    DRAFT.reportFirms=DRAFT.reportFirms.filter(x=>x.firmKey!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}

function roleEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>RoleKey</label><input id="r_key" placeholder="PLANNER"></div>
      <div><label>Ad</label><input id="r_name" placeholder="Planner"></div>
      <div class="right" style="align-items:end"><button class="btn success" id="r_add">Ekle</button></div>
    </div>
    <div class="hr"></div>
    <table>
      <thead><tr><th>RoleKey</th><th>Ad</th><th></th></tr></thead>
      <tbody id="r_tb"></tbody>
    </table>
  `;
  box.querySelector("#r_add").onclick=()=>{
    const k=(box.querySelector("#r_key").value||"").trim().toUpperCase();
    const n=(box.querySelector("#r_name").value||"").trim();
    if(!k||!n){ alert("RoleKey ve Ad zorunlu"); return; }
    if(DRAFT.roles.some(x=>x.roleKey===k)){ alert("RoleKey zaten var"); return; }
    DRAFT.roles.push({roleKey:k,name:n});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#r_tb");
  DRAFT.roles.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(r.roleKey)}</td>
      <td><input value="${escapeHTML(r.name)}" data-k="${escapeHTML(r.roleKey)}"></td>
      <td class="right"><button class="btn small danger" data-del="${escapeHTML(r.roleKey)}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.oninput=(e)=>{
    const k=e.target.dataset.k;
    const r=DRAFT.roles.find(x=>x.roleKey===k);
    if(!r) return;
    r.name=e.target.value;
    setDirty(true);
  };
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    if(del==="ADMIN"){ alert("ADMIN silinemez"); return; }
    if(!confirm("Rol silinsin mi?")) return;
    DRAFT.roles=DRAFT.roles.filter(x=>x.roleKey!==del);
    DRAFT.userRoles=DRAFT.userRoles.filter(x=>x.roleKey!==del);
    DRAFT.firmAccessRoles=DRAFT.firmAccessRoles.filter(x=>x.roleKey!==del);
    DRAFT.reportAccess.forEach(ra=>{
      ra.allowedRoleKeys=(ra.allowedRoleKeys||[]).filter(x=>x!==del);
    });
    setDirty(true); renderAdmin();
  };
  return box;
}

function userEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>Username</label><input id="u_user"></div>
      <div><label>Password</label><input id="u_pass"></div>
      <div><label>Full Name</label><input id="u_name"></div>
    </div>
    <div class="grid g3">
      <div style="display:flex;gap:10px;align-items:center"><input type="checkbox" id="u_admin"><span style="font-size:12px;color:var(--muted)">Admin</span></div>
      <div style="display:flex;gap:10px;align-items:center"><input type="checkbox" id="u_super"><span style="font-size:12px;color:var(--muted)">Super User</span></div>
      <div class="right"><button class="btn success" id="u_add">Ekle</button></div>
    </div>
    <div class="hr"></div>
    <table>
      <thead><tr><th>Username</th><th>Full Name</th><th>Admin</th><th>Super</th><th>Password</th><th></th></tr></thead>
      <tbody id="u_tb"></tbody>
    </table>
  `;
  box.querySelector("#u_add").onclick=()=>{
    const username=(box.querySelector("#u_user").value||"").trim();
    const password=(box.querySelector("#u_pass").value||"").trim();
    const fullName=(box.querySelector("#u_name").value||"").trim();
    const isAdmin=!!box.querySelector("#u_admin").checked;
    const isSuper=!!box.querySelector("#u_super").checked;
    if(!username||!password){ alert("username/password zorunlu"); return; }
    if(DRAFT.users.some(x=>(x.username||"").toLowerCase()===username.toLowerCase())){ alert("username zaten var"); return; }
    DRAFT.users.push({userId:gid("u"), username, password, fullName, isAdmin, isSuper});
    setDirty(true); renderAdmin();
  };

  const tb=box.querySelector("#u_tb");
  DRAFT.users.forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(u.username)}</td>
      <td><input value="${escapeHTML(u.fullName||"")}" data-id="${escapeHTML(u.userId)}" data-f="fullName"></td>
      <td><input type="checkbox" ${u.isAdmin?"checked":""} data-id="${escapeHTML(u.userId)}" data-f="isAdmin"></td>
      <td><input type="checkbox" ${u.isSuper?"checked":""} data-id="${escapeHTML(u.userId)}" data-f="isSuper"></td>
      <td><input value="${escapeHTML(u.password||"")}" data-id="${escapeHTML(u.userId)}" data-f="password"></td>
      <td class="right"><button class="btn small danger" data-del="${escapeHTML(u.userId)}">Sil</button></td>
    `;
    tb.append(tr);
  });

  tb.oninput=(e)=>{
    const el=e.target;
    const id=el.dataset.id, f=el.dataset.f;
    const u=DRAFT.users.find(x=>x.userId===id);
    if(!u) return;
    if(el.type==="checkbox") u[f]=el.checked;
    else u[f]=el.value;
    setDirty(true);
  };
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    if(!confirm("Kullanıcı silinsin mi?")) return;
    DRAFT.users=DRAFT.users.filter(x=>x.userId!==del);
    DRAFT.userFirms=DRAFT.userFirms.filter(x=>x.userId!==del);
    DRAFT.userRoles=DRAFT.userRoles.filter(x=>x.userId!==del);
    DRAFT.reportAccess.forEach(ra=>{
      ra.allowedUserIds=(ra.allowedUserIds||[]).filter(x=>x!==del);
    });
    setDirty(true); renderAdmin();
  };
  return box;
}

function selFirmsHTML(id){
  return `<select id="${id}">${DRAFT.firms.map(f=>`<option value="${f.firmKey}">${escapeHTML(f.name)} (${f.firmKey})</option>`).join("")}</select>`;
}
function selUsersHTML(id){
  return `<select id="${id}">${DRAFT.users.map(u=>`<option value="${u.userId}">${escapeHTML(u.username)} (${escapeHTML(u.fullName||"")})</option>`).join("")}</select>`;
}
function selRolesHTML(id){
  return `<select id="${id}">${DRAFT.roles.map(r=>`<option value="${r.roleKey}">${escapeHTML(r.name)} (${r.roleKey})</option>`).join("")}</select>`;
}
function selCatsHTML(id){
  return `<select id="${id}">${DRAFT.categories.map(c=>`<option value="${c.catKey}">${escapeHTML(c.name)} (${c.catKey})</option>`).join("")}</select>`;
}
function selReportsHTML(id){
  return `<select id="${id}">${DRAFT.reports.map(r=>`<option value="${r.reportId}">${escapeHTML(r.name)} (${r.reportId})</option>`).join("")}</select>`;
}

function userFirmEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>Kullanıcı</label>${selUsersHTML("uf_user")}</div>
      <div><label>Firma</label>${selFirmsHTML("uf_firm")}</div>
      <div class="right" style="align-items:end"><button class="btn success" id="uf_add">Ekle</button></div>
    </div>
    <div class="hr"></div>
    <table><thead><tr><th>Kullanıcı</th><th>Firma</th><th></th></tr></thead><tbody id="uf_tb"></tbody></table>
  `;
  box.querySelector("#uf_add").onclick=()=>{
    const userId=box.querySelector("#uf_user").value;
    const firmKey=box.querySelector("#uf_firm").value;
    if(DRAFT.userFirms.some(x=>x.userId===userId && x.firmKey===firmKey)){ alert("Zaten var"); return; }
    DRAFT.userFirms.push({id:gid("uf"), userId, firmKey});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#uf_tb");
  DRAFT.userFirms.forEach(m=>{
    const u=DRAFT.users.find(x=>x.userId===m.userId);
    const f=DRAFT.firms.find(x=>x.firmKey===m.firmKey);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(u?.username||m.userId)}</td>
      <td>${escapeHTML(f?.name||m.firmKey)}</td>
      <td class="right"><button class="btn small danger" data-del="${m.id}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    DRAFT.userFirms=DRAFT.userFirms.filter(x=>x.id!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}

function userRoleEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>Kullanıcı</label>${selUsersHTML("ur_user")}</div>
      <div><label>Rol</label>${selRolesHTML("ur_role")}</div>
      <div class="right" style="align-items:end"><button class="btn success" id="ur_add">Ekle</button></div>
    </div>
    <div class="hr"></div>
    <table><thead><tr><th>Kullanıcı</th><th>Rol</th><th></th></tr></thead><tbody id="ur_tb"></tbody></table>
  `;
  box.querySelector("#ur_add").onclick=()=>{
    const userId=box.querySelector("#ur_user").value;
    const roleKey=box.querySelector("#ur_role").value;
    if(DRAFT.userRoles.some(x=>x.userId===userId && x.roleKey===roleKey)){ alert("Zaten var"); return; }
    DRAFT.userRoles.push({id:gid("ur"), userId, roleKey});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#ur_tb");
  DRAFT.userRoles.forEach(m=>{
    const u=DRAFT.users.find(x=>x.userId===m.userId);
    const r=DRAFT.roles.find(x=>x.roleKey===m.roleKey);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(u?.username||m.userId)}</td>
      <td>${escapeHTML(r?.name||m.roleKey)}</td>
      <td class="right"><button class="btn small danger" data-del="${m.id}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    DRAFT.userRoles=DRAFT.userRoles.filter(x=>x.id!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}

function firmAccessEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>Firma</label>${selFirmsHTML("fa_firm")}</div>
      <div><label>İzinli Rol</label>${selRolesHTML("fa_role")}</div>
      <div class="right" style="align-items:end"><button class="btn success" id="fa_add">Ekle</button></div>
    </div>
    <div class="hr"></div>
    <table><thead><tr><th>Firma</th><th>Rol</th><th></th></tr></thead><tbody id="fa_tb"></tbody></table>
  `;
  box.querySelector("#fa_add").onclick=()=>{
    const firmKey=box.querySelector("#fa_firm").value;
    const roleKey=box.querySelector("#fa_role").value;
    if(DRAFT.firmAccessRoles.some(x=>x.firmKey===firmKey && x.roleKey===roleKey)){ alert("Zaten var"); return; }
    DRAFT.firmAccessRoles.push({id:gid("far"), firmKey, roleKey});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#fa_tb");
  DRAFT.firmAccessRoles.forEach(m=>{
    const f=DRAFT.firms.find(x=>x.firmKey===m.firmKey);
    const r=DRAFT.roles.find(x=>x.roleKey===m.roleKey);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(f?.name||m.firmKey)}</td>
      <td>${escapeHTML(r?.name||m.roleKey)}</td>
      <td class="right"><button class="btn small danger" data-del="${m.id}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    DRAFT.firmAccessRoles=DRAFT.firmAccessRoles.filter(x=>x.id!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}

function categoryEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>CatKey</label><input id="c_key" placeholder="SCM"></div>
      <div><label>Ad</label><input id="c_name" placeholder="Tedarik Zinciri"></div>
      <div class="right" style="align-items:end"><button class="btn success" id="c_add">Ekle</button></div>
    </div>
    <div class="hr"></div>
    <table><thead><tr><th>CatKey</th><th>Ad</th><th></th></tr></thead><tbody id="c_tb"></tbody></table>
  `;
  box.querySelector("#c_add").onclick=()=>{
    const catKey=(box.querySelector("#c_key").value||"").trim().toUpperCase();
    const name=(box.querySelector("#c_name").value||"").trim();
    if(!catKey||!name){ alert("CatKey ve ad zorunlu"); return; }
    if(DRAFT.categories.some(x=>x.catKey===catKey)){ alert("CatKey var"); return; }
    DRAFT.categories.push({catKey,name});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#c_tb");
  DRAFT.categories.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(c.catKey)}</td>
      <td><input value="${escapeHTML(c.name)}" data-k="${escapeHTML(c.catKey)}"></td>
      <td class="right"><button class="btn small danger" data-del="${escapeHTML(c.catKey)}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.oninput=(e)=>{
    const k=e.target.dataset.k;
    const c=DRAFT.categories.find(x=>x.catKey===k);
    if(!c) return;
    c.name=e.target.value;
    setDirty(true);
  };
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    if(!confirm("Kategori silinsin mi?")) return;
    DRAFT.categories=DRAFT.categories.filter(x=>x.catKey!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}

function reportEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>Rapor Adı</label><input id="rp_name"></div>
      <div><label>URL</label><input id="rp_url"></div>
      <div><label>Kategori</label>${selCatsHTML("rp_cat")}</div>
    </div>
    <div class="right"><button class="btn success" id="rp_add">Ekle</button></div>
    <div class="hr"></div>
    <table><thead><tr><th>Ad</th><th>URL</th><th>Kategori</th><th></th></tr></thead><tbody id="rp_tb"></tbody></table>
  `;
  box.querySelector("#rp_add").onclick=()=>{
    const name=(box.querySelector("#rp_name").value||"").trim();
    const url=(box.querySelector("#rp_url").value||"").trim();
    const catKey=box.querySelector("#rp_cat").value;
    if(!name||!url||!catKey){ alert("Ad, URL, kategori zorunlu"); return; }
    DRAFT.reports.push({reportId:gid("r"), name,url,catKey});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#rp_tb");
  DRAFT.reports.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input value="${escapeHTML(r.name)}" data-id="${escapeHTML(r.reportId)}" data-f="name"></td>
      <td><input value="${escapeHTML(r.url)}" data-id="${escapeHTML(r.reportId)}" data-f="url"></td>
      <td>${catSelectForReport(r.reportId, r.catKey)}</td>
      <td class="right"><button class="btn small danger" data-del="${escapeHTML(r.reportId)}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.oninput=(e)=>{
    const el=e.target;
    const id=el.dataset.id;
    const f=el.dataset.f;
    if(!id) return;
    const r=DRAFT.reports.find(x=>x.reportId===id);
    if(!r) return;
    if(el.tagName==="SELECT"){ r.catKey=el.value; setDirty(true); return; }
    r[f]=el.value;
    setDirty(true);
  };
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    if(!confirm("Rapor silinsin mi?")) return;
    DRAFT.reports=DRAFT.reports.filter(x=>x.reportId!==del);
    DRAFT.reportFirms=DRAFT.reportFirms.filter(x=>x.reportId!==del);
    DRAFT.reportAccess=DRAFT.reportAccess.filter(x=>x.reportId!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}
function catSelectForReport(reportId, selected){
  return `<select data-id="${escapeHTML(reportId)}">
    ${DRAFT.categories.map(c=>`<option value="${c.catKey}" ${c.catKey===selected?"selected":""}>${escapeHTML(c.name)} (${c.catKey})</option>`).join("")}
  </select>`;
}

function reportFirmEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>Rapor</label>${selReportsHTML("rf_r")}</div>
      <div><label>Firma</label>${selFirmsHTML("rf_f")}</div>
      <div class="right" style="align-items:end"><button class="btn success" id="rf_add">Ekle</button></div>
    </div>
    <div class="hr"></div>
    <table><thead><tr><th>Rapor</th><th>Firma</th><th></th></tr></thead><tbody id="rf_tb"></tbody></table>
  `;
  box.querySelector("#rf_add").onclick=()=>{
    const reportId=box.querySelector("#rf_r").value;
    const firmKey=box.querySelector("#rf_f").value;
    if(DRAFT.reportFirms.some(x=>x.reportId===reportId && x.firmKey===firmKey)){ alert("Zaten var"); return; }
    DRAFT.reportFirms.push({id:gid("rf"), reportId, firmKey});
    setDirty(true); renderAdmin();
  };
  const tb=box.querySelector("#rf_tb");
  DRAFT.reportFirms.forEach(m=>{
    const r=DRAFT.reports.find(x=>x.reportId===m.reportId);
    const f=DRAFT.firms.find(x=>x.firmKey===m.firmKey);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(r?.name||m.reportId)}</td>
      <td>${escapeHTML(f?.name||m.firmKey)}</td>
      <td class="right"><button class="btn small danger" data-del="${m.id}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    DRAFT.reportFirms=DRAFT.reportFirms.filter(x=>x.id!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}

function reportAccessEditor(){
  const box=document.createElement("div");
  box.className="grid";
  box.innerHTML=`
    <div class="grid g3">
      <div><label>Rapor</label>${selReportsHTML("ra_r")}</div>
      <div><label>İzinli Roller (virgül)</label><input id="ra_roles" placeholder="MANAGER,PLANNER"></div>
      <div><label>İzinli Usernames (virgül)</label><input id="ra_users" placeholder="user,super"></div>
    </div>
    <div class="right"><button class="btn success" id="ra_upsert">Ekle/Güncelle</button></div>
    <div style="font-size:12px;color:var(--muted)">Rol veya kullanıcı boşsa sorun değil. İkisi de boşsa: herkes.</div>
    <div class="hr"></div>
    <table><thead><tr><th>Rapor</th><th>Roller</th><th>Kullanıcılar</th><th></th></tr></thead><tbody id="ra_tb"></tbody></table>
  `;
  box.querySelector("#ra_upsert").onclick=()=>{
    const reportId=box.querySelector("#ra_r").value;
    const roleKeys=(box.querySelector("#ra_roles").value||"").split(",").map(x=>x.trim().toUpperCase()).filter(Boolean);
    const usernames=(box.querySelector("#ra_users").value||"").split(",").map(x=>x.trim().toLowerCase()).filter(Boolean);
    const userIds = usernames.map(un=>{
      const u=DRAFT.users.find(x=>(x.username||"").toLowerCase()===un);
      return u ? u.userId : null;
    }).filter(Boolean);

    const existing=DRAFT.reportAccess.find(x=>x.reportId===reportId);
    if(existing){
      existing.allowedRoleKeys=roleKeys;
      existing.allowedUserIds=userIds;
    }else{
      DRAFT.reportAccess.push({id:gid("ra"), reportId, allowedRoleKeys:roleKeys, allowedUserIds:userIds});
    }
    setDirty(true); renderAdmin();
  };

  const tb=box.querySelector("#ra_tb");
  DRAFT.reportAccess.forEach(ra=>{
    const r=DRAFT.reports.find(x=>x.reportId===ra.reportId);
    const roleStr=(ra.allowedRoleKeys||[]).join(", ") || "—";
    const userStr=(ra.allowedUserIds||[]).map(id=>DRAFT.users.find(u=>u.userId===id)?.username || id).join(", ") || "—";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(r?.name||ra.reportId)}</td>
      <td>${escapeHTML(roleStr)}</td>
      <td>${escapeHTML(userStr)}</td>
      <td class="right"><button class="btn small danger" data-del="${ra.id}">Sil</button></td>
    `;
    tb.append(tr);
  });
  tb.onclick=(e)=>{
    const del=e.target.dataset.del;
    if(!del) return;
    DRAFT.reportAccess=DRAFT.reportAccess.filter(x=>x.id!==del);
    setDirty(true); renderAdmin();
  };
  return box;
}

/* =============================
  KPI
============================= */
function updateKPIs(){
  const f=DB.firms.length, r=DB.roles.length, u=DB.users.length;
  const s=DB.users.filter(x=>x.isSuper).length;
  const p=DB.reports.length;
  document.getElementById("kF").textContent="Firms: "+f;
  document.getElementById("kR").textContent="Roles: "+r;
  document.getElementById("kU").textContent="Users: "+u;
  document.getElementById("kS").textContent="Super: "+s;
  document.getElementById("kP").textContent="Reports: "+p;
}

/* =============================
  BOOT
============================= */
(function boot(){
  loadTheme();
  loadDB();
  document.getElementById("dbPill").textContent="DB: LocalStorage ✓";
  updateKPIs();
  setMode("NORMAL");
  log("✅ Portal boot OK ("+new Date().toLocaleString()+")");
})();
</script>
</body>
</html>
