<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSD Portal</title>
  <style>
    :root{
      --bg:#0b1020; --card:#0f1730; --muted:#9aa7c7; --txt:#e9efff;
      --line:rgba(255,255,255,.10); --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --accent:#3b82f6;
      --accent2:#22c55e;
      --accentSoft: rgba(59,130,246,.14);
      --accentLine: rgba(147,197,253,.55);
      --good:#42d392; --bad:#ff5a6b; --warn:#ffcc00;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--sans);color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 30%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 700px at 40% 110%, rgba(245,158,11,.18), transparent 55%),
        var(--bg);
    }
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1300px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:var(--shadow)
    }
    .title{display:flex;flex-direction:column;line-height:1.1}
    .title b{font-size:16px}
    .title span{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .card{
      background:rgba(15,23,48,.82);
      backdrop-filter: blur(6px);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow)
    }
    .card .hd{padding:14px 14px 0 14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .card .hd h2{margin:0;font-size:15px}
    .card .hd p{margin:6px 0 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:14px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2, minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3, minmax(0,1fr))}
    @media(max-width:980px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .input, select, textarea{
      width:100%; padding:10px 11px; border-radius:12px; border:1px solid var(--line);
      background:rgba(8,12,25,.78); color:var(--txt); outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .input:focus, select:focus, textarea:focus{border-color:var(--accentLine); box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center; gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:transparent; color:var(--txt); cursor:pointer; user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accentSoft); border-color:rgba(59,130,246,.45)}
    .btn.success{background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.45)}
    .btn.warn{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.45)}
    .btn.danger{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.45)}
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .hidden{display:none !important}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      cursor:pointer;font-size:12px;color:var(--muted);display:inline-flex;gap:8px;align-items:center
    }
    .tab.active{color:var(--txt); border-color:var(--accentLine); background:var(--accentSoft)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;color:var(--muted)}
    .badge.good{border-color:rgba(34,197,94,.5); color:#bdf7d6}
    .badge.bad{border-color:rgba(239,68,68,.5); color:#ffd0d6}
    .badge.warn{border-color:rgba(245,158,11,.55); color:#ffe7b3}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(10,14,28,.92); border:1px solid var(--line); border-radius:16px;
      padding:10px 12px; box-shadow:var(--shadow);
      display:flex; align-items:center; gap:10px;
      max-width:min(900px, calc(100% - 24px));
      z-index:50;
    }
    .toast .msg{font-size:13px}
    .toast .x{margin-left:auto}
    .loginModes{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:980px){ .loginModes{grid-template-columns:1fr} }
    .modeCard{
      padding:12px;border:1px solid var(--line);border-radius:16px;
      background:linear-gradient(180deg, rgba(8,12,25,.62), rgba(8,12,25,.42));
      cursor:pointer; user-select:none;
    }
    .modeCard.active{
      border-color:var(--accentLine);
      background:linear-gradient(180deg, rgba(59,130,246,.18), rgba(8,12,25,.42));
    }
    .modeCard b{display:block}
    .modeCard span{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:9px 8px;text-align:left;font-size:12px;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .right-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}
    .mini{font-size:11px;color:var(--muted)}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      cursor:pointer;font-size:12px;color:var(--muted);
      background:rgba(8,12,25,.42);
    }
    .chip.active{color:var(--txt); border-color:var(--accentLine); background:var(--accentSoft)}
    .reportCard{
      border:1px solid var(--line); border-radius:16px; padding:12px;
      background:linear-gradient(180deg, rgba(8,12,25,.62), rgba(8,12,25,.38));
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .reportCard b{display:block}
    .reportCard .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .themePick{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .swatch{
      width:22px;height:22px;border-radius:8px;border:1px solid var(--line);cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>PSD Portal</b>
        <span>Normal · Super User · Admin | Firma + Rol bazlı rapor yetkisi</span>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
      <div class="themePick">
        <span class="pill">Tema</span>
        <div class="swatch" style="background:#3b82f6" onclick="setTheme('#3b82f6')"></div>
        <div class="swatch" style="background:#22c55e" onclick="setTheme('#22c55e')"></div>
        <div class="swatch" style="background:#f59e0b" onclick="setTheme('#f59e0b')"></div>
        <div class="swatch" style="background:#a855f7" onclick="setTheme('#a855f7')"></div>
        <div class="swatch" style="background:#ef4444" onclick="setTheme('#ef4444')"></div>
      </div>

      <span id="statusPill" class="pill">DB: kontrol ediliyor…</span>
      <button class="btn small" id="btnLogout" onclick="logout()" style="display:none;">Çıkış</button>
    </div>
  </div>

  <!-- CONFIG -->
  <div class="card" id="cardConfig">
    <div class="hd">
      <div>
        <h2>Kurulum (Opsiyonel)</h2>
        <p>Apps Script Web App URL girersen DB orada tutulur. Girmezsen LocalStorage kullanılır.</p>
      </div>
      <div class="status">
        <div id="apiDot" class="dot warn"></div>
        <span id="apiText">API yok (LocalStorage)</span>
      </div>
    </div>
    <div class="bd grid grid-2">
      <div>
        <label>API URL (Apps Script Web App)</label>
        <input class="input mono" id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" />
        <div class="hint" style="margin-top:8px">
          Not: API yoksa veri tarayıcıda saklanır → farklı cihaz/profil/origin’de “silinmiş” gibi görünebilir.
        </div>
      </div>
      <div class="right-actions" style="align-items:end">
        <button class="btn primary" onclick="saveConfig()">Kaydet</button>
        <button class="btn warn" onclick="testApi()">API Test</button>
        <button class="btn" onclick="resetLocal()">Local DB sıfırla (Dikkat)</button>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="row" id="rowLogin" style="margin-top:14px">
    <div class="card" style="flex:1.2;min-width:340px">
      <div class="hd">
        <div>
          <h2>Giriş</h2>
          <p>Normal / Super User / Admin</p>
        </div>
        <span class="badge" id="modeBadge">NORMAL</span>
      </div>

      <div class="bd grid" style="gap:12px">
        <div class="loginModes">
          <div class="modeCard active" id="mode_NORMAL" onclick="setLoginMode('NORMAL')">
            <b>Normal Kullanıcı</b>
            <span>Firma zorunlu · Firma + rol bazlı rapor</span>
          </div>
          <div class="modeCard" id="mode_SUPER" onclick="setLoginMode('SUPER')">
            <b>Super User</b>
            <span>Firma bağımsız · Tüm raporlar</span>
          </div>
          <div class="modeCard" id="mode_ADMIN" onclick="setLoginMode('ADMIN')">
            <b>Admin</b>
            <span>Firma/Rol/Kullanıcı/Rapor yönetimi</span>
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label>Kullanıcı Adı</label>
            <input class="input" id="inUser" autocomplete="username" />
          </div>
          <div>
            <label>Şifre</label>
            <input class="input" id="inPass" type="password" autocomplete="current-password" />
          </div>
        </div>

        <div id="firmNormalWrap">
          <label>Firma (Normal Kullanıcı için)</label>
          <input class="input" id="inFirm" placeholder="Örn: Sudesan / Elida / ..." />
          <div class="mini" style="margin-top:6px">
            Firma adı “alias” üzerinden firmKey’e eşleşir.
          </div>
        </div>

        <div class="right-actions">
          <button class="btn primary" onclick="login()">Giriş Yap</button>
          <button class="btn" onclick="fillDemo()">Demo doldur</button>
        </div>

        <div class="hint">
          <b>Kural:</b> Normal girişte kullanıcı firmaya bağlı olmalı ve firmaya giriş için tanımlı rollerden en az birine sahip olmalı.
          (Admin → <span class="mono">FirmAccessRoles</span>)
        </div>
      </div>
    </div>

    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>DB Özeti</h2>
          <p>Admin panelden yönetilir</p>
        </div>
      </div>
      <div class="bd">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="badge" id="kpiFirms">Firms: —</div>
          <div class="badge" id="kpiRoles">Roles: —</div>
          <div class="badge" id="kpiUsers">Users: —</div>
          <div class="badge" id="kpiSuper">Super: —</div>
          <div class="badge" id="kpiReports">Reports: —</div>
        </div>
        <div class="hr"></div>
        <div class="hint">
          “Silinmiş” hissi genelde LocalStorage/origin farkından olur.
          API’ye bağlanırsan veri kaybolmaz.
        </div>
      </div>
    </div>
  </div>

  <!-- PORTAL -->
  <div class="row hidden" id="rowMain" style="margin-top:14px">
    <div class="card" style="flex:2.2;min-width:340px">
      <div class="hd">
        <div>
          <h2 id="mainTitle">Portal</h2>
          <p id="mainSub" class="muted">—</p>
        </div>
        <div class="right-actions">
          <button class="btn small" onclick="refreshDB()">Yenile</button>
          <button class="btn small warn hidden" id="btnAdminOpen" onclick="openAdmin()">Admin Paneli</button>
        </div>
      </div>
      <div class="bd grid" style="gap:10px">
        <!-- Category buttons for normal users -->
        <div>
          <div class="muted" style="font-size:12px;margin-bottom:6px">Kategoriler</div>
          <div class="chipRow" id="catChips"></div>
        </div>

        <div class="grid grid-3">
          <div>
            <label>Arama</label>
            <input class="input" id="qSearch" placeholder="Örn: KPI, WMS, S&OP..." oninput="renderReports()" />
          </div>
          <div>
            <label>Kategori (Filtre)</label>
            <select class="input" id="catSel" onchange="renderReports()">
              <option value="ALL">Tümü</option>
            </select>
          </div>
          <div>
            <label>Sıralama</label>
            <select class="input" id="sortSel" onchange="renderReports()">
              <option value="cat_name">Kategori + İsim</option>
              <option value="name">İsim</option>
            </select>
          </div>
        </div>

        <div id="reportsList" class="grid" style="gap:10px"></div>
      </div>
    </div>

    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Oturum</h2>
          <p>Kimlik ve erişim</p>
        </div>
        <span class="badge" id="sessBadge">—</span>
      </div>
      <div class="bd grid" style="gap:10px">
        <div>
          <div class="muted" style="font-size:12px">Kullanıcı</div>
          <div id="sessUser" style="font-weight:700">—</div>
        </div>
        <div class="grid grid-2">
          <div>
            <div class="muted" style="font-size:12px">Mod</div>
            <div id="sessMode">—</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Firma</div>
            <div id="sessFirm">—</div>
          </div>
        </div>
        <div>
          <div class="muted" style="font-size:12px">Roller</div>
          <div id="sessRoles" class="mono" style="font-size:12px">—</div>
        </div>
        <div class="hr"></div>
        <div class="hint">
          Normal kullanıcı yalnızca <b>firmasına</b> ve <b>rolüne</b> atanmış raporları görür.
          Super User tüm raporlara erişir.
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="card hidden" id="adminPanel" style="margin-top:14px">
    <div class="hd">
      <div>
        <h2>Admin Paneli</h2>
        <p>Değişiklikler “Kaydet” basılınca aktif olur.</p>
      </div>
      <div class="right-actions">
        <span class="badge warn hidden" id="unsavedBadge">Kaydedilmemiş değişiklik</span>
        <button class="btn success" onclick="saveAll()">Kaydet</button>
        <button class="btn" onclick="closeAdmin()">Kapat</button>
      </div>
    </div>

    <div class="bd">
      <div class="tabs" id="adminTabs"></div>

      <!-- TAB CONTENTS -->
      <div id="tabContent"></div>
    </div>
  </div>
</div>

<script>
/* =========================
   STORAGE + API
========================= */
const LS_CONFIG_KEY = "psd_portal_config_v1";
const LS_DB_KEY = "psd_portal_db_v2";
const LS_THEME_KEY = "psd_portal_theme";

let CONFIG = { apiUrl: "" };

let DB = null;       // active db
let DRAFT = null;    // admin edit copy
let SESSION = null;  // current session

let LOGIN_MODE = "NORMAL";
let ACTIVE_CAT_CHIP = "ALL";

/** Small helpers */
const nowISO = () => new Date().toISOString();
const uid = (p="id") => p + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
const deepClone = (o) => JSON.parse(JSON.stringify(o));
const byId = (id) => document.getElementById(id);

function toast(msg, type="info"){
  const t = document.createElement("div");
  t.className = "toast";
  const dot = document.createElement("div");
  dot.className = "dot " + (type==="good"?"good":type==="bad"?"bad":"warn");
  const m = document.createElement("div");
  m.className = "msg";
  m.textContent = msg;
  const x = document.createElement("button");
  x.className = "btn small x";
  x.textContent = "Kapat";
  x.onclick = ()=>t.remove();
  t.append(dot,m,x);
  document.body.appendChild(t);
  setTimeout(()=>{ try{ t.remove(); }catch(e){} }, 5000);
}

function setApiStatus(ok, text){
  byId("apiDot").className = "dot " + (ok ? "good" : "warn");
  byId("apiText").textContent = text;
  byId("statusPill").textContent = ok ? "DB: API bağlı" : "DB: LocalStorage";
}

function saveConfig(){
  CONFIG.apiUrl = (byId("apiUrl").value || "").trim();
  localStorage.setItem(LS_CONFIG_KEY, JSON.stringify(CONFIG));
  toast("Kurulum kaydedildi.", "good");
  testApi();
}

function loadConfig(){
  try{
    const c = JSON.parse(localStorage.getItem(LS_CONFIG_KEY) || "null");
    if(c && typeof c === "object") CONFIG = { ...CONFIG, ...c };
  }catch(e){}
  byId("apiUrl").value = CONFIG.apiUrl || "";
}

function resetLocal(){
  if(!confirm("Local DB sıfırlansın mı? (Geri alınamaz)")) return;
  localStorage.removeItem(LS_DB_KEY);
  toast("Local DB sıfırlandı. Yeniden seed yüklenecek.", "warn");
  init();
}

async function apiCall(action, payload){
  const base = (CONFIG.apiUrl || "").trim();
  if(!base) throw new Error("API URL yok");
  const url = base + (base.includes("?") ? "&" : "?") + "action=" + encodeURIComponent(action);
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload || {})
  });
  if(!res.ok) throw new Error("API HTTP " + res.status);
  const data = await res.json();
  if(data && data.ok === false) throw new Error(data.error || "API error");
  return data;
}

async function testApi(){
  if(!(CONFIG.apiUrl||"").trim()){
    setApiStatus(false, "API yok (LocalStorage)");
    return;
  }
  try{
    const r = await apiCall("ping", { t: Date.now() });
    setApiStatus(true, "API OK");
    toast("API bağlantısı başarılı.", "good");
  }catch(e){
    setApiStatus(false, "API hata (LocalStorage)");
    toast("API test başarısız: " + e.message, "bad");
  }
}

/* =========================
   DB MODEL
========================= */
function seedDB(){
  // Demo seed (istersen admin’den silip kendi datanı girersin)
  const firms = [
    { firmKey:"SUDESAN", name:"Sudesan", aliases:["Sudesan","SUDESAN"] },
    { firmKey:"ELIDA", name:"Elida", aliases:["Elida","ELIDA"] }
  ];

  const roles = [
    { roleKey:"VIEWER", name:"Viewer" },
    { roleKey:"PLANNER", name:"Planner" },
    { roleKey:"MANAGER", name:"Manager" },
    { roleKey:"ADMIN", name:"Admin" }
  ];

  const users = [
    { userId:"u_admin", username:"admin", password:"admin123", fullName:"Portal Admin", isSuper:false, isAdmin:true },
    { userId:"u_super", username:"super", password:"super123", fullName:"Super User", isSuper:true, isAdmin:false },
    { userId:"u_alper", username:"alper", password:"1234", fullName:"Alper", isSuper:false, isAdmin:false }
  ];

  // user-firm membership
  const userFirms = [
    { id:uid("uf"), userId:"u_alper", firmKey:"SUDESAN" },
    { id:uid("uf"), userId:"u_alper", firmKey:"ELIDA" }
  ];

  // user-roles
  const userRoles = [
    { id:uid("ur"), userId:"u_alper", roleKey:"MANAGER" },
    { id:uid("ur"), userId:"u_admin", roleKey:"ADMIN" }
  ];

  // Firm access rules: which roles can login to that firm (NORMAL mode)
  // if a firmKey has no rule rows -> any role accepted (still must be member of firm)
  const firmAccessRoles = [
    { id:uid("far"), firmKey:"SUDESAN", roleKey:"MANAGER" },
    { id:uid("far"), firmKey:"SUDESAN", roleKey:"PLANNER" },
    { id:uid("far"), firmKey:"ELIDA", roleKey:"MANAGER" }
  ];

  const categories = [
    { catKey:"OPERATIONS", name:"Operasyon" },
    { catKey:"FINANCE", name:"Finans" },
    { catKey:"SCM", name:"Tedarik Zinciri" }
  ];

  // Reports: firm assign is via reportFirms rows
  const reports = [
    { reportId:"r_ops1", name:"Operasyon KPI Dashboard", url:"https://lookerstudio.google.com/", catKey:"OPERATIONS" },
    { reportId:"r_fin1", name:"Tahsilat & Nakit Akışı", url:"https://lookerstudio.google.com/", catKey:"FINANCE" },
    { reportId:"r_scm1", name:"Stok & Servis Seviyesi", url:"https://lookerstudio.google.com/", catKey:"SCM" }
  ];

  const reportFirms = [
    { id:uid("rf"), reportId:"r_ops1", firmKey:"SUDESAN" },
    { id:uid("rf"), reportId:"r_fin1", firmKey:"ELIDA" },
    { id:uid("rf"), reportId:"r_scm1", firmKey:"SUDESAN" }
  ];

  // Report access control: per report, allow roles/users.
  // If no row exists for a report -> firm members can see it.
  const reportAccess = [
    { id:uid("ra"), reportId:"r_ops1", allowedRoleKeys:["MANAGER","PLANNER"], allowedUserIds:[] },
    { id:uid("ra"), reportId:"r_fin1", allowedRoleKeys:["MANAGER"], allowedUserIds:[] }
  ];

  return {
    meta:{ version:2, updatedAt: nowISO() },
    firms, roles, users, userFirms, userRoles, firmAccessRoles,
    categories, reports, reportFirms, reportAccess
  };
}

function loadLocalDB(){
  try{
    const d = JSON.parse(localStorage.getItem(LS_DB_KEY) || "null");
    if(d && d.meta && d.meta.version) return d;
  }catch(e){}
  const seeded = seedDB();
  localStorage.setItem(LS_DB_KEY, JSON.stringify(seeded));
  return seeded;
}

function saveLocalDB(db){
  db.meta = db.meta || {};
  db.meta.version = 2;
  db.meta.updatedAt = nowISO();
  localStorage.setItem(LS_DB_KEY, JSON.stringify(db));
}

/* =========================
   INIT / REFRESH
========================= */
async function loadDB(){
  // if api url exists -> use API, else local
  if((CONFIG.apiUrl||"").trim()){
    try{
      const r = await apiCall("getDB", {});
      if(r && r.db){
        DB = r.db;
        setApiStatus(true, "API OK");
        return;
      }
      throw new Error("API: db yok");
    }catch(e){
      // fallback local
      DB = loadLocalDB();
      setApiStatus(false, "API hata (LocalStorage)");
      toast("API’den DB alınamadı, LocalStorage kullanıldı. ("+e.message+")", "warn");
      return;
    }
  }else{
    DB = loadLocalDB();
    setApiStatus(false, "API yok (LocalStorage)");
  }
}

async function saveDB(db){
  if((CONFIG.apiUrl||"").trim()){
    const r = await apiCall("saveDB", { db });
    if(r && r.ok){
      DB = db;
      return;
    }
    throw new Error("API save error");
  }else{
    saveLocalDB(db);
    DB = db;
  }
}

function updateKPIs(){
  const f = DB?.firms?.length || 0;
  const r = DB?.roles?.length || 0;
  const u = DB?.users?.length || 0;
  const su = (DB?.users||[]).filter(x=>x.isSuper).length;
  const rep = DB?.reports?.length || 0;
  byId("kpiFirms").textContent = "Firms: " + f;
  byId("kpiRoles").textContent = "Roles: " + r;
  byId("kpiUsers").textContent = "Users: " + u;
  byId("kpiSuper").textContent = "Super: " + su;
  byId("kpiReports").textContent = "Reports: " + rep;
  byId("statusPill").textContent = (CONFIG.apiUrl||"").trim() ? "DB: API" : "DB: LocalStorage";
}

async function refreshDB(){
  await loadDB();
  updateKPIs();
  if(SESSION) renderPortal();
}

/* =========================
   THEME
========================= */
function setTheme(accent){
  document.documentElement.style.setProperty("--accent", accent);
  // accent line + soft computed:
  // keep soft same (we can leave), but adjust line shade a bit:
  localStorage.setItem(LS_THEME_KEY, accent);
}
function loadTheme(){
  const t = localStorage.getItem(LS_THEME_KEY);
  if(t) setTheme(t);
}

/* =========================
   LOGIN
========================= */
function setLoginMode(m){
  LOGIN_MODE = m;
  ["NORMAL","SUPER","ADMIN"].forEach(x=>{
    const el = byId("mode_"+x);
    if(el) el.classList.toggle("active", x===m);
  });
  byId("modeBadge").textContent = m;
  byId("firmNormalWrap").classList.toggle("hidden", m!=="NORMAL");
}

function fillDemo(){
  if(LOGIN_MODE==="ADMIN"){
    byId("inUser").value="admin"; byId("inPass").value="admin123"; byId("inFirm").value="";
  }else if(LOGIN_MODE==="SUPER"){
    byId("inUser").value="super"; byId("inPass").value="super123"; byId("inFirm").value="";
  }else{
    byId("inUser").value="alper"; byId("inPass").value="1234"; byId("inFirm").value="Sudesan";
  }
}

function firmKeyFromInput(firmName){
  const s = (firmName||"").trim().toLowerCase();
  if(!s) return null;
  // match firmKey or alias
  for(const f of (DB.firms||[])){
    if((f.firmKey||"").toLowerCase()===s) return f.firmKey;
    for(const a of (f.aliases||[])){
      if((a||"").toLowerCase()===s) return f.firmKey;
    }
    if((f.name||"").toLowerCase()===s) return f.firmKey;
  }
  return null;
}

function getUserByUsername(username){
  const u = (username||"").trim().toLowerCase();
  return (DB.users||[]).find(x => (x.username||"").toLowerCase()===u) || null;
}

function rolesOfUser(userId){
  const keys = (DB.userRoles||[]).filter(x=>x.userId===userId).map(x=>x.roleKey);
  return Array.from(new Set(keys));
}

function isMemberOfFirm(userId, firmKey){
  return (DB.userFirms||[]).some(x=>x.userId===userId && x.firmKey===firmKey);
}

function isFirmLoginAllowedByRole(firmKey, userRoleKeys){
  const rules = (DB.firmAccessRoles||[]).filter(x=>x.firmKey===firmKey).map(x=>x.roleKey);
  if(rules.length===0) return true; // no rule -> any role ok
  return userRoleKeys.some(r => rules.includes(r));
}

function login(){
  const username = (byId("inUser").value||"").trim();
  const password = (byId("inPass").value||"").trim();
  const firmInput = (byId("inFirm").value||"").trim();

  const u = getUserByUsername(username);
  if(!u || u.password !== password){
    toast("Kullanıcı adı / şifre hatalı.", "bad");
    return;
  }

  const userRoleKeys = rolesOfUser(u.userId);

  if(LOGIN_MODE==="ADMIN"){
    const adminOk = u.isAdmin || userRoleKeys.includes("ADMIN");
    if(!adminOk){
      toast("Bu kullanıcı Admin değil.", "bad");
      return;
    }
    SESSION = { mode:"ADMIN", userId:u.userId, username:u.username, fullName:u.fullName, firmKey:null, roles:userRoleKeys, isSuper:!!u.isSuper, isAdmin:true };
  }

  if(LOGIN_MODE==="SUPER"){
    if(!u.isSuper){
      toast("Bu kullanıcı Super User değil.", "bad");
      return;
    }
    SESSION = { mode:"SUPER", userId:u.userId, username:u.username, fullName:u.fullName, firmKey:null, roles:userRoleKeys, isSuper:true, isAdmin:!!u.isAdmin };
  }

  if(LOGIN_MODE==="NORMAL"){
    const fk = firmKeyFromInput(firmInput);
    if(!fk){
      toast("Firma bulunamadı. (Admin panelden alias ekleyebilirsin)", "bad");
      return;
    }
    if(!isMemberOfFirm(u.userId, fk)){
      toast("Kullanıcı bu firmaya bağlı değil.", "bad");
      return;
    }
    if(!isFirmLoginAllowedByRole(fk, userRoleKeys)){
      toast("Kullanıcının rolleri bu firmaya giriş için uygun değil.", "bad");
      return;
    }
    SESSION = { mode:"NORMAL", userId:u.userId, username:u.username, fullName:u.fullName, firmKey:fk, roles:userRoleKeys, isSuper:!!u.isSuper, isAdmin:!!u.isAdmin };
  }

  // Show UI
  byId("rowLogin").classList.add("hidden");
  byId("rowMain").classList.remove("hidden");
  byId("btnLogout").style.display="inline-flex";
  byId("btnAdminOpen").classList.toggle("hidden", !(SESSION.mode==="ADMIN"));

  renderPortal();
  toast("Giriş başarılı.", "good");
}

function logout(){
  SESSION = null;
  byId("rowMain").classList.add("hidden");
  byId("adminPanel").classList.add("hidden");
  byId("rowLogin").classList.remove("hidden");
  byId("btnLogout").style.display="none";
  toast("Çıkış yapıldı.", "warn");
}

/* =========================
   PORTAL (Normal user requirements)
   1) categories as buttons
   2) theme top-right (done)
   3) firm+role-based access
========================= */
function firmName(firmKey){
  const f = (DB.firms||[]).find(x=>x.firmKey===firmKey);
  return f ? f.name : firmKey;
}
function catName(catKey){
  const c = (DB.categories||[]).find(x=>x.catKey===catKey);
  return c ? c.name : (catKey||"—");
}

function accessibleReports(){
  if(!SESSION) return [];

  // Super: all
  if(SESSION.mode==="SUPER" || SESSION.isSuper) return (DB.reports||[]).slice();

  // Admin logged in: show all (for convenience)
  if(SESSION.mode==="ADMIN") return (DB.reports||[]).slice();

  // Normal:
  const fk = SESSION.firmKey;
  const firmReportIds = new Set((DB.reportFirms||[]).filter(x=>x.firmKey===fk).map(x=>x.reportId));
  let list = (DB.reports||[]).filter(r => firmReportIds.has(r.reportId));

  // Access control per report (role/user)
  const roleSet = new Set(SESSION.roles||[]);
  const userId = SESSION.userId;

  list = list.filter(r=>{
    const ra = (DB.reportAccess||[]).find(x=>x.reportId===r.reportId);
    if(!ra) return true; // no access row => firm members can view
    const allowedUsers = new Set(ra.allowedUserIds||[]);
    const allowedRoles = new Set(ra.allowedRoleKeys||[]);
    if(allowedUsers.has(userId)) return true;
    if(allowedRoles.size===0 && allowedUsers.size===0) return true;
    for(const rk of roleSet){ if(allowedRoles.has(rk)) return true; }
    return false;
  });

  return list;
}

function buildCategoryUI(reports){
  // dropdown
  const catSel = byId("catSel");
  const prev = catSel.value || "ALL";
  catSel.innerHTML = `<option value="ALL">Tümü</option>`;
  const catKeys = Array.from(new Set(reports.map(r=>r.catKey))).sort();
  for(const ck of catKeys){
    const opt = document.createElement("option");
    opt.value = ck;
    opt.textContent = catName(ck);
    catSel.appendChild(opt);
  }
  catSel.value = (prev && (prev==="ALL" || catKeys.includes(prev))) ? prev : "ALL";

  // chips
  const chips = byId("catChips");
  chips.innerHTML = "";
  const addChip = (key, label)=>{
    const c = document.createElement("div");
    c.className = "chip" + (ACTIVE_CAT_CHIP===key ? " active":"");
    c.textContent = label;
    c.onclick = ()=>{
      ACTIVE_CAT_CHIP = key;
      // sync dropdown too
      byId("catSel").value = key==="ALL" ? "ALL" : key;
      renderReports();
      buildCategoryUI(accessibleReports());
    };
    chips.appendChild(c);
  };
  addChip("ALL","Tümü");
  for(const ck of catKeys){
    addChip(ck, catName(ck));
  }
}

function renderPortal(){
  byId("mainTitle").textContent = "Portal";
  const sub = SESSION.mode==="NORMAL"
    ? `Firma: ${firmName(SESSION.firmKey)} · Raporlar firma+rol bazlı`
    : (SESSION.mode==="SUPER" ? "Super User · Firma bağımsız tüm raporlar" : "Admin · Tüm raporlar + yönetim");
  byId("mainSub").textContent = sub;

  byId("sessBadge").textContent = SESSION.mode;
  byId("sessUser").textContent = SESSION.fullName || SESSION.username;
  byId("sessMode").textContent = SESSION.mode;
  byId("sessFirm").textContent = SESSION.firmKey ? firmName(SESSION.firmKey) : "—";
  byId("sessRoles").textContent = (SESSION.roles||[]).join(", ") || "—";

  const reps = accessibleReports();
  buildCategoryUI(reps);
  renderReports();
}

function renderReports(){
  const reps = accessibleReports();

  const q = (byId("qSearch").value||"").trim().toLowerCase();
  const cat = byId("catSel").value || "ALL";
  const sort = byId("sortSel").value || "cat_name";

  let list = reps.slice();

  // cat chip sync
  if(ACTIVE_CAT_CHIP!=="ALL" && cat==="ALL"){
    // if chip active but dropdown reset, keep dropdown in sync
    byId("catSel").value = ACTIVE_CAT_CHIP;
  }

  const activeCat = (byId("catSel").value || "ALL");
  if(activeCat !== "ALL"){
    list = list.filter(r => r.catKey === activeCat);
  }

  if(q){
    list = list.filter(r =>
      (r.name||"").toLowerCase().includes(q) ||
      (r.url||"").toLowerCase().includes(q) ||
      catName(r.catKey).toLowerCase().includes(q)
    );
  }

  if(sort==="name"){
    list.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  }else{
    list.sort((a,b)=> (catName(a.catKey)+a.name).localeCompare(catName(b.catKey)+b.name));
  }

  const box = byId("reportsList");
  box.innerHTML = "";

  if(list.length===0){
    const empty = document.createElement("div");
    empty.className="hint";
    empty.textContent="Bu filtrelerde erişilebilir rapor bulunamadı.";
    box.appendChild(empty);
    return;
  }

  for(const r of list){
    const div = document.createElement("div");
    div.className="reportCard";
    const left = document.createElement("div");
    const b = document.createElement("b");
    b.textContent = r.name || "(isimsiz rapor)";
    const meta = document.createElement("div");
    meta.className="meta";
    meta.textContent = "Kategori: " + catName(r.catKey);
    const url = document.createElement("div");
    url.className="meta mono";
    url.textContent = (r.url||"");
    left.append(b, meta, url);

    const right = document.createElement("div");
    right.className="right-actions";
    const open = document.createElement("a");
    open.className="btn small primary";
    open.textContent="Aç";
    open.href = r.url || "#";
    open.target="_blank";
    open.rel="noopener";
    right.appendChild(open);

    div.append(left,right);
    box.appendChild(div);
  }
}

/* =========================
   ADMIN PANEL
========================= */
const ADMIN_TABS = [
  { key:"firms", label:"Firmalar" },
  { key:"roles", label:"Roller" },
  { key:"users", label:"Kullanıcılar" },
  { key:"userFirms", label:"Kullanıcı-Firma" },
  { key:"userRoles", label:"Kullanıcı-Rol" },
  { key:"firmAccess", label:"Firma Giriş Kuralları" },
  { key:"categories", label:"Kategoriler" },
  { key:"reports", label:"Raporlar" },
  { key:"reportFirms", label:"Rapor-Firma" },
  { key:"reportAccess", label:"Rapor Yetkileri" }
];

let ACTIVE_ADMIN_TAB = "firms";

function openAdmin(){
  if(!SESSION || SESSION.mode!=="ADMIN"){
    toast("Admin yetkisi yok.", "bad");
    return;
  }
  DRAFT = deepClone(DB);
  byId("adminPanel").classList.remove("hidden");
  buildAdminTabs();
  setAdminTab(ACTIVE_ADMIN_TAB);
  byId("unsavedBadge").classList.add("hidden");
}

function closeAdmin(){
  DRAFT = null;
  byId("adminPanel").classList.add("hidden");
}

function markUnsaved(flag){
  byId("unsavedBadge").classList.toggle("hidden", !flag);
}

function buildAdminTabs(){
  const t = byId("adminTabs");
  t.innerHTML="";
  for(const tab of ADMIN_TABS){
    const el = document.createElement("div");
    el.className = "tab" + (tab.key===ACTIVE_ADMIN_TAB ? " active":"");
    el.textContent = tab.label;
    el.onclick = ()=> setAdminTab(tab.key);
    t.appendChild(el);
  }
}

function setAdminTab(key){
  ACTIVE_ADMIN_TAB = key;
  buildAdminTabs();
  renderAdminTab();
}

function renderAdminTab(){
  const c = byId("tabContent");
  c.innerHTML = "";
  if(!DRAFT) return;

  const sectionTitle = (label) => {
    const h = document.createElement("div");
    h.className="hint";
    h.innerHTML = "<b>"+label+"</b>";
    return h;
  };

  /* ---------- Firms ---------- */
  if(ACTIVE_ADMIN_TAB==="firms"){
    c.appendChild(sectionTitle("Firma ekle/düzenle/sil (aliases dahil)"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Firm Key</label><input class="input mono" id="f_firmKey" placeholder="Örn: SUDESAN"></div>
      <div><label>Firma Adı</label><input class="input" id="f_firmName" placeholder="Örn: Sudesan"></div>
      <div>
        <label>Aliases (virgülle)</label>
        <input class="input" id="f_aliases" placeholder="Sudesan,SUDESAN,Su desan">
      </div>
      <div class="right-actions" style="grid-column:1/-1">
        <button class="btn success" id="f_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("f_addBtn").onclick = ()=>{
      const firmKey = (byId("f_firmKey").value||"").trim().toUpperCase();
      const name = (byId("f_firmName").value||"").trim();
      const aliases = (byId("f_aliases").value||"").split(",").map(x=>x.trim()).filter(Boolean);
      if(!firmKey || !name) return toast("FirmKey ve Firma adı zorunlu.", "bad");
      if(DRAFT.firms.some(x=>x.firmKey===firmKey)) return toast("Bu firmKey zaten var.", "bad");
      DRAFT.firms.push({ firmKey, name, aliases });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableFirms());
    return;
  }

  function renderTableFirms(){
    const wrap = document.createElement("div");
    wrap.className="hr";
    const table = document.createElement("table");
    table.innerHTML = `
      <thead><tr>
        <th>FirmKey</th><th>Ad</th><th>Aliases</th><th></th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tb = table.querySelector("tbody");
    for(const f of DRAFT.firms){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${esc(f.firmKey)}</td>
        <td><input class="input" value="${esc(f.name)}" data-k="${esc(f.firmKey)}" data-f="name"></td>
        <td><input class="input" value="${esc((f.aliases||[]).join(", "))}" data-k="${esc(f.firmKey)}" data-f="aliases"></td>
        <td class="right-actions">
          <button class="btn small danger" data-del="${esc(f.firmKey)}">Sil</button>
        </td>
      `;
      tb.appendChild(tr);
    }
    table.oninput = (e)=>{
      const inp = e.target;
      if(!inp?.dataset?.k) return;
      const k = inp.dataset.k;
      const fld = inp.dataset.f;
      const f = DRAFT.firms.find(x=>x.firmKey===k);
      if(!f) return;
      if(fld==="name") f.name = inp.value;
      if(fld==="aliases") f.aliases = (inp.value||"").split(",").map(x=>x.trim()).filter(Boolean);
      markUnsaved(true);
    };
    table.onclick = (e)=>{
      const b = e.target;
      const del = b?.dataset?.del;
      if(!del) return;
      if(!confirm("Silinsin mi? (Firmaya bağlı eşleşmeler de boşa düşer)")) return;
      DRAFT.firms = DRAFT.firms.filter(x=>x.firmKey!==del);
      // cleanup mappings
      DRAFT.userFirms = DRAFT.userFirms.filter(x=>x.firmKey!==del);
      DRAFT.firmAccessRoles = DRAFT.firmAccessRoles.filter(x=>x.firmKey!==del);
      DRAFT.reportFirms = DRAFT.reportFirms.filter(x=>x.firmKey!==del);
      markUnsaved(true);
      renderAdminTab();
    };
    const box = document.createElement("div");
    box.appendChild(document.createElement("div")).className="hr";
    box.appendChild(table);
    return box;
  }

  /* ---------- Roles ---------- */
  if(ACTIVE_ADMIN_TAB==="roles"){
    c.appendChild(sectionTitle("Kullanıcı rolü ekle/düzenle/sil"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Role Key</label><input class="input mono" id="r_roleKey" placeholder="Örn: PLANNER"></div>
      <div><label>Role Adı</label><input class="input" id="r_roleName" placeholder="Örn: Planner"></div>
      <div class="right-actions" style="align-items:end">
        <button class="btn success" id="r_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("r_addBtn").onclick = ()=>{
      const roleKey = (byId("r_roleKey").value||"").trim().toUpperCase();
      const name = (byId("r_roleName").value||"").trim();
      if(!roleKey || !name) return toast("RoleKey ve ad zorunlu.", "bad");
      if(DRAFT.roles.some(x=>x.roleKey===roleKey)) return toast("Bu roleKey zaten var.", "bad");
      DRAFT.roles.push({ roleKey, name });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableRoles());
    return;
  }

  function renderTableRoles(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>RoleKey</th><th>Ad</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const r of DRAFT.roles){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${esc(r.roleKey)}</td>
        <td><input class="input" value="${esc(r.name)}" data-k="${esc(r.roleKey)}"></td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(r.roleKey)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.oninput = (e)=>{
      const inp = e.target;
      const k = inp?.dataset?.k;
      if(!k) return;
      const r = DRAFT.roles.find(x=>x.roleKey===k);
      if(!r) return;
      r.name = inp.value;
      markUnsaved(true);
    };
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      if(del==="ADMIN") return toast("ADMIN rolü silinemez.", "bad");
      if(!confirm("Silinsin mi? (Kullanıcı-Rol ve kurallar da temizlenir)")) return;
      DRAFT.roles = DRAFT.roles.filter(x=>x.roleKey!==del);
      DRAFT.userRoles = DRAFT.userRoles.filter(x=>x.roleKey!==del);
      DRAFT.firmAccessRoles = DRAFT.firmAccessRoles.filter(x=>x.roleKey!==del);
      // reportAccess arrays
      for(const ra of DRAFT.reportAccess){
        ra.allowedRoleKeys = (ra.allowedRoleKeys||[]).filter(x=>x!==del);
      }
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- Users ---------- */
  if(ACTIVE_ADMIN_TAB==="users"){
    c.appendChild(sectionTitle("Kullanıcı ekle/düzenle/sil + Super User tanımı"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Username</label><input class="input" id="u_username" placeholder="Örn: zeynep"></div>
      <div><label>Password</label><input class="input" id="u_password" placeholder="••••"></div>
      <div><label>Full Name</label><input class="input" id="u_fullname" placeholder="Örn: Zeynep"></div>
      <div style="display:flex;gap:10px;align-items:center">
        <label style="margin:0">Super User</label>
        <input type="checkbox" id="u_isSuper">
        <span class="mini">Firma bağımsız tüm raporlar</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <label style="margin:0">Admin</label>
        <input type="checkbox" id="u_isAdmin">
        <span class="mini">Admin panel erişimi</span>
      </div>
      <div class="right-actions" style="align-items:end">
        <button class="btn success" id="u_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("u_addBtn").onclick = ()=>{
      const username = (byId("u_username").value||"").trim();
      const password = (byId("u_password").value||"").trim();
      const fullName = (byId("u_fullname").value||"").trim();
      const isSuper = !!byId("u_isSuper").checked;
      const isAdmin = !!byId("u_isAdmin").checked;
      if(!username || !password) return toast("Username ve password zorunlu.", "bad");
      if(DRAFT.users.some(x=>(x.username||"").toLowerCase()===username.toLowerCase())) return toast("Username zaten var.", "bad");
      DRAFT.users.push({ userId:uid("u"), username, password, fullName, isSuper, isAdmin });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableUsers());
    return;
  }

  function renderTableUsers(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr>
      <th>Username</th><th>FullName</th><th>Super</th><th>Admin</th><th>Password</th><th></th>
    </tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const u of DRAFT.users){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${esc(u.username)}</td>
        <td><input class="input" value="${esc(u.fullName||"")}" data-id="${esc(u.userId)}" data-f="fullName"></td>
        <td><input type="checkbox" ${u.isSuper?"checked":""} data-id="${esc(u.userId)}" data-f="isSuper"></td>
        <td><input type="checkbox" ${u.isAdmin?"checked":""} data-id="${esc(u.userId)}" data-f="isAdmin"></td>
        <td><input class="input mono" value="${esc(u.password||"")}" data-id="${esc(u.userId)}" data-f="password"></td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(u.userId)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.oninput = (e)=>{
      const el = e.target;
      const id = el?.dataset?.id;
      const fld = el?.dataset?.f;
      if(!id || !fld) return;
      const u = DRAFT.users.find(x=>x.userId===id);
      if(!u) return;
      if(el.type==="checkbox") u[fld] = el.checked;
      else u[fld] = el.value;
      markUnsaved(true);
    };
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      if(!confirm("Kullanıcı silinsin mi? (Bağları da temizlenir)")) return;
      DRAFT.users = DRAFT.users.filter(x=>x.userId!==del);
      DRAFT.userFirms = DRAFT.userFirms.filter(x=>x.userId!==del);
      DRAFT.userRoles = DRAFT.userRoles.filter(x=>x.userId!==del);
      for(const ra of DRAFT.reportAccess){
        ra.allowedUserIds = (ra.allowedUserIds||[]).filter(x=>x!==del);
      }
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- User-Firms ---------- */
  if(ACTIVE_ADMIN_TAB==="userFirms"){
    c.appendChild(sectionTitle("Kullanıcıyı firmaya ekle/düzenle/sil"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Kullanıcı</label>${selUser("uf_user")}</div>
      <div><label>Firma</label>${selFirm("uf_firm")}</div>
      <div class="right-actions" style="align-items:end">
        <button class="btn success" id="uf_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("uf_addBtn").onclick = ()=>{
      const userId = byId("uf_user").value;
      const firmKey = byId("uf_firm").value;
      if(!userId || !firmKey) return toast("Kullanıcı ve firma seç.", "bad");
      if(DRAFT.userFirms.some(x=>x.userId===userId && x.firmKey===firmKey)) return toast("Zaten var.", "bad");
      DRAFT.userFirms.push({ id:uid("uf"), userId, firmKey });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableUserFirms());
    return;
  }

  function renderTableUserFirms(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>Kullanıcı</th><th>Firma</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const m of DRAFT.userFirms){
      const u = DRAFT.users.find(x=>x.userId===m.userId);
      const f = DRAFT.firms.find(x=>x.firmKey===m.firmKey);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(u?.username||m.userId)}</td>
        <td>${esc(f?.name||m.firmKey)} <span class="mini mono">(${esc(m.firmKey)})</span></td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(m.id)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      DRAFT.userFirms = DRAFT.userFirms.filter(x=>x.id!==del);
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- User-Roles ---------- */
  if(ACTIVE_ADMIN_TAB==="userRoles"){
    c.appendChild(sectionTitle("Kullanıcıya rol ekle/düzenle/sil"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Kullanıcı</label>${selUser("ur_user")}</div>
      <div><label>Rol</label>${selRole("ur_role")}</div>
      <div class="right-actions" style="align-items:end">
        <button class="btn success" id="ur_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("ur_addBtn").onclick = ()=>{
      const userId = byId("ur_user").value;
      const roleKey = byId("ur_role").value;
      if(!userId || !roleKey) return toast("Kullanıcı ve rol seç.", "bad");
      if(DRAFT.userRoles.some(x=>x.userId===userId && x.roleKey===roleKey)) return toast("Zaten var.", "bad");
      DRAFT.userRoles.push({ id:uid("ur"), userId, roleKey });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableUserRoles());
    return;
  }

  function renderTableUserRoles(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>Kullanıcı</th><th>Rol</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const m of DRAFT.userRoles){
      const u = DRAFT.users.find(x=>x.userId===m.userId);
      const r = DRAFT.roles.find(x=>x.roleKey===m.roleKey);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(u?.username||m.userId)}</td>
        <td>${esc(r?.name||m.roleKey)} <span class="mini mono">(${esc(m.roleKey)})</span></td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(m.id)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      DRAFT.userRoles = DRAFT.userRoles.filter(x=>x.id!==del);
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- Firm Access Roles ---------- */
  if(ACTIVE_ADMIN_TAB==="firmAccess"){
    c.appendChild(sectionTitle("Kullanıcı rollerine göre firmaya giriş kuralı (NORMAL login)"));
    c.appendChild(sectionTitle("Not: Bir firmada hiç kural yoksa, o firmaya bağlı herhangi bir role izin verilir."));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Firma</label>${selFirm("fa_firm")}</div>
      <div><label>İzinli Rol</label>${selRole("fa_role")}</div>
      <div class="right-actions" style="align-items:end">
        <button class="btn success" id="fa_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("fa_addBtn").onclick = ()=>{
      const firmKey = byId("fa_firm").value;
      const roleKey = byId("fa_role").value;
      if(!firmKey || !roleKey) return toast("Firma ve rol seç.", "bad");
      if(DRAFT.firmAccessRoles.some(x=>x.firmKey===firmKey && x.roleKey===roleKey)) return toast("Zaten var.", "bad");
      DRAFT.firmAccessRoles.push({ id:uid("far"), firmKey, roleKey });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableFirmAccess());
    return;
  }

  function renderTableFirmAccess(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>Firma</th><th>İzinli Rol</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const m of DRAFT.firmAccessRoles){
      const f = DRAFT.firms.find(x=>x.firmKey===m.firmKey);
      const r = DRAFT.roles.find(x=>x.roleKey===m.roleKey);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(f?.name||m.firmKey)} <span class="mini mono">(${esc(m.firmKey)})</span></td>
        <td>${esc(r?.name||m.roleKey)} <span class="mini mono">(${esc(m.roleKey)})</span></td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(m.id)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      DRAFT.firmAccessRoles = DRAFT.firmAccessRoles.filter(x=>x.id!==del);
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- Categories ---------- */
  if(ACTIVE_ADMIN_TAB==="categories"){
    c.appendChild(sectionTitle("Rapor kategorileri (Rapor eklerken kategori zorunlu)"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Cat Key</label><input class="input mono" id="c_catKey" placeholder="Örn: SCM"></div>
      <div><label>Ad</label><input class="input" id="c_catName" placeholder="Örn: Tedarik Zinciri"></div>
      <div class="right-actions" style="align-items:end">
        <button class="btn success" id="c_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("c_addBtn").onclick = ()=>{
      const catKey = (byId("c_catKey").value||"").trim().toUpperCase();
      const name = (byId("c_catName").value||"").trim();
      if(!catKey || !name) return toast("CatKey ve ad zorunlu.", "bad");
      if(DRAFT.categories.some(x=>x.catKey===catKey)) return toast("Bu catKey zaten var.", "bad");
      DRAFT.categories.push({ catKey, name });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableCats());
    return;
  }

  function renderTableCats(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>CatKey</th><th>Ad</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const x of DRAFT.categories){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${esc(x.catKey)}</td>
        <td><input class="input" value="${esc(x.name)}" data-k="${esc(x.catKey)}"></td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(x.catKey)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.oninput = (e)=>{
      const inp = e.target;
      const k = inp?.dataset?.k;
      if(!k) return;
      const c = DRAFT.categories.find(x=>x.catKey===k);
      if(!c) return;
      c.name = inp.value;
      markUnsaved(true);
    };
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      if(!confirm("Kategori silinsin mi? (Raporlar boşa düşebilir)")) return;
      DRAFT.categories = DRAFT.categories.filter(x=>x.catKey!==del);
      // reports keep catKey as is; you may edit them
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- Reports ---------- */
  if(ACTIVE_ADMIN_TAB==="reports"){
    c.appendChild(sectionTitle("Rapor ekle/düzenle/sil (URL + Kategori)"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Rapor Adı</label><input class="input" id="rp_name" placeholder="Örn: Stok Raporu"></div>
      <div><label>URL</label><input class="input mono" id="rp_url" placeholder="https://..."></div>
      <div><label>Kategori</label>${selCat("rp_cat")}</div>
      <div class="right-actions" style="grid-column:1/-1">
        <button class="btn success" id="rp_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("rp_addBtn").onclick = ()=>{
      const name = (byId("rp_name").value||"").trim();
      const url = (byId("rp_url").value||"").trim();
      const catKey = byId("rp_cat").value;
      if(!name || !url || !catKey) return toast("Ad, URL ve kategori zorunlu.", "bad");
      DRAFT.reports.push({ reportId:uid("r"), name, url, catKey });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableReports());
    return;
  }

  function renderTableReports(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>Ad</th><th>URL</th><th>Kategori</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const r of DRAFT.reports){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="input" value="${esc(r.name||"")}" data-id="${esc(r.reportId)}" data-f="name"></td>
        <td><input class="input mono" value="${esc(r.url||"")}" data-id="${esc(r.reportId)}" data-f="url"></td>
        <td>${selCat("rp_cat_"+r.reportId, r.catKey, r.reportId)}</td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(r.reportId)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }

    table.oninput = (e)=>{
      const el = e.target;
      const id = el?.dataset?.id || el?.dataset?.rid;
      const fld = el?.dataset?.f;
      if(!id) return;
      const r = DRAFT.reports.find(x=>x.reportId===id);
      if(!r) return;
      if(el.tagName==="SELECT"){
        r.catKey = el.value;
        markUnsaved(true);
        return;
      }
      if(fld) r[fld] = el.value;
      markUnsaved(true);
    };

    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      if(!confirm("Rapor silinsin mi? (Firma/Yetişim bağları da temizlenir)")) return;
      DRAFT.reports = DRAFT.reports.filter(x=>x.reportId!==del);
      DRAFT.reportFirms = DRAFT.reportFirms.filter(x=>x.reportId!==del);
      DRAFT.reportAccess = DRAFT.reportAccess.filter(x=>x.reportId!==del);
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- Report-Firms ---------- */
  if(ACTIVE_ADMIN_TAB==="reportFirms"){
    c.appendChild(sectionTitle("Raporu firmaya ata (firma bazlı rapor havuzu)"));

    const form = document.createElement("div");
    form.className="grid grid-3";
    form.innerHTML = `
      <div><label>Rapor</label>${selReport("rf_report")}</div>
      <div><label>Firma</label>${selFirm("rf_firm")}</div>
      <div class="right-actions" style="align-items:end">
        <button class="btn success" id="rf_addBtn">Ekle</button>
      </div>
    `;
    c.appendChild(form);

    byId("rf_addBtn").onclick = ()=>{
      const reportId = byId("rf_report").value;
      const firmKey = byId("rf_firm").value;
      if(!reportId || !firmKey) return toast("Rapor ve firma seç.", "bad");
      if(DRAFT.reportFirms.some(x=>x.reportId===reportId && x.firmKey===firmKey)) return toast("Zaten var.", "bad");
      DRAFT.reportFirms.push({ id:uid("rf"), reportId, firmKey });
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableReportFirms());
    return;
  }

  function renderTableReportFirms(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>Rapor</th><th>Firma</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const m of DRAFT.reportFirms){
      const r = DRAFT.reports.find(x=>x.reportId===m.reportId);
      const f = DRAFT.firms.find(x=>x.firmKey===m.firmKey);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r?.name||m.reportId)} <span class="mini mono">(${esc(m.reportId)})</span></td>
        <td>${esc(f?.name||m.firmKey)} <span class="mini mono">(${esc(m.firmKey)})</span></td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(m.id)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      DRAFT.reportFirms = DRAFT.reportFirms.filter(x=>x.id!==del);
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  /* ---------- Report Access ---------- */
  if(ACTIVE_ADMIN_TAB==="reportAccess"){
    c.appendChild(sectionTitle("Rapor erişimi: kullanıcı + rol bazında (düzenle/sil)"));
    c.appendChild(sectionTitle("Not: Bir raporda yetki satırı yoksa, firmaya bağlı kullanıcılar görebilir."));

    const form = document.createElement("div");
    form.className="grid";
    form.innerHTML = `
      <div class="grid grid-3">
        <div><label>Rapor</label>${selReport("ra_report")}</div>
        <div><label>İzinli Roller (çoklu)</label>${multiSelectRoles("ra_roles")}</div>
        <div><label>İzinli Kullanıcılar (çoklu)</label>${multiSelectUsers("ra_users")}</div>
      </div>
      <div class="right-actions">
        <button class="btn success" id="ra_addBtn">Ekle / Güncelle</button>
      </div>
      <div class="hint">Rol ya da kullanıcı boş bırakılabilir. İkisi de boş ise “herkes” anlamına gelir.</div>
    `;
    c.appendChild(form);

    byId("ra_addBtn").onclick = ()=>{
      const reportId = byId("ra_report").value;
      if(!reportId) return toast("Rapor seç.", "bad");
      const allowedRoleKeys = getMulti("ra_roles");
      const allowedUserIds = getMulti("ra_users");
      const existing = DRAFT.reportAccess.find(x=>x.reportId===reportId);
      if(existing){
        existing.allowedRoleKeys = allowedRoleKeys;
        existing.allowedUserIds = allowedUserIds;
      }else{
        DRAFT.reportAccess.push({ id:uid("ra"), reportId, allowedRoleKeys, allowedUserIds });
      }
      markUnsaved(true);
      renderAdminTab();
    };

    c.appendChild(renderTableReportAccess());
    return;
  }

  function renderTableReportAccess(){
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>Rapor</th><th>Roller</th><th>Kullanıcılar</th><th></th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    for(const ra of DRAFT.reportAccess){
      const r = DRAFT.reports.find(x=>x.reportId===ra.reportId);
      const roleNames = (ra.allowedRoleKeys||[]).map(k => (DRAFT.roles.find(x=>x.roleKey===k)?.name || k)).join(", ");
      const userNames = (ra.allowedUserIds||[]).map(id => (DRAFT.users.find(x=>x.userId===id)?.username || id)).join(", ");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r?.name||ra.reportId)} <span class="mini mono">(${esc(ra.reportId)})</span></td>
        <td>${esc(roleNames||"—")}</td>
        <td>${esc(userNames||"—")}</td>
        <td class="right-actions"><button class="btn small danger" data-del="${esc(ra.id)}">Sil</button></td>
      `;
      tb.appendChild(tr);
    }
    table.onclick = (e)=>{
      const del = e.target?.dataset?.del;
      if(!del) return;
      DRAFT.reportAccess = DRAFT.reportAccess.filter(x=>x.id!==del);
      markUnsaved(true);
      renderAdminTab();
    };
    return table;
  }

  // fallback
  c.appendChild(sectionTitle("Tab bulunamadı."));
}

/* ---------- Select builders ---------- */
function selFirm(id){
  const opts = DRAFT.firms.map(f=>`<option value="${esc(f.firmKey)}">${esc(f.name)} (${esc(f.firmKey)})</option>`).join("");
  return `<select class="input" id="${esc(id)}">${opts}</select>`;
}
function selRole(id){
  const opts = DRAFT.roles.map(r=>`<option value="${esc(r.roleKey)}">${esc(r.name)} (${esc(r.roleKey)})</option>`).join("");
  return `<select class="input" id="${esc(id)}">${opts}</select>`;
}
function selUser(id){
  const opts = DRAFT.users.map(u=>`<option value="${esc(u.userId)}">${esc(u.username)} (${esc(u.fullName||"")})</option>`).join("");
  return `<select class="input" id="${esc(id)}">${opts}</select>`;
}
function selCat(id, selected=null, rid=null){
  const opts = DRAFT.categories.map(c=>{
    const sel = selected && c.catKey===selected ? "selected":"";
    return `<option value="${esc(c.catKey)}" ${sel}>${esc(c.name)} (${esc(c.catKey)})</option>`;
  }).join("");
  // attach dataset for report cat editing
  const ds = rid ? `data-rid="${esc(rid)}"` : "";
  return `<select class="input" id="${esc(id)}" ${ds}>${opts}</select>`;
}
function selReport(id){
  const opts = DRAFT.reports.map(r=>`<option value="${esc(r.reportId)}">${esc(r.name)} (${esc(r.reportId)})</option>`).join("");
  return `<select class="input" id="${esc(id)}">${opts}</select>`;
}

/* Multi-select (simple checkbox list) */
function multiSelectRoles(id){
  const items = DRAFT.roles.map(r=>`
    <label style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);padding:8px;border-radius:12px;background:rgba(8,12,25,.42)">
      <input type="checkbox" value="${esc(r.roleKey)}" data-ms="${esc(id)}">
      <span>${esc(r.name)} <span class="mini mono">(${esc(r.roleKey)})</span></span>
    </label>
  `).join("");
  return `<div class="grid" style="gap:8px;max-height:180px;overflow:auto;border:1px solid var(--line);padding:8px;border-radius:12px;background:rgba(8,12,25,.25)">${items}</div>`;
}
function multiSelectUsers(id){
  const items = DRAFT.users.map(u=>`
    <label style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);padding:8px;border-radius:12px;background:rgba(8,12,25,.42)">
      <input type="checkbox" value="${esc(u.userId)}" data-ms="${esc(id)}">
      <span>${esc(u.username)} <span class="mini">(${esc(u.fullName||"")})</span></span>
    </label>
  `).join("");
  return `<div class="grid" style="gap:8px;max-height:180px;overflow:auto;border:1px solid var(--line);padding:8px;border-radius:12px;background:rgba(8,12,25,.25)">${items}</div>`;
}
function getMulti(id){
  return Array.from(document.querySelectorAll(`input[data-ms="${CSS.escape(id)}"]:checked`)).map(x=>x.value);
}

/* ---------- Save all ---------- */
async function saveAll(){
  if(!DRAFT) return;
  // small sanity: keep version meta
  DRAFT.meta = DRAFT.meta || {};
  DRAFT.meta.version = 2;
  DRAFT.meta.updatedAt = nowISO();

  try{
    await saveDB(DRAFT);
    toast("Kaydedildi. Portal güncellendi.", "good");
    markUnsaved(false);
    // refresh portal if session exists
    await refreshDB();
    // keep admin open with fresh clone
    DRAFT = deepClone(DB);
    renderAdminTab();
  }catch(e){
    toast("Kaydetme hatası: " + e.message, "bad");
  }
}

/* =========================
   UTILS
========================= */
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   BOOT
========================= */
async function init(){
  loadTheme();
  loadConfig();
  await loadDB();
  updateKPIs();
  await testApi();
  // default mode
  setLoginMode("NORMAL");
}
init();
</script>
</body>
</html>
