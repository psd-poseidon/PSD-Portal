<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSD Portal</title>
  <style>
    :root{
      --bg:#0b1020; --card:#0f1730; --muted:#9aa7c7; --txt:#e9efff;
      --line:rgba(255,255,255,.10); --good:#42d392; --bad:#ff5a6b; --warn:#ffcc00;
      --btn:#3b82f6; --btn2:#22c55e; --btn3:#f59e0b; --btn4:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:radial-gradient(1200px 800px at 20% 10%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 30%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 700px at 40% 110%, rgba(245,158,11,.18), transparent 55%),
        var(--bg); color:var(--txt);}
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#22c55e);box-shadow:var(--shadow)}
    .title{display:flex;flex-direction:column;line-height:1.1}
    .title b{font-size:16px}
    .title span{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .card{background:rgba(15,23,48,.82);backdrop-filter: blur(6px);
      border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card .hd{padding:14px 14px 0 14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .card .hd h2{margin:0;font-size:15px}
    .card .hd p{margin:6px 0 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:14px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2, minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3, minmax(0,1fr))}
    @media(max-width:900px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .input, select, textarea{
      width:100%; padding:10px 11px; border-radius:12px; border:1px solid var(--line);
      background:rgba(8,12,25,.8); color:var(--txt); outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .input:focus, select:focus, textarea:focus{border-color:rgba(147,197,253,.7); box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center; gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(59,130,246,.18); color:var(--txt); cursor:pointer; user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(59,130,246,.25); border-color:rgba(59,130,246,.45)}
    .btn.success{background:rgba(34,197,94,.20); border-color:rgba(34,197,94,.45)}
    .btn.warn{background:rgba(245,158,11,.20); border-color:rgba(245,158,11,.45)}
    .btn.danger{background:rgba(239,68,68,.20); border-color:rgba(239,68,68,.45)}
    .btn.ghost{background:transparent}
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .hidden{display:none !important}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);cursor:pointer;font-size:12px;color:var(--muted)}
    .tab.active{color:var(--txt); border-color:rgba(147,197,253,.55); background:rgba(59,130,246,.12)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:9px 8px;text-align:left;font-size:12px;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{padding:10px 12px;border:1px solid var(--line);border-radius:14px;min-width:160px;background:rgba(8,12,25,.6)}
    .kpi .box b{display:block;font-size:16px}
    .kpi .box span{font-size:12px;color:var(--muted)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;color:var(--muted)}
    .badge.good{border-color:rgba(34,197,94,.5); color:#bdf7d6}
    .badge.bad{border-color:rgba(239,68,68,.5); color:#ffd0d6}
    .badge.warn{border-color:rgba(245,158,11,.55); color:#ffe7b3}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(10,14,28,.92); border:1px solid var(--line); border-radius:14px;
      padding:10px 12px; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px;
      max-width:min(760px, calc(100% - 24px));
    }
    .toast .msg{font-size:13px}
    .toast .x{margin-left:auto}
    .smallnote{font-size:12px;color:var(--muted);line-height:1.45}
    .list{display:grid;gap:10px}
    .report{
      padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(8,12,25,.55);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px
    }
    .report h3{margin:0 0 6px 0;font-size:14px}
    .report p{margin:0;color:var(--muted);font-size:12px}
    .report .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .right-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .footer{margin-top:16px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .keyline{padding:10px 12px;border:1px dashed rgba(147,197,253,.35);border-radius:14px;background:rgba(59,130,246,.08);font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>PSD Portal</b>
        <span>GitHub Pages UI · Google Apps Script API · Google Sheet DB</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
      <span id="statusPill" class="pill">Bağlantı: kontrol ediliyor…</span>
      <button class="btn ghost small" id="btnLogout" onclick="logout()" style="display:none;">Çıkış</button>
    </div>
  </div>

  <!-- CONFIG CARD -->
  <div class="card" id="cardConfig">
    <div class="hd">
      <div>
        <h2>Kurulum</h2>
        <p>Apps Script Web App URL’sini gir ve kaydet. (Tarayıcıda saklanır.)</p>
      </div>
      <div class="status">
        <div id="apiDot" class="dot warn"></div>
        <span id="apiText">API yok</span>
      </div>
    </div>
    <div class="bd grid grid-2">
      <div>
        <label>API URL (Apps Script Web App)</label>
        <input class="input mono" id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" />
        <div class="smallnote" style="margin-top:8px">
          Deploy ayarları: <span class="mono">Execute as: Me</span> · <span class="mono">Who has access: Anyone</span> (en azından test için).
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Portal Tema Rengi</label>
          <select id="themeSel" class="input" onchange="setTheme(this.value)">
            <option value="blue">Mavi</option>
            <option value="green">Yeşil</option>
            <option value="amber">Turuncu</option>
            <option value="red">Kırmızı</option>
          </select>
        </div>
        <div class="right-actions" style="align-items:end">
          <button class="btn primary" onclick="saveConfig()">Kaydet</button>
          <button class="btn warn" onclick="testApi()">API Test (ping)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="row" id="rowLogin" style="margin-top:14px">
    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Giriş</h2>
          <p>Admin · Key User · Normal User</p>
        </div>
        <span class="badge" id="modeBadge">—</span>
      </div>
      <div class="bd grid grid-2">
        <div>
          <label>Kullanıcı Adı</label>
          <input class="input" id="inUser" autocomplete="username" />
        </div>
        <div>
          <label>Şifre</label>
          <input class="input" id="inPass" type="password" autocomplete="current-password" />
        </div>
        <div style="grid-column:1/-1">
          <label>Firma (Normal User için zorunlu · Admin/Key User için boş olabilir)</label>
          <input class="input" id="inFirm" placeholder="Örn: Sudesan / Dupack / ..." />
        </div>
        <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn primary" onclick="login()">Giriş Yap</button>
          <button class="btn ghost" onclick="fillDemo()">Demo doldur</button>
        </div>
        <div class="keyline" style="grid-column:1/-1">
          <b>Not:</b> Kullanıcılar ve firmalar <b>tarayıcıda değil</b>, Google Sheet’te tutulur.
          Burada “silindi” gibi görünen durumlar genelde localStorage / cache / eski seed-data kaynaklıdır.
        </div>
      </div>
    </div>

    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Bilgi</h2>
          <p>Bu tek dosya UI; tüm veri API’den okunur / (Admin) kaydedilir.</p>
        </div>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box"><b id="kpiFirms">—</b><span>Firms</span></div>
          <div class="box"><b id="kpiUsers">—</b><span>Users</span></div>
          <div class="box"><b id="kpiReports">—</b><span>Reports</span></div>
        </div>
        <div class="hr"></div>
        <div class="smallnote">
          <b>Güvenlik notu (pratik):</b> Apps Script tarafında token 12 saat geçerli.
          Admin harici kullanıcılar save yapamaz. Normal user erişimi rol ile kontrol edilir.
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="row hidden" id="rowMain" style="margin-top:14px">
    <!-- LEFT: Portal view -->
    <div class="card" style="flex:2;min-width:320px">
      <div class="hd">
        <div>
          <h2 id="mainTitle">Portal</h2>
          <p id="mainSub" class="muted">—</p>
        </div>
        <div class="right-actions">
          <button class="btn small" onclick="refreshDB()">Yenile</button>
          <button class="btn small warn hidden" id="btnAdminOpen" onclick="openAdmin()">Admin Paneli</button>
        </div>
      </div>
      <div class="bd">
        <div class="tabs" id="catTabs"></div>
        <div id="reportsList" class="list"></div>
      </div>
    </div>

    <!-- RIGHT: Session -->
    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Oturum</h2>
          <p>Kimlik, roller, firma erişimi</p>
        </div>
        <span class="badge" id="sessBadge">—</span>
      </div>
      <div class="bd">
        <div class="grid">
          <div>
            <div class="muted" style="font-size:12px">Kullanıcı</div>
            <div id="sessUser" style="font-weight:700">—</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Mod</div>
            <div id="sessMode">—</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Firma</div>
            <div id="sessFirm">—</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Roller</div>
            <div id="sessRoles" class="mono" style="font-size:12px;word-break:break-word">—</div>
          </div>
          <div class="hr"></div>
          <div class="right-actions">
            <button class="btn danger" onclick="logout()">Çıkış</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="card hidden" id="cardAdmin" style="margin-top:14px">
    <div class="hd">
      <div>
        <h2>Admin Panel</h2>
        <p>DB düzenleme: Firms · Aliases · Roles · Users · KeyUsers · FirmAccessRoles · Reports</p>
      </div>
      <div class="right-actions">
        <button class="btn small" onclick="closeAdmin()">Kapat</button>
        <button class="btn small warn" onclick="exportJSON()">JSON Export</button>
        <button class="btn small success" onclick="saveAdmin()">Kaydet (saveDB)</button>
      </div>
    </div>
    <div class="bd">
      <div class="tabs" id="adminTabs"></div>
      <div id="adminArea"></div>
      <div class="hr"></div>
      <div class="smallnote">
        <b>İpucu:</b> Kullanıcı şifresi için <span class="mono">passHash</span> alanı SHA-256 hex olmalı.
        Apps Script tarafında <span class="mono">UTIL_hashPasswordForSheet()</span> ile sheet’te düz şifreleri hash’leyebilirsin.
      </div>
    </div>
  </div>

  <div class="footer">
    <div>© PSD Portal · Tek dosya UI</div>
    <div class="mono">v1.0</div>
  </div>
</div>

<div id="toast" class="toast hidden">
  <div id="toastDot" class="dot warn"></div>
  <div id="toastMsg" class="msg">—</div>
  <button class="btn small ghost x" onclick="hideToast()">Kapat</button>
</div>

<script>
/** =========================
 *  CONFIG
 *  =========================
 *  API_URL: localStorage('PSD_API_URL') ile tutulur.
 */
let API_URL = "";
const LS = {
  api: "PSD_API_URL",
  theme: "PSD_THEME",
  sess: "PSD_SESSION"
};

let session = null; // { token, mode, user: {..} }
let DB = null;      // { firms, aliases, roles, users, keyUsers, firmAccessRoles, reports }
let activeCat = "ALL";
let adminActiveTab = "Firms";

const DB_KEYS = [
  "firms","aliases","roles","users","keyUsers","firmAccessRoles","reports"
];

function init() {
  // load config
  API_URL = localStorage.getItem(LS.api) || "";
  document.getElementById("apiUrl").value = API_URL;

  const th = localStorage.getItem(LS.theme) || "blue";
  document.getElementById("themeSel").value = th;
  setTheme(th);

  // load session
  const s = localStorage.getItem(LS.sess);
  if (s) {
    try {
      session = JSON.parse(s);
    } catch(_) {}
  }

  // reflect
  updateConnPill("warn","Bağlantı: ayarlanmadı");
  if (API_URL) testApi(true);

  if (session && session.token) {
    // try silent refresh DB and show main
    refreshDB(true).catch(() => {
      // session invalid -> logout
      logout(true);
    });
  }
}
window.addEventListener("DOMContentLoaded", init);

function setTheme(theme) {
  localStorage.setItem(LS.theme, theme);
  const root = document.documentElement.style;
  // adjust button accent subtly
  if (theme === "blue") { root.setProperty("--btn", "#3b82f6"); }
  if (theme === "green"){ root.setProperty("--btn", "#22c55e"); }
  if (theme === "amber"){ root.setProperty("--btn", "#f59e0b"); }
  if (theme === "red"){ root.setProperty("--btn", "#ef4444"); }
}

function saveConfig() {
  API_URL = (document.getElementById("apiUrl").value || "").trim();
  localStorage.setItem(LS.api, API_URL);
  toast("good","Kaydedildi. API Test önerilir.");
  testApi();
}

async function testApi(silent=false) {
  if (!API_URL) {
    setApiStatus(false, "API URL yok");
    updateConnPill("warn","Bağlantı: API URL yok");
    if (!silent) toast("warn","API URL girilmemiş.");
    return;
  }
  try {
    const res = await apiCall({ action:"ping" });
    if (res && res.ok) {
      setApiStatus(true, "API hazır");
      updateConnPill("good","Bağlantı: OK");
      if (!silent) toast("good","API ping başarılı.");
    } else {
      setApiStatus(false, "API cevap hatası");
      updateConnPill("bad","Bağlantı: HATA");
      if (!silent) toast("bad","API ping başarısız: " + (res?.error || "unknown"));
    }
  } catch (e) {
    setApiStatus(false, "API erişilemiyor");
    updateConnPill("bad","Bağlantı: HATA");
    if (!silent) toast("bad","API erişilemiyor: " + e.message);
  }
}

function setApiStatus(ok, text) {
  const dot = document.getElementById("apiDot");
  const t = document.getElementById("apiText");
  dot.className = "dot " + (ok ? "good" : "bad");
  t.textContent = text;
}

function updateConnPill(level, text) {
  const pill = document.getElementById("statusPill");
  pill.textContent = text;
  // just visual via dot style in config card
}

/** =========================
 *  API CALL
 *  ========================= */
async function apiCall(payload) {
  if (!API_URL) throw new Error("API URL yok");
  const resp = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const txt = await resp.text();
  try { return JSON.parse(txt); }
  catch(e){ throw new Error("JSON parse error: " + txt.slice(0,200)); }
}

/** =========================
 *  LOGIN / SESSION
 *  ========================= */
function fillDemo() {
  document.getElementById("inUser").value = "Poseidon";
  document.getElementById("inPass").value = "psd123";
  document.getElementById("inFirm").value = "";
}

async function login() {
  const username = (document.getElementById("inUser").value || "").trim();
  const password = (document.getElementById("inPass").value || "");
  const firmName = (document.getElementById("inFirm").value || "").trim();

  if (!API_URL) return toast("warn","Önce API URL kaydet.");
  if (!username || !password) return toast("warn","Kullanıcı/şifre gir.");

  try {
    const res = await apiCall({ action:"login", username, password, firmName });
    if (!res.ok) return toast("bad", res.error || "Giriş başarısız");

    session = { token: res.token, mode: res.mode, user: res.user };
    localStorage.setItem(LS.sess, JSON.stringify(session));

    document.getElementById("modeBadge").textContent = res.mode;
    toast("good","Giriş başarılı: " + res.mode);

    await refreshDB(false);
    showMain();
  } catch (e) {
    toast("bad","Login hata: " + e.message);
  }
}

function logout(silent=false) {
  session = null;
  DB = null;
  localStorage.removeItem(LS.sess);

  document.getElementById("rowMain").classList.add("hidden");
  document.getElementById("cardAdmin").classList.add("hidden");
  document.getElementById("rowLogin").classList.remove("hidden");
  document.getElementById("btnLogout").style.display = "none";

  document.getElementById("kpiFirms").textContent = "—";
  document.getElementById("kpiUsers").textContent = "—";
  document.getElementById("kpiReports").textContent = "—";

  if (!silent) toast("warn","Çıkış yapıldı.");
}

/** =========================
 *  DB LOAD / RENDER
 *  ========================= */
async function refreshDB(silent=false) {
  if (!session?.token) throw new Error("No session");
  const res = await apiCall({ action:"getDB", token: session.token });

  if (!res.ok) {
    if (!silent) toast("bad", res.error || "getDB error");
    throw new Error(res.error || "Unauthorized");
  }
  DB = res.db;

  // KPIs
  const firmsN = (DB?.firms || []).length;
  const usersN = (DB?.users || []).length + (DB?.keyUsers || []).length;
  const repsN  = (DB?.reports || []).length;

  document.getElementById("kpiFirms").textContent = firmsN;
  document.getElementById("kpiUsers").textContent = usersN;
  document.getElementById("kpiReports").textContent = repsN;

  if (!silent) toast("good","DB yenilendi.");

  // Re-render main if visible
  if (!document.getElementById("rowMain").classList.contains("hidden")) {
    renderMain();
  }
}

function showMain() {
  document.getElementById("rowLogin").classList.add("hidden");
  document.getElementById("rowMain").classList.remove("hidden");
  document.getElementById("btnLogout").style.display = "inline-flex";

  // admin button
  const isAdmin = (session?.mode === "ADMIN");
  document.getElementById("btnAdminOpen").classList.toggle("hidden", !isAdmin);

  renderSessionCard();
  renderMain();
}

function renderSessionCard() {
  const u = session?.user || {};
  document.getElementById("sessBadge").textContent = session?.mode || "—";
  document.getElementById("sessUser").textContent = (u.display || u.username || "—");
  document.getElementById("sessMode").textContent = (session?.mode || "—");

  if (session?.mode === "PORTAL") {
    document.getElementById("sessFirm").textContent = (u.firmDisplay || u.firmKey || "—");
    document.getElementById("sessRoles").textContent = (u.roles || []).join(", ") || "—";
  } else {
    document.getElementById("sessFirm").textContent = "—";
    document.getElementById("sessRoles").textContent = (u.roles || []).join(", ") || "—";
  }
}

function renderMain() {
  const u = session?.user || {};
  const mode = session?.mode;

  if (mode === "ADMIN") {
    document.getElementById("mainTitle").textContent = "Admin Görünümü";
    document.getElementById("mainSub").textContent = "Tüm raporlar listelenir. Düzenleme için Admin Paneli'ni aç.";
  } else if (mode === "KEY") {
    document.getElementById("mainTitle").textContent = "Key User Görünümü";
    document.getElementById("mainSub").textContent = "Firma seçmeden; izinli raporlar listelenir (role/user bazlı).";
  } else {
    document.getElementById("mainTitle").textContent = "Portal";
    document.getElementById("mainSub").textContent = (u.firmDisplay ? ("Firma: " + u.firmDisplay) : "—");
  }

  // category tabs
  const cats = collectCategories();
  renderCategoryTabs(cats);

  // list reports
  renderReports();
}

function collectCategories() {
  const reports = DB?.reports || [];
  const allowed = reports.filter(r => canSeeReport(r));
  const set = new Set(["ALL"]);
  allowed.forEach(r => set.add(String(r.cat || "Genel")));
  return Array.from(set);
}

function renderCategoryTabs(cats) {
  const tabs = document.getElementById("catTabs");
  tabs.innerHTML = "";
  cats.forEach(cat => {
    const el = document.createElement("div");
    el.className = "tab" + (activeCat === cat ? " active" : "");
    el.textContent = cat;
    el.onclick = () => { activeCat = cat; renderCategoryTabs(cats); renderReports(); };
    tabs.appendChild(el);
  });
}

function renderReports() {
  const list = document.getElementById("reportsList");
  list.innerHTML = "";

  const reports = (DB?.reports || []).filter(r => String(r.active).toLowerCase() !== "false");

  const allowed = reports
    .filter(r => canSeeReport(r))
    .filter(r => activeCat === "ALL" ? true : String(r.cat || "Genel") === activeCat);

  if (!allowed.length) {
    const empty = document.createElement("div");
    empty.className = "smallnote";
    empty.textContent = "Görüntülenecek rapor bulunamadı (kategori/rol yetkisi kontrol).";
    list.appendChild(empty);
    return;
  }

  // sort by cat then name
  allowed.sort((a,b) => {
    const ca = String(a.cat||""); const cb = String(b.cat||"");
    if (ca !== cb) return ca.localeCompare(cb, "tr");
    return String(a.name||"").localeCompare(String(b.name||""), "tr");
  });

  allowed.forEach(r => {
    const firmKey = String(r.firmKey || "").trim();
    const firmLabel = firmKey ? firmDisplayByKey(firmKey) : "—";
    const allowRoles = csvToArr(r.allowRolesCsv);
    const allowUsers = csvToArr(r.allowUsersCsv);

    const card = document.createElement("div");
    card.className = "report";

    const left = document.createElement("div");
    left.style.flex = "1";

    const h = document.createElement("h3");
    h.textContent = String(r.name || "Unnamed report");
    left.appendChild(h);

    const p = document.createElement("p");
    p.textContent = String(r.desc || "");
    left.appendChild(p);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.appendChild(badge("Kategori", String(r.cat || "Genel")));
    if (firmKey) meta.appendChild(badge("Firma", firmLabel));
    if (allowRoles.length) meta.appendChild(badge("Roles", allowRoles.join(", ")));
    if (allowUsers.length) meta.appendChild(badge("Users", allowUsers.join(", ")));
    left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "right-actions";

    const btnOpen = document.createElement("button");
    btnOpen.className = "btn small primary";
    btnOpen.textContent = "Aç";
    btnOpen.onclick = () => {
      const url = String(r.url || "").trim();
      if (!url) return toast("warn","URL boş: " + (r.name || ""));
      window.open(url, "_blank", "noopener,noreferrer");
    };

    right.appendChild(btnOpen);

    card.appendChild(left);
    card.appendChild(right);
    list.appendChild(card);
  });
}

function badge(k,v){
  const s = document.createElement("span");
  s.className = "badge";
  s.textContent = `${k}: ${v}`;
  return s;
}

function csvToArr(csv){
  return String(csv||"").split(",").map(x=>x.trim()).filter(Boolean);
}

function firmDisplayByKey(firmKey){
  const firms = DB?.firms || [];
  const f = firms.find(x => String(x.firmKey||"").trim() === firmKey);
  return f ? (String(f.display||"").trim() || firmKey) : firmKey;
}

function canSeeReport(r) {
  const mode = session?.mode;
  const u = session?.user || {};

  // Admin sees all
  if (mode === "ADMIN") return true;

  // Active check
  if (String(r.active).toLowerCase() === "false") return false;

  const firmKey = String(r.firmKey || "").trim();

  // Normal user firm filter: if report has firmKey, must match
  if (mode === "PORTAL") {
    const myFirm = String(u.firmKey || "").trim();
    if (firmKey && myFirm && firmKey !== myFirm) return false;
    if (firmKey && !myFirm) return false;
  }

  // Key user: firmKey if set -> allow all firms (no firm selection) OR you can enforce firmKey? We'll not enforce.
  // Role/user allow lists
  const allowRoles = csvToArr(r.allowRolesCsv);
  const allowUsers = csvToArr(r.allowUsersCsv).map(x=>x.toLowerCase());

  // If both empty => public for that mode/firm
  if (!allowRoles.length && !allowUsers.length) return true;

  const uname = String(u.username || "").toLowerCase();

  // allowUsers has priority
  if (allowUsers.includes(uname)) return true;

  // roles
  const myRoles = (u.roles || []);
  return allowRoles.some(rr => myRoles.includes(rr));
}

/** =========================
 *  ADMIN PANEL
 *  ========================= */
function openAdmin() {
  if (session?.mode !== "ADMIN") return toast("bad","Admin gerekli");
  document.getElementById("cardAdmin").classList.remove("hidden");
  renderAdminTabs();
  renderAdminTable();
  toast("good","Admin panel açıldı.");
}

function closeAdmin() {
  document.getElementById("cardAdmin").classList.add("hidden");
}

function renderAdminTabs() {
  const tabs = document.getElementById("adminTabs");
  tabs.innerHTML = "";
  const labels = {
    Firms:"Firms", Aliases:"Aliases", Roles:"Roles", Users:"Users",
    KeyUsers:"KeyUsers", FirmAccessRoles:"FirmAccessRoles", Reports:"Reports"
  };
  Object.keys(labels).forEach(k => {
    const el = document.createElement("div");
    el.className = "tab" + (adminActiveTab === k ? " active" : "");
    el.textContent = labels[k];
    el.onclick = () => { adminActiveTab = k; renderAdminTabs(); renderAdminTable(); };
    tabs.appendChild(el);
  });
}

function getTabKeyToDBKey(tab){
  if (tab === "FirmAccessRoles") return "firmAccessRoles";
  if (tab === "KeyUsers") return "keyUsers";
  return tab.toLowerCase(); // Firms->firms, Reports->reports
}

function renderAdminTable() {
  const area = document.getElementById("adminArea");
  area.innerHTML = "";

  const dbKey = getTabKeyToDBKey(adminActiveTab);
  const rows = (DB && DB[dbKey]) ? DB[dbKey] : [];
  const cols = inferColumns(adminActiveTab);

  const info = document.createElement("div");
  info.className = "smallnote";
  info.innerHTML = `<b>Tab:</b> <span class="mono">${adminActiveTab}</span> · <b>Row:</b> ${rows.length}`;
  area.appendChild(info);

  const tools = document.createElement("div");
  tools.className = "right-actions";
  tools.style.margin = "10px 0 8px";
  const addBtn = document.createElement("button");
  addBtn.className = "btn small success";
  addBtn.textContent = "Satır Ekle";
  addBtn.onclick = () => {
    if (!DB) return;
    const blank = {};
    cols.forEach(c => blank[c] = "");
    DB[dbKey] = (DB[dbKey] || []).concat([blank]);
    renderAdminTable();
  };
  const delBtn = document.createElement("button");
  delBtn.className = "btn small danger";
  delBtn.textContent = "Seçili Satırları Sil";
  delBtn.onclick = () => deleteSelectedRows();
  tools.appendChild(addBtn);
  tools.appendChild(delBtn);
  area.appendChild(tools);

  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");

  // select column
  const thSel = document.createElement("th");
  thSel.style.width = "34px";
  thSel.innerHTML = `<input type="checkbox" id="selAll" />`;
  trh.appendChild(thSel);

  cols.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  rows.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.idx = idx;

    const tdSel = document.createElement("td");
    tdSel.innerHTML = `<input type="checkbox" class="rowSel" data-idx="${idx}">`;
    tr.appendChild(tdSel);

    cols.forEach(c => {
      const td = document.createElement("td");
      const inp = document.createElement(c === "desc" ? "textarea" : "input");
      inp.className = "input";
      if (inp.tagName.toLowerCase() === "textarea") inp.style.minHeight = "42px";
      inp.value = (r && r[c] !== undefined) ? String(r[c]) : "";
      inp.oninput = (e) => {
        DB[dbKey][idx][c] = e.target.value;
      };
      td.appendChild(inp);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  area.appendChild(table);

  // hook select all
  setTimeout(() => {
    const selAll = document.getElementById("selAll");
    if (selAll) {
      selAll.onchange = () => {
        document.querySelectorAll(".rowSel").forEach(cb => cb.checked = selAll.checked);
      };
    }
  }, 0);
}

function inferColumns(tab) {
  // match Apps Script writeTable_ columns (same order recommended)
  if (tab === "Firms") return ["firmKey","display","active"];
  if (tab === "Aliases") return ["alias","firmKey"];
  if (tab === "Roles") return ["roleKey","desc","active"];
  if (tab === "Users") return ["username","passHash","display","email","rolesCsv","active"];
  if (tab === "KeyUsers") return ["username","passHash","display","email","active"];
  if (tab === "FirmAccessRoles") return ["firmKey","requiredRolesCsv"];
  if (tab === "Reports") return ["id","firmKey","cat","name","url","desc","allowRolesCsv","allowUsersCsv","active"];
  return [];
}

function deleteSelectedRows() {
  const dbKey = getTabKeyToDBKey(adminActiveTab);
  const rows = DB?.[dbKey] || [];
  const selected = Array.from(document.querySelectorAll(".rowSel"))
    .filter(cb => cb.checked)
    .map(cb => Number(cb.dataset.idx))
    .sort((a,b)=>b-a);
  if (!selected.length) return toast("warn","Seçili satır yok");

  selected.forEach(i => rows.splice(i,1));
  DB[dbKey] = rows;
  toast("good","Silindi: " + selected.length);
  renderAdminTable();
}

async function saveAdmin() {
  if (session?.mode !== "ADMIN") return toast("bad","Admin gerekli");
  if (!DB) return toast("bad","DB yok");

  // basic sanitize: ensure all keys exist
  const payloadDB = {};
  DB_KEYS.forEach(k => payloadDB[k] = Array.isArray(DB[k]) ? DB[k] : []);
  try {
    const res = await apiCall({ action:"saveDB", token: session.token, db: payloadDB });
    if (!res.ok) return toast("bad", res.error || "saveDB failed");
    toast("good","Kaydedildi (saveDB). Yenileme yapılıyor…");
    await refreshDB(true);
    renderAdminTable();
    renderMain();
  } catch (e) {
    toast("bad","saveAdmin hata: " + e.message);
  }
}

function exportJSON() {
  if (!DB) return toast("warn","DB yok");
  const blob = new Blob([JSON.stringify(DB, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  toast("good","JSON export açıldı.");
}

/** =========================
 *  TOAST
 *  ========================= */
function toast(level, msg) {
  const t = document.getElementById("toast");
  const dot = document.getElementById("toastDot");
  const m = document.getElementById("toastMsg");
  dot.className = "dot " + (level === "good" ? "good" : level === "bad" ? "bad" : "warn");
  m.textContent = msg;
  t.classList.remove("hidden");
  clearTimeout(toast._timer);
  toast._timer = setTimeout(hideToast, 4200);
}
function hideToast() {
  const t = document.getElementById("toast");
  t.classList.add("hidden");
}
</script>
</body>
</html>
