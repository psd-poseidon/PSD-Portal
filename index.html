<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSD-Portal</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#9aa7bd;
      --text:#eaf0ff;
      --border:rgba(255,255,255,.10);

      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --info:#60a5fa;
    }
    *{box-sizing:border-box}
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(59,130,246,.25), transparent 60%),
                  radial-gradient(1000px 600px at 80% 0%, rgba(34,197,94,.20), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    /* FULLSCREEN PORTAL LAYOUT */
    .portal-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:18px 18px 10px;
      width:100%;
      margin:0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    h1{ margin:0 0 6px; font-size:22px; letter-spacing:.3px; }
    .sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.4; }

    .topbar-right{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
      justify-content:flex-end;
      text-align:right;
    }

    .who{
      font-size:12px;
      color:rgba(255,255,255,.80);
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .linkbtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      transition: transform .06s ease, border-color .06s ease;
      white-space:nowrap;
    }
    .linkbtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .linkbtn:active{ transform: translateY(0px); }
    .linkbtn.primary{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.12); }
    .linkbtn.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.12); }

    /* portal toolbar */
    .toolbar{
      width:100%;
      margin:0;
      padding:0 18px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .toolbar-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .input{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      outline: none;
      font-size: 13px;
      width: 320px;
      max-width: 100%;
    }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chipBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.85);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      transition: transform .06s ease, border-color .06s ease, background .06s ease;
      user-select:none;
      white-space:nowrap;
    }
    .chipBtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .chipBtn.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.22);
      color: rgba(255,255,255,.95);
    }

    .wrap{
      width:100%;
      margin:0;
      padding: 0 18px 28px;
      flex:1;
    }
    .section{
      margin:14px 0 18px;
      padding:14px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 16px;
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0 0 12px;
      font-size:14px;
      letter-spacing:.2px;
      color: #dbe6ff;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 880px){ .grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 560px){
      header{flex-direction:column; align-items:flex-start;}
      .topbar-right{justify-content:flex-start; text-align:left;}
      .grid{grid-template-columns: 1fr;}
      .input{ width: 100%; }
    }

    .btn{
      text-align:left;
      width:100%;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 11px 12px 10px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .06s ease, border-color .06s ease, opacity .06s ease;
      position:relative;
      overflow:hidden;
      min-height:62px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(0px); }

    .pill{
      position:absolute;
      top:8px; right:8px;
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.06);
    }

    .name{
      font-weight:800;
      font-size:12.5px;
      margin:0 0 5px;
      line-height:1.2;
      padding-right:78px;
    }
    .desc{
      margin:0;
      font-size:11.5px;
      color: var(--muted);
      line-height:1.3;
    }

    .tag-sudesan{ outline: 1px solid rgba(59,130,246,.35); }
    .tag-sudesan::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(120deg, rgba(59,130,246,.18), transparent 55%);
      pointer-events:none;
    }
    .tag-dupack{ outline: 1px solid rgba(34,197,94,.30); }
    .tag-dupack::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(120deg, rgba(34,197,94,.14), transparent 55%);
      pointer-events:none;
    }
    .tag-other{ outline: 1px solid rgba(168,85,247,.26); }
    .tag-other::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(120deg, rgba(168,85,247,.14), transparent 55%);
      pointer-events:none;
    }

    .disabled{
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.55);
      cursor:not-allowed;
      opacity:.85;
    }
    .disabled:hover{ transform:none; border-color: var(--border); }

    footer{
      width:100%;
      margin:0;
      padding: 0 18px 26px;
      color: rgba(255,255,255,.45);
      font-size:12px;
    }

    /* LOGIN */
    .overlay{
      position:fixed;
      inset:0;
      background: radial-gradient(1000px 700px at 20% 0%, rgba(59,130,246,.25), transparent 55%),
                  radial-gradient(900px 650px at 80% 0%, rgba(34,197,94,.20), transparent 55%),
                  rgba(7,10,18,.78);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .overlay.show{ display:flex; }

    .login-card{
      width:min(980px, 100%);
      border:1px solid var(--border);
      border-radius:18px;
      background: rgba(17,26,46,.92);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
    }
    @media (max-width: 860px){
      .login-card{ grid-template-columns:1fr; }
      .login-left{ display:none; }
    }
    .login-left{
      padding:28px;
      border-right:1px solid var(--border);
      background:
        linear-gradient(120deg, rgba(59,130,246,.22), transparent 55%),
        linear-gradient(210deg, rgba(34,197,94,.16), transparent 55%),
        rgba(255,255,255,.03);
      min-height:360px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:14px;
    }

    .login-right{
      padding:28px;
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:center;
      min-height:360px;
    }
    .login-title{ margin:0; font-size:18px; letter-spacing:.2px; }
    .login-sub{ margin:0 0 6px; color: var(--muted); font-size:13px; line-height:1.4; }

    .field{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:8px;
    }
    .label{
      font-size:12px;
      color:rgba(255,255,255,.78);
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .hint{ font-size:11px; color:rgba(255,255,255,.45); }

    .login-input, .select{
      width:100%;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 12px;
      outline: none;
      font-size: 13px;
    }
    .primary{
      width:100%;
      margin-top:10px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(120deg, rgba(59,130,246,.28), rgba(34,197,94,.16));
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }

    .msg{
      margin-top:8px;
      font-size:12px;
      min-height:18px;
      color:rgba(255,255,255,.78);
    }
    .msg.err{ color: rgba(239,68,68,.95); }
    .msg.ok{ color: rgba(34,197,94,.95); }
    .msg.warn{ color: rgba(245,158,11,.95); }
    .msg.info{ color: rgba(96,165,250,.95); }

    .tiny{
      color: rgba(255,255,255,.45);
      font-size:11px;
      margin-top:10px;
      line-height:1.4;
    }

    /* ADMIN */
    .admin-wrap{ width:100%; margin:0; padding: 0 18px 28px; }
    .admin-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .admin-grid{ grid-template-columns: 1fr; } }

    .panel{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding:14px;
    }
    .panel h3{
      margin:0 0 10px;
      font-size:14px;
      color:#dbe6ff;
      letter-spacing:.2px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .row{ grid-template-columns: 1fr; } }

    .btn2{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 12px;
      font-weight: 650;
      transition: transform .06s ease, border-color .06s ease;
    }
    .btn2:hover{ border-color: rgba(255,255,255,.18); transform: translateY(-1px); }
    .btn2:active{ transform: translateY(0px); }
    .btn2.ok{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .btn2.danger{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }
    .btn2.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.10); }
    .btn2.info{ border-color: rgba(96,165,250,.25); background: rgba(96,165,250,.10); }

    .list{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 280px;
      overflow:auto;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .item .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .item .meta b{
      font-size:12.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item .meta span{
      font-size:11px;
      color: rgba(255,255,255,.55);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pills{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .pill2{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      white-space:nowrap;
    }
    .pill2.off{ opacity:.55; text-decoration: line-through; }

    .rolesBox{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(255,255,255,.03);
    }
    .chk{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color: rgba(255,255,255,.85);
      user-select:none;
    }
    .chk input{ transform: translateY(1px); }

    .smallNote{
      font-size:11px;
      color: rgba(255,255,255,.55);
      line-height:1.4;
      margin-top:8px;
    }
    .hr{
      height:1px;
      background: var(--border);
      margin:12px 0;
    }
  </style>
</head>

<body>
  <div class="portal-shell">

    <header>
      <div>
        <h1 id="portalTitle">PSD-Portal</h1>
        <p class="sub" id="portalSub">Butonlara tıklayınca ilgili Google Sheet / Looker Studio ekranı yeni sekmede açılır. URL boş olanlar pasiftir.</p>
      </div>

      <div class="topbar-right">
        <!-- TOP LOGO (Portal sağ üst) -->
        <div class="toplogo" id="topLogoBox" style="display:none;" title="">
          <!-- Inline SVG (kırılmaz) -->
          <svg viewBox="0 0 320 70" xmlns="http://www.w3.org/2000/svg" aria-label="PSD Poseidon">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#60a5fa" stop-opacity="0.95"/>
                <stop offset="1" stop-color="#22c55e" stop-opacity="0.85"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="320" height="70" rx="14" fill="rgba(255,255,255,0.02)" />
            <g transform="translate(14,12)">
              <path d="M18 34c10-8 18-18 18-26 0-4-3-7-7-7-5 0-8 4-11 9-3-5-6-9-11-9-4 0-7 3-7 7 0 8 8 18 18 26z" fill="url(#g1)" opacity="0.95"/>
              <circle cx="18" cy="34" r="13" fill="none" stroke="rgba(255,255,255,0.22)" stroke-width="2"/>
            </g>
            <text x="64" y="30" font-family="ui-sans-serif,system-ui" font-size="18" fill="#eaf0ff" font-weight="800" letter-spacing="0.8">PSD</text>
            <text x="64" y="52" font-family="ui-sans-serif,system-ui" font-size="14" fill="rgba(234,240,255,0.78)" font-weight="600" letter-spacing="0.4">Poseidon Portal</text>
          </svg>
        </div>

        <div class="who" id="whoBox" style="display:none;"></div>

        <button class="linkbtn warn" id="adminBtn" style="display:none;" type="button">Admin</button>
        <button class="linkbtn primary" id="saveBtn" style="display:none;" type="button">Kaydet</button>
        <button class="linkbtn" id="logoutBtn" style="display:none;" type="button">Çıkış</button>
      </div>
    </header>

    <!-- PORTAL TOOLBAR (Firma bazlı kullanıcılar) -->
    <div class="toolbar" id="portalToolbar" style="display:none;">
      <div class="toolbar-row">
        <input id="q" class="input" placeholder="Ara (ad/açıklama)..." />
        <div class="chips" id="chips"></div>
      </div>
    </div>

    <!-- KEY USER TOOLBAR (Tüm firmalar) -->
    <div class="toolbar" id="keyToolbar" style="display:none;">
      <div class="toolbar-row">
        <input id="kq" class="input" placeholder="Ara (firma/kategori/ad/açıklama)..." />
        <div class="chips" id="kFirmChips"></div>
      </div>
      <div class="toolbar-row">
        <div class="chips" id="kCatChips"></div>
      </div>
    </div>

    <!-- PORTAL VIEW -->
    <div class="wrap" id="portalApp" style="display:none;"></div>

    <!-- KEY USER VIEW -->
    <div class="wrap" id="keyApp" style="display:none;"></div>

    <!-- ADMIN VIEW -->
    <div class="admin-wrap" id="adminView" style="display:none;">
      <div class="section">
        <div class="section-title">
          <span>Admin Paneli</span>
          <span style="font-size:12px;color:rgba(255,255,255,.55)" id="pendingInfo"></span>
        </div>
        <div style="color:rgba(255,255,255,.70);font-size:12px;line-height:1.45">
          Admin tarafında yapılan değişiklikler taslak olarak tutulur. Portal’a dönünce sağ üstte <b>Kaydet</b> görünür; kaydedince herkes için güncellenir.
        </div>
      </div>

      <!-- ORDERED ADMIN GRID (1..8) -->
      <div class="admin-grid">

        <!-- 1) Firma Yönetimi -->
        <div class="panel">
          <h3>1) Firma Yönetimi (Firma Ekle + Düzenle + Sil)</h3>

          <div class="row">
            <div class="field">
              <div class="label">Firma Adı <span class="hint">(örn: Sudesan / Kuzey Pet)</span></div>
              <input id="firmDisplayIn" class="login-input" placeholder="Firma adı" />
            </div>
            <div class="field">
              <div class="label">Firma Key (otomatik)</div>
              <input id="firmKeyOut" class="login-input" placeholder="otomatik oluşur" disabled />
            </div>
          </div>

          <input id="firmEditingKey" type="hidden" />

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn2 ok" id="addFirmBtn" type="button">Firmayı Ekle</button>
            <button class="btn2 info" id="updateFirmBtn" type="button" style="display:none;">Firmayı Güncelle</button>
            <button class="btn2" id="cancelFirmEditBtn" type="button" style="display:none;">İptal</button>
            <button class="btn2" id="addAliasBtn" type="button">Bu Yazımı Alias Olarak Ekle</button>
          </div>

          <div class="msg" id="firmMsg"></div>
          <div class="list" id="firmList"></div>
        </div>

        <!-- 2) Rol Yönetimi -->
        <div class="panel">
          <h3>2) Rol Yönetimi (Ekle / Aktif-Pasif / Düzenle / Sil)</h3>

          <div class="row">
            <div class="field">
              <div class="label">Yeni Rol Kodu <span class="hint">(örn: SUDESAN_VIEW)</span></div>
              <input id="roleNewKey" class="login-input" placeholder="ROL_KODU" />
            </div>
            <div class="field">
              <div class="label">Açıklama <span class="hint">(opsiyonel)</span></div>
              <input id="roleNewDesc" class="login-input" placeholder="örn: Sudesan raporlarını görüntüleme" />
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn2 ok" id="addRoleBtn" type="button">Rolü Ekle</button>
            <button class="btn2" id="normalizeRolesBtn" type="button">Rol Kodlarını Normalize Et</button>
          </div>

          <div class="msg" id="roleMsg"></div>

          <div class="smallNote">
            Not: Rol “Pasif” yapılınca kullanıcıda rol dursa bile erişim sağlamaz.
          </div>

          <div class="list" id="roleList"></div>
        </div>

        <!-- 3) Firmaya Rol Tanımla -->
        <div class="panel">
          <h3>3) Firmaya Rol Tanımla (Ekle + Düzenle + Sil)</h3>

          <div class="field">
            <div class="label">Firma Seç <span class="hint">(giriş için gerekli roller)</span></div>
            <select id="firmSelForRoles" class="select"></select>
          </div>

          <div class="label" style="margin-top:10px;">Bu firmaya giriş için gerekli roller</div>
          <div class="rolesBox" id="firmRoleBox"></div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn2 info" id="saveFirmRolesBtn" type="button">Firma Rollerini Güncelle</button>
            <button class="btn2 danger" id="clearFirmRolesBtn" type="button">Firma Rollerini Temizle</button>
          </div>

          <div class="msg" id="firmRoleMsg"></div>

          <div class="smallNote">
            “Temizle” seçili firmanın giriş rol listesini boşaltır. (Login için otomatik fallback: <code>FIRMAKEY_VIEW</code>)
          </div>
        </div>

        <!-- 4) Kullanıcı -->
        <div class="panel">
          <h3>4) Kullanıcı Ekle & Yetkilendir (Aktif-Pasif / Düzenle / Sil)</h3>

          <input id="userEditingKey" type="hidden" />

          <div class="row">
            <div class="field">
              <div class="label">Kullanıcı Adı</div>
              <input id="newUserU" class="login-input" placeholder="örn: zeynep" />
            </div>
            <div class="field">
              <div class="label">Şifre</div>
              <input id="newUserP" class="login-input" placeholder="örn: 1234" />
            </div>
            <div class="field">
              <div class="label">Görünen Ad</div>
              <input id="newUserD" class="login-input" placeholder="örn: Zeynep" />
            </div>
            <div class="field">
              <div class="label">E-posta</div>
              <input id="newUserE" type="email" class="login-input" placeholder="örn: zeynep@firma.com" />
            </div>
            <div class="field">
              <div class="label">Not</div>
              <input class="login-input" value="Roller aşağıdan seçilir" disabled />
            </div>
          </div>

          <div class="label" style="margin-top:10px;">Roller (sadece aktif roller)</div>
          <div class="rolesBox" id="userRoleBox"></div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn2 ok" id="addUserBtn" type="button">Kullanıcıyı Ekle</button>
            <button class="btn2 info" id="updateUserBtn" type="button" style="display:none;">Kullanıcıyı Güncelle</button>
            <button class="btn2 warn" id="resetUserPwdBtn" type="button" style="display:none;">Şifreyi Sıfırla</button>
            <button class="btn2" id="cancelUserEditBtn" type="button" style="display:none;">İptal</button>
          </div>

          <div class="msg" id="userMsg"></div>
          <div class="list" id="userList"></div>
        </div>

        <!-- 5) Rapor Yönetimi -->
        <div class="panel">
          <h3>5) Rapor Yönetimi (Ekle / Düzenle / Sil)</h3>

          <div class="field">
            <div class="label">Mevcut Raporlar</div>
            <select id="repPickSel" class="select"></select>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn2 info" id="loadReportBtn" type="button">Seçili Raporu Yükle (Düzenle)</button>
            <button class="btn2 danger" id="deletePickedReportBtn" type="button">Seçili Raporu Sil</button>
            <button class="btn2" id="clearReportFormBtn" type="button">Formu Temizle (Yeni)</button>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <div class="label">Firma</div>
              <select id="repFirmSel" class="select"></select>
            </div>
            <div class="field">
              <div class="label">Kategori</div>
              <input id="repCat" class="login-input" placeholder="örn: DEPO / ÜRETİM / KPI" />
            </div>
            <div class="field">
              <div class="label">Rapor Adı</div>
              <input id="repName" class="login-input" placeholder="örn: Sudesan | Stok Analiz Raporu" />
            </div>
            <div class="field">
              <div class="label">Açıklama</div>
              <input id="repDesc" class="login-input" placeholder="örn: Google Sheet / stok analiz" />
            </div>
            <div class="field" style="grid-column:1/-1;">
              <div class="label">URL</div>
              <input id="repUrl" class="login-input" placeholder="https://..." />
            </div>
          </div>

          <div class="label" style="margin-top:10px;">Bu raporu görebilecek roller (sadece aktif roller)</div>
          <div class="rolesBox" id="repRoleBox"></div>

          <input id="repEditingId" type="hidden" />

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn2 ok" id="upsertReportBtn" type="button">Kaydet (Ekle / Güncelle)</button>
          </div>

          <div class="msg" id="repMsg"></div>
          <div class="list" id="reportList"></div>
        </div>

        <!-- 6) Firmaya ve Role Rapor Tanımlama -->
        <div class="panel">
          <h3>6) Firmaya ve Role Rapor Tanımlama (Ekle + Düzenle + Sil)</h3>

          <div class="smallNote">
            Bu panel, raporların <b>Firma</b> ve <b>Rol</b> eşleşmelerini topluca yönetmek içindir.
            (Rapor içindeki ACL allowRoles alanı güncellenir.)
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <div class="label">Firma</div>
              <select id="mapFirmSel" class="select"></select>
            </div>
            <div class="field">
              <div class="label">Rol</div>
              <select id="mapRoleSel" class="select"></select>
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:16px; flex-wrap:wrap;">
            <button class="btn2 info" id="loadFirmRoleReportsBtn" type="button">Listele</button>
          </div>

          <div class="hr"></div>

          <div class="label">Bu Firma için Raporlar (Seçili Rol için Aç/Kapat)</div>
          <div class="list" id="firmRoleReportList"></div>

          <div style="margin-top:10px; display:flex; gap:16px; flex-wrap:wrap;">
            <button class="btn2 ok" id="applyFirmRoleReportsBtn" type="button">Seçimleri Uygula (Taslak)</button>
            <button class="btn2 danger" id="clearFirmRoleReportsBtn" type="button">Bu Rolü Firmadaki Tüm Raporlardan Kaldır</button>
          </div>

          <div class="msg" id="mapMsg"></div>
        </div>

        <!-- 7) Kaydet Akışı -->
        <div class="panel">
          <h3>7) Kaydet</h3>

          <div style="color:rgba(255,255,255,.70);font-size:12px;line-height:1.45">
            Admin panelinde eklediğin her şey “taslak” olarak bekler. Sağ üstte çıkan <b>Kaydet</b> butonuna basınca kalıcı olur.
          </div>

          <div class="hr"></div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn2 warn" id="goPortalBtn" type="button">Portal’a Dön</button>
            <button class="btn2" id="discardBtn" type="button">Taslak Değişiklikleri At</button>
          </div>

          <div class="msg" id="flowMsg"></div>
        </div>

        <!-- 8) KEY USER Yönetimi (Yeni) -->
        <div class="panel">
          <h3>8) Key User Yönetimi (Tüm firmalara erişir)</h3>

          <input id="keyUserEditingKey" type="hidden" />

          <div class="smallNote">
            Key User’lar firma ayrımı olmaksızın tüm linkleri görür. Login ekranında <b>firma girmeden</b> de giriş yapabilir.
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <div class="label">Kullanıcı Adı</div>
              <input id="keyUserU" class="login-input" placeholder="örn: key_alper" />
            </div>
            <div class="field">
              <div class="label">Şifre</div>
              <input id="keyUserP" class="login-input" placeholder="örn: 1234" />
            </div>
            <div class="field">
              <div class="label">Görünen Ad</div>
              <input id="keyUserD" class="login-input" placeholder="örn: Alper (Key)" />
            </div>
            <div class="field">
              <div class="label">E-posta</div>
              <input id="keyUserE" type="email" class="login-input" placeholder="örn: alper@psd.com.tr" />
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn2 ok" id="addKeyUserBtn" type="button">Key User Ekle</button>
            <button class="btn2 info" id="updateKeyUserBtn" type="button" style="display:none;">Key User Güncelle</button>
            <button class="btn2 warn" id="resetKeyUserPwdBtn" type="button" style="display:none;">Şifreyi Sıfırla</button>
            <button class="btn2" id="cancelKeyUserEditBtn" type="button" style="display:none;">İptal</button>
          </div>

          <div class="msg" id="keyUserMsg"></div>
          <div class="list" id="keyUserList"></div>
        </div>

      </div>
    </div>

    <footer id="footer" style="display:none;">
      İpucu: Admin ile eklenenler kalıcı hale gelmesi için Portal ekranında <code>Kaydet</code> butonuna basılmalıdır.
    </footer>

  </div><!-- /portal-shell -->

  <!-- LOGIN OVERLAY -->
  <div class="overlay" id="loginOverlay">
    <div class="login-card">
      <div class="login-left">
        <!-- HERO LOGO (Login sol) -->
        <div class="hero-logo">
          <svg viewBox="0 0 360 90" xmlns="http://www.w3.org/2000/svg" aria-label="PSD Poseidon">
            <defs>
              <linearGradient id="hg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#60a5fa" stop-opacity="0.95"/>
                <stop offset="1" stop-color="#22c55e" stop-opacity="0.9"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="360" height="90" rx="18" fill="rgba(255,255,255,0.02)" />
            <g transform="translate(18,18)">
              <path d="M26 50c14-10 26-24 26-36 0-6-5-11-11-11-8 0-12 7-15 14-3-7-7-14-15-14-6 0-11 5-11 11 0 12 12 26 26 36z" fill="url(#hg)"/>
              <circle cx="26" cy="50" r="18" fill="none" stroke="rgba(255,255,255,0.20)" stroke-width="2.5"/>
            </g>
            <text x="90" y="45" font-family="ui-sans-serif,system-ui" font-size="26" fill="#eaf0ff" font-weight="900" letter-spacing="1">PSD</text>
            <text x="90" y="70" font-family="ui-sans-serif,system-ui" font-size="16" fill="rgba(234,240,255,0.78)" font-weight="650" letter-spacing="0.6">Poseidon</text>
          </svg>
        </div>

        <h2>PSD-Portal</h2>
        <p>Hoş geldiniz.</p>
      </div>

      <div class="login-right">
        <h3 class="login-title">Giriş</h3>
        <p class="login-sub">Kullanıcı adı, şifre ve firma ile giriş yapın. <span class="hint">(Key User ise firma opsiyonel)</span></p>

        <div class="field">
          <div class="label">Kullanıcı Adı</div>
          <input id="u" class="login-input" autocomplete="username" placeholder="" />
        </div>

        <div class="field">
          <div class="label">Şifre</div>
          <input id="p" type="password" class="login-input" autocomplete="current-password" placeholder="••••••••" />
        </div>

        <div class="field">
          <div class="label">Firma <span class="hint">(Key User değilse Boş Bırakılamaz)</span></div>
          <input id="firmName" class="login-input" placeholder='' />
        </div>

        <button class="primary" id="loginBtn" type="button" onclick="window.__doLogin && window.__doLogin()">Giriş Yap</button>
        <div class="msg" id="loginMsg"></div>

        <div class="tiny">
          * Not: Bu yapı frontend gating’dir. Linklerin gerçek güvenliği için Google paylaşım izinleri / Apps Script backend gerekir.
        </div>
      </div>
    </div>
  </div>

<script>
  /********************************************************************
   * ADMIN CREDENTIALS
   ********************************************************************/
  const ADMIN_LOGIN = { username: "Poseidon", password: "psd123" };

  /********************************************************************
   * DB STORAGE
   ********************************************************************/
  const DB_KEY = "PSD_PORTAL_DB_V2";
  const WORKING_KEY = "PSD_PORTAL_WORKING_V2";
  const SESSION_KEY = "PSD_PORTAL_SESSION_V6";

  const deepClone = (x) => JSON.parse(JSON.stringify(x));
  const norm = (s="") => String(s).toLowerCase().trim();
  const trim = (s="") => String(s).trim();

  function getLocalJSON(key){
    try{
      const s = localStorage.getItem(key);
      if (!s) return null;
      return JSON.parse(s);
    }catch(e){ return null; }
  }
  function setLocalJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
  }

  function setMsg(id, text, type){
    const el = document.getElementById(id);
    if (!el) return;
    el.className = "msg" + (type ? (" " + type) : "");
    el.textContent = text || "";
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  /********************************************************************
   * Firm normalize
   ********************************************************************/
  function normalizeFirmNameForAlias(s){
    const t = norm(s)
      .replace(/[.,]/g, " ")
      .replace(/\s+/g, " ")
      .replace(/\b(as|aş|a\.ş|a\.s|ltd|limited|inc|corp|co|san|tic|sti|şti|ve|veya)\b/g, "")
      .replace(/\s+/g, " ")
      .trim();
    return t;
  }
  function firmKeyAuto(displayName){
    const raw = trim(displayName);
    if (!raw) return "";
    return raw
      .toUpperCase()
      .replace(/\s+/g, "_")
      .replace(/[^\wĞÜŞİÖÇ_]/g, "");
  }

  function firmKeyFromInput(displayName, db){
    const raw = trim(displayName);
    if (!raw) return "";
    const aliasKey = normalizeFirmNameForAlias(raw);
    const aliases = (db && db.aliases) ? db.aliases : {};
    if (aliases[aliasKey]) return aliases[aliasKey];
    return firmKeyAuto(raw);
  }

  /********************************************************************
   * Roles: active/pasif + normalize
   ********************************************************************/
  function normalizeRoleKey(k){
    return trim(k).toUpperCase().replace(/\s+/g, "_").replace(/[^\wĞÜŞİÖÇ_]/g, "");
  }
  function activeRoles(db){
    return (db.roles || []).filter(r => r && r.active !== false).map(r => r.key);
  }
  function roleMetaMap(db){
    const m = {};
    (db.roles||[]).forEach(r => { if (r && r.key) m[r.key] = r; });
    return m;
  }

  /********************************************************************
   * Seed DB (V2) + Key Users
   ********************************************************************/
  const SEED_DB = {
    firms: [
      { key:"SUDESAN", display:"Sudesan", active:true },
      { key:"DUPACK",  display:"Dupack",  active:true }
    ],
    aliases: { "sudesan":"SUDESAN", "dupack":"DUPACK" },

    roles: [
      { key:"SUDESAN_VIEW",    desc:"Sudesan raporlarını görüntüleme", active:true },
      { key:"DUPACK_VIEW",     desc:"Dupack raporlarını görüntüleme", active:true },
      { key:"OPERATIONS_VIEW", desc:"Operasyon raporları", active:true },
      { key:"FINANCE_VIEW",    desc:"Finans raporları", active:true },
      { key:"KPI_VIEW",        desc:"KPI raporları", active:true },
      { key:"DASHBOARD_VIEW",  desc:"Dashboard raporları", active:true }
    ],

    firmAccessRoles: {
      "SUDESAN":["SUDESAN_VIEW"],
      "DUPACK":["DUPACK_VIEW"]
    },

    users: [
      { username:"alper",  password:"1234", display:"Alper",  email:"", roles:["SUDESAN_VIEW","FINANCE_VIEW","KPI_VIEW","DASHBOARD_VIEW"], active:true },
      { username:"zeynep", password:"1234", display:"Zeynep", email:"", roles:["SUDESAN_VIEW","DASHBOARD_VIEW"], active:true },
      { username:"dupack", password:"1234", display:"Dupack", email:"", roles:["DUPACK_VIEW","DASHBOARD_VIEW"], active:true }
    ],

    // NEW: Key Users (firma bağımsız tam erişim)
    keyUsers: [
      // örnek:
      // { username:"keyuser", password:"1234", display:"Key User", email:"", active:true }
    ],

    reports: [
      { id:"r1", firm:"SUDESAN", cat:"DEPO", name:"Sudesan | Stok Analiz Raporu", url:"", desc:"Google Sheet / stok analiz", acl:{allowRoles:["SUDESAN_VIEW","OPERATIONS_VIEW"]} },
      { id:"r2", firm:"SUDESAN", cat:"DASHBOARD", name:"Sudesan | Looker Dashboard", url:"", desc:"Looker Studio dashboard", acl:{allowRoles:["DASHBOARD_VIEW","SUDESAN_VIEW"]} },
      { id:"r3", firm:"DUPACK",  cat:"DASHBOARD", name:"Dupack | Üretim Verimlilik ve Duruş Dashboard", url:"", desc:"Looker Studio dashboard", acl:{allowRoles:["DASHBOARD_VIEW","DUPACK_VIEW"]} }
    ]
  };

  function ensureDB(){
    const existing = getLocalJSON(DB_KEY);
    if (existing) return;
    setLocalJSON(DB_KEY, SEED_DB);
  }

  function loadCommittedDB(){
    ensureDB();
    const db = getLocalJSON(DB_KEY);

    if (!db.firmAccessRoles) db.firmAccessRoles = {};
    if (!db.keyUsers) db.keyUsers = [];

    // MIGRATION: firms/users/keyUsers active default
    let dirty = false;
    (db.firms || []).forEach(f => { if (typeof f.active === "undefined") { f.active = true; dirty = true; } });
    (db.users || []).forEach(u => { if (typeof u.active === "undefined") { u.active = true; dirty = true; } });
    (db.keyUsers || []).forEach(u => { if (typeof u.active === "undefined") { u.active = true; dirty = true; } });

    if (dirty) setLocalJSON(DB_KEY, db);
    return db;
  }

  function loadWorkingDB(){
    const w = getLocalJSON(WORKING_KEY);
    if (w) return w;
    return deepClone(loadCommittedDB());
  }
  function setWorkingDB(db){ setLocalJSON(WORKING_KEY, db); }
  function discardWorking(){ localStorage.removeItem(WORKING_KEY); }

  function hasPendingChanges(){
    const w = getLocalJSON(WORKING_KEY);
    if (!w) return false;
    const c = loadCommittedDB();
    return JSON.stringify(w) !== JSON.stringify(c);
  }

  function commitWorkingToDB(){
    const w = getLocalJSON(WORKING_KEY);
    if (!w) return false;
    setLocalJSON(DB_KEY, w);
    discardWorking();
    return true;
  }

  /********************************************************************
   * Session
   ********************************************************************/
  function setSession(session){ setLocalJSON(SESSION_KEY, session); }
  function getSession(){ return getLocalJSON(SESSION_KEY); }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }

  function isKeyUserSession(session){
    return !!(session && session.isKeyUser === true && session.mode === "KEY");
  }

  function hasRole(session, role, db){
    if (!session) return false;
    if (Array.isArray(session.roles) && session.roles.includes("ADMIN")) return true;
    if (isKeyUserSession(session)) return true; // Key User her role'ü bypass eder

    const meta = roleMetaMap(db || loadCommittedDB());
    if (role && meta[role] && meta[role].active === false) return false;

    return Array.isArray(session.roles) && session.roles.includes(role);
  }

  function firmAccessAllowed(session, firmKey, db){
    if (!session) return false;
    if (Array.isArray(session.roles) && session.roles.includes("ADMIN")) return true;
    if (isKeyUserSession(session)) return true; // firma gating yok

    const far = (db.firmAccessRoles && db.firmAccessRoles[firmKey]) ? db.firmAccessRoles[firmKey] : null;
    const required = (Array.isArray(far) && far.length) ? far : [`${firmKey}_VIEW`];
    return required.some(r => hasRole(session, r, db));
  }

  function isAllowed(item, session, db){
    if (!session) return false;
    if (Array.isArray(session.roles) && session.roles.includes("ADMIN")) return true;
    if (isKeyUserSession(session)) return true; // rapor ACL + firma sınırı yok

    if (item && item.firm && !firmAccessAllowed(session, item.firm, db)) return false;

    const acl = item.acl || {};
    const allowUsers = Array.isArray(acl.allowUsers) ? acl.allowUsers : [];
    const allowRoles = Array.isArray(acl.allowRoles) ? acl.allowRoles : [];
    if (allowUsers.includes(session.username)) return true;

    return allowRoles.some(r => hasRole(session, r, db));
  }

  /********************************************************************
   * UI: title + topbar + view switch
   ********************************************************************/
  function setPortalTitle(session){
    const h = document.getElementById("portalTitle");
    const sub = document.getElementById("portalSub");
    if (!h || !sub) return;

    if (!session){
      h.textContent = "PSD-Portal";
      document.title = "PSD-Portal";
      sub.textContent = "Butonlara tıklayınca ilgili Google Sheet / Looker Studio ekranı yeni sekmede açılır. URL boş olanlar pasiftir.";
      return;
    }

    if (session.mode === "ADMIN"){
      h.textContent = "PSD-Portal (Admin)";
      document.title = "PSD-Portal (Admin)";
      sub.textContent = "Admin: Firma/Rol/Kullanıcı/Rapor/Key User yönetimi. Değişiklikleri Kaydet ile kalıcı yap.";
      return;
    }

    if (session.mode === "KEY"){
      h.textContent = "PSD-Portal (Key User)";
      document.title = "PSD-Portal (Key User)";
      sub.textContent = "Key User: Tüm firmalardaki linkler görünür. Filtrelemek için firma/kategori chiplerini kullan.";
      return;
    }

    const title = `${session.firmDisplay}-Portal`;
    h.textContent = title;
    document.title = title;
    sub.textContent = "Butonlara tıklayınca ilgili Google Sheet / Looker Studio ekranı yeni sekmede açılır. URL boş olanlar pasiftir.";
  }

  function refreshTopbar(){
    const session = getSession();
    const whoBox = document.getElementById("whoBox");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminBtn = document.getElementById("adminBtn");
    const saveBtn = document.getElementById("saveBtn");
    const topLogoBox = document.getElementById("topLogoBox");

    if (!session){
      whoBox.style.display = "none";
      logoutBtn.style.display = "none";
      adminBtn.style.display = "none";
      saveBtn.style.display = "none";
      topLogoBox.style.display = "none";
      return;
    }

    whoBox.style.display = "block";
    logoutBtn.style.display = "inline-block";
    topLogoBox.style.display = (session.mode === "PORTAL" || session.mode === "KEY") ? "flex" : "none";

    if (session.mode === "ADMIN"){
      whoBox.textContent = `${session.display} • Admin`;
      adminBtn.style.display = "inline-block";
      saveBtn.style.display = hasPendingChanges() ? "inline-block" : "none";
      topLogoBox.style.display = "none";
    } else if (session.mode === "KEY"){
      whoBox.textContent = `${session.display} • Key User`;
      adminBtn.style.display = "none";
      saveBtn.style.display = "none";
    } else {
      whoBox.textContent = `${session.display} • ${session.firmDisplay}`;
      adminBtn.style.display = "none";
      saveBtn.style.display = "none";
    }
  }

  function showLogin(show){
    const ov = document.getElementById("loginOverlay");
    if (show) ov.classList.add("show");
    else ov.classList.remove("show");
  }
  function showPortal(show){
    document.getElementById("portalToolbar").style.display = show ? "block" : "none";
    document.getElementById("portalApp").style.display = show ? "block" : "none";
    document.getElementById("footer").style.display = show ? "block" : "none";
    if (show) {
      document.getElementById("keyToolbar").style.display = "none";
      document.getElementById("keyApp").style.display = "none";
    }
  }
  function showKey(show){
    document.getElementById("keyToolbar").style.display = show ? "block" : "none";
    document.getElementById("keyApp").style.display = show ? "block" : "none";
    document.getElementById("footer").style.display = show ? "block" : "none";
    if (show) {
      document.getElementById("portalToolbar").style.display = "none";
      document.getElementById("portalApp").style.display = "none";
    }
  }
  function showAdmin(show){
    document.getElementById("adminView").style.display = show ? "block" : "none";
    if (show){
      showPortal(false);
      showKey(false);
    }
  }

  /********************************************************************
   * Portal rendering (Firma bazlı)
   ********************************************************************/
  let selectedCat = "ALL";

  function tagOf(name){
    const n = norm(name);
    if (n.includes("sudesan")) return "SUDESAN";
    if (n.includes("dupack")) return "DUPACK";
    return "OTHER";
  }
  function groupByCat(list){
    const m = {};
    list.forEach(x => (m[x.cat] = m[x.cat] || []).push(x));
    return Object.keys(m).sort().map(k => ({cat:k, items:m[k]}));
  }

  function uniqueCatsForFirmKey(db, firmKey){
    const set = new Set((db.reports || []).filter(x => x.firm === firmKey).map(x => x.cat).filter(Boolean));
    return Array.from(set).sort();
  }

  function buildCategoryChips(){
    const session = getSession();
    const chips = document.getElementById("chips");
    chips.innerHTML = "";

    if (!session || session.mode !== "PORTAL") return;

    const db = loadCommittedDB();
    const cats = uniqueCatsForFirmKey(db, session.firmKey);
    const all = ["ALL", ...cats];

    all.forEach(c => {
      const b = document.createElement("button");
      b.className = "chipBtn" + (c === selectedCat ? " active" : "");
      b.textContent = (c === "ALL") ? "Tümü" : c;
      b.type = "button";
      b.onclick = () => {
        selectedCat = c;
        buildCategoryChips();
        renderPortal();
      };
      chips.appendChild(b);
    });
  }

  function renderPortal(){
    const session = getSession();
    if (!session){
      showLogin(true);
      setPortalTitle(null);
      return;
    }
    if (session.mode === "ADMIN"){
      showAdmin(true);
      return;
    }
    if (session.mode === "KEY"){
      showKey(true);
      renderKeyPortal();
      return;
    }

    showAdmin(false);
    showKey(false);
    showPortal(true);
    setPortalTitle(session);

    const db = loadCommittedDB();

    if (!firmAccessAllowed(session, session.firmKey, db)){
      const app = document.getElementById("portalApp");
      app.innerHTML = `
        <div class="section">
          <div class="section-title">Erişim Yok</div>
          <div style="color:var(--muted);font-size:13px;line-height:1.5">
            Bu firmaya erişim için gerekli rol(ler) kullanıcıda bulunmuyor.<br/>
            Firma: <b>${escapeHtml(session.firmDisplay)}</b> • Key: <b>${escapeHtml(session.firmKey)}</b>
          </div>
        </div>`;
      return;
    }

    const firmObj2 = (db.firms || []).find(f => f.key === session.firmKey);
    if (!firmObj2 || firmObj2.active === false){
      const app = document.getElementById("portalApp");
      app.innerHTML = `
        <div class="section">
          <div class="section-title">Firma Pasif</div>
          <div style="color:var(--muted);font-size:13px;line-height:1.5">
            Bu firma pasif olduğu için portal içeriği görüntülenemez.
          </div>
        </div>`;
      return;
    }

    const q = norm(document.getElementById("q").value);

    const firmList = (db.reports || []).filter(x => x.firm === session.firmKey);
    const allowedList = firmList.filter(x => isAllowed(x, session, db));
    const catList = allowedList.filter(x => selectedCat === "ALL" ? true : x.cat === selectedCat);

    const filtered = catList.filter(x => {
      if (!q) return true;
      const hay = norm(x.name + " " + (x.desc||"") + " " + (x.cat||""));
      return hay.includes(q);
    });

    const sections = groupByCat(filtered);
    const app = document.getElementById("portalApp");
    app.innerHTML = "";

    if (!filtered.length){
      app.innerHTML = `
        <div class="section">
          <div class="section-title">Sonuç yok</div>
          <div style="color:var(--muted);font-size:13px;">
            Bu firma/filtre için rapor bulunamadı.
          </div>
        </div>`;
      return;
    }

    sections.forEach(sec => {
      const box = document.createElement("div");
      box.className = "section";

      const title = document.createElement("div");
      title.className = "section-title";
      title.textContent = sec.cat;

      const grid = document.createElement("div");
      grid.className = "grid";

      sec.items.forEach(x => {
        const tag = tagOf(x.name);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn " + (tag==="SUDESAN" ? "tag-sudesan" : tag==="DUPACK" ? "tag-dupack" : "tag-other");

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = tag;

        const nm = document.createElement("div");
        nm.className = "name";
        nm.textContent = x.name;

        const ds = document.createElement("div");
        ds.className = "desc";
        ds.textContent = x.desc || "";

        btn.appendChild(pill);
        btn.appendChild(nm);
        btn.appendChild(ds);

        if (!x.url){
          btn.classList.add("disabled");
          btn.onclick = () => {};
        } else {
          btn.onclick = () => window.open(x.url, "_blank", "noopener,noreferrer");
        }

        grid.appendChild(btn);
      });

      box.appendChild(title);
      box.appendChild(grid);
      app.appendChild(box);
    });
  }

  /********************************************************************
   * KEY USER Portal (Tüm firmalar)
   ********************************************************************/
  let selectedFirmK = "ALL";
  let selectedCatK = "ALL";

  function firmDisplayByKey(db, key){
    const f = (db.firms||[]).find(x => x.key === key);
    return f ? f.display : key;
  }

  function uniqueFirmKeys(db){
    return (db.firms||[])
      .filter(f => f && f.active !== false)
      .map(f => f.key)
      .sort((a,b)=> firmDisplayByKey(db,a).localeCompare(firmDisplayByKey(db,b)));
  }

  function uniqueCatsAll(db, firmKeyOrAll){
    const set = new Set(
      (db.reports||[])
        .filter(r => (firmKeyOrAll === "ALL" ? true : r.firm === firmKeyOrAll))
        .map(r => r.cat)
        .filter(Boolean)
    );
    return Array.from(set).sort();
  }

  function buildKeyFirmChips(){
    const session = getSession();
    const chips = document.getElementById("kFirmChips");
    chips.innerHTML = "";
    if (!session || session.mode !== "KEY") return;

    const db = loadCommittedDB();
    const firms = uniqueFirmKeys(db);
    const all = ["ALL", ...firms];

    all.forEach(fk => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "chipBtn" + (fk === selectedFirmK ? " active" : "");
      b.textContent = (fk === "ALL") ? "Tüm Firmalar" : firmDisplayByKey(db, fk);
      b.onclick = () => {
        selectedFirmK = fk;
        selectedCatK = "ALL"; // firma değişince kategori reset
        buildKeyFirmChips();
        buildKeyCatChips();
        renderKeyPortal();
      };
      chips.appendChild(b);
    });
  }

  function buildKeyCatChips(){
    const session = getSession();
    const chips = document.getElementById("kCatChips");
    chips.innerHTML = "";
    if (!session || session.mode !== "KEY") return;

    const db = loadCommittedDB();
    const cats = uniqueCatsAll(db, selectedFirmK);
    const all = ["ALL", ...cats];

    all.forEach(c => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "chipBtn" + (c === selectedCatK ? " active" : "");
      b.textContent = (c === "ALL") ? "Tümü" : c;
      b.onclick = () => {
        selectedCatK = c;
        buildKeyCatChips();
        renderKeyPortal();
      };
      chips.appendChild(b);
    });
  }

  function groupByFirmThenCat(list){
    const m = {};
    list.forEach(r => {
      if (!m[r.firm]) m[r.firm] = {};
      if (!m[r.firm][r.cat]) m[r.firm][r.cat] = [];
      m[r.firm][r.cat].push(r);
    });

    const firmKeys = Object.keys(m).sort((a,b)=> a.localeCompare(b));
    const out = [];
    firmKeys.forEach(fk => {
      const cats = Object.keys(m[fk]).sort();
      cats.forEach(cat => {
        out.push({ firm: fk, cat, items: m[fk][cat] });
      });
    });
    return out;
  }

  function renderKeyPortal(){
    const session = getSession();
    if (!session || session.mode !== "KEY"){
      return;
    }

    showAdmin(false);
    showPortal(false);
    showKey(true);
    setPortalTitle(session);

    const db = loadCommittedDB();

    const q = norm(document.getElementById("kq").value);

    // Key User her şeyi görür ama firma pasif ise göstermeyelim (istersen kaldırabilirsin)
    const activeFirmSet = new Set((db.firms||[]).filter(f=>f.active!==false).map(f=>f.key));

    let list = (db.reports || []).slice();
    list = list.filter(r => activeFirmSet.has(r.firm));

    if (selectedFirmK !== "ALL"){
      list = list.filter(r => r.firm === selectedFirmK);
    }
    if (selectedCatK !== "ALL"){
      list = list.filter(r => r.cat === selectedCatK);
    }

    list = list.filter(r => {
      if (!q) return true;
      const hay = norm(
        firmDisplayByKey(db, r.firm) + " " +
        (r.firm||"") + " " +
        (r.cat||"") + " " +
        (r.name||"") + " " +
        (r.desc||"")
      );
      return hay.includes(q);
    });

    const app = document.getElementById("keyApp");
    app.innerHTML = "";

    if (!list.length){
      app.innerHTML = `
        <div class="section">
          <div class="section-title">Sonuç yok</div>
          <div style="color:var(--muted);font-size:13px;">
            Bu filtre için rapor bulunamadı.
          </div>
        </div>`;
      return;
    }

    const sections = groupByFirmThenCat(list);
    sections.forEach(sec => {
      const box = document.createElement("div");
      box.className = "section";

      const title = document.createElement("div");
      title.className = "section-title";
      title.textContent = `${firmDisplayByKey(db, sec.firm)} • ${sec.cat}`;

      const grid = document.createElement("div");
      grid.className = "grid";

      sec.items.forEach(x => {
        const tag = tagOf(x.name);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn " + (tag==="SUDESAN" ? "tag-sudesan" : tag==="DUPACK" ? "tag-dupack" : "tag-other");

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = x.firm; // Key user için firmayı pill yapalım

        const nm = document.createElement("div");
        nm.className = "name";
        nm.textContent = x.name;

        const ds = document.createElement("div");
        ds.className = "desc";
        ds.textContent = x.desc || "";

        btn.appendChild(pill);
        btn.appendChild(nm);
        btn.appendChild(ds);

        if (!x.url){
          btn.classList.add("disabled");
          btn.onclick = () => {};
        } else {
          btn.onclick = () => window.open(x.url, "_blank", "noopener,noreferrer");
        }

        grid.appendChild(btn);
      });

      box.appendChild(title);
      box.appendChild(grid);
      app.appendChild(box);
    });
  }

  /********************************************************************
   * Login / Logout
   ********************************************************************/
  function doLogin(){
    const u = trim(document.getElementById("u").value);
    const p = document.getElementById("p").value || "";
    const firmDisplay = document.getElementById("firmName").value || "";
    const msg = document.getElementById("loginMsg");
    msg.className = "msg";
    msg.textContent = "";

    // Admin login
    if (norm(u) === norm(ADMIN_LOGIN.username) && p === ADMIN_LOGIN.password){
      setSession({
        username: "Poseidon",
        display: "Poseidon",
        roles: ["ADMIN"],
        mode: "ADMIN"
      });
      msg.className = "msg ok";
      msg.textContent = "Admin girişi başarılı.";
      showLogin(false);
      showAdmin(true);
      refreshTopbar();
      setPortalTitle(getSession());
      renderAdmin();
      return;
    }

    const db = loadCommittedDB();

    // Key User login (firma opsiyonel)
    const ku = (db.keyUsers || []).find(x => norm(x.username) === norm(u) && x.password === p);
    if (ku){
      if (ku.active === false){
        msg.className = "msg err";
        msg.textContent = "Bu Key User pasif durumdadır.";
        return;
      }

      setSession({
        username: ku.username,
        display: ku.display || ku.username,
        roles: ["KEYUSER"],
        mode: "KEY",
        isKeyUser: true
      });

      msg.className = "msg ok";
      msg.textContent = "Key User girişi başarılı.";
      selectedFirmK = "ALL";
      selectedCatK = "ALL";
      showLogin(false);
      showAdmin(false);
      showPortal(false);
      showKey(true);
      refreshTopbar();
      setPortalTitle(getSession());
      buildKeyFirmChips();
      buildKeyCatChips();
      renderKeyPortal();
      return;
    }

    // Normal user login
    const user = (db.users || []).find(x => norm(x.username) === norm(u) && x.password === p);

    if (!user){
      msg.className = "msg err";
      msg.textContent = "Hatalı kullanıcı adı veya şifre.";
      return;
    }

    if (user.active === false){
      msg.className = "msg err";
      msg.textContent = "Bu kullanıcı pasif durumdadır.";
      return;
    }

    const fd = trim(firmDisplay);
    if (!fd){
      msg.className = "msg err";
      msg.textContent = "Lütfen firma adını yazın.";
      return;
    }

    const firmKey = firmKeyFromInput(fd, db);
    const firmObj = (db.firms || []).find(f => f.key === firmKey);
    if (!firmObj || firmObj.active === false){
      msg.className = "msg err";
      msg.textContent = "Bu firma pasif veya tanımsız.";
      return;
    }

    const session = {
      username: user.username,
      display: user.display || user.username,
      roles: user.roles || [],
      firmDisplay: fd,
      firmKey: firmKey,
      mode: "PORTAL"
    };

    if (!firmAccessAllowed(session, firmKey, db)){
      msg.className = "msg err";
      msg.textContent = "Bu firmaya erişim için gerekli rol(ler) kullanıcıda yok.";
      return;
    }

    setSession(session);

    msg.className = "msg ok";
    msg.textContent = "Giriş başarılı.";
    selectedCat = "ALL";
    showLogin(false);
    showAdmin(false);
    showKey(false);
    showPortal(true);
    refreshTopbar();
    setPortalTitle(getSession());
    buildCategoryChips();
    renderPortal();
  }
  window.__doLogin = doLogin;

  function doLogout(){
    clearSession();
    selectedCat = "ALL";
    selectedFirmK = "ALL";
    selectedCatK = "ALL";

    document.getElementById("q").value = "";
    document.getElementById("chips").innerHTML = "";
    document.getElementById("portalApp").innerHTML = "";

    document.getElementById("kq").value = "";
    document.getElementById("kFirmChips").innerHTML = "";
    document.getElementById("kCatChips").innerHTML = "";
    document.getElementById("keyApp").innerHTML = "";

    showPortal(false);
    showKey(false);
    showAdmin(false);
    refreshTopbar();
    setPortalTitle(null);
    showLogin(true);
  }

  /********************************************************************
   * Admin helpers
   ********************************************************************/
  function genId(){
    return "r" + Math.random().toString(16).slice(2,10) + Date.now().toString(16).slice(-4);
  }

  function buildRoleCheckboxes(containerId, roles, prechecked){
    const box = document.getElementById(containerId);
    box.innerHTML = "";
    const checkedSet = new Set(prechecked || []);
    roles.forEach(r => {
      const lbl = document.createElement("label");
      lbl.className = "chk";
      const inp = document.createElement("input");
      inp.type = "checkbox";
      inp.value = r;
      inp.checked = checkedSet.has(r);
      lbl.appendChild(inp);
      const span = document.createElement("span");
      span.textContent = r;
      lbl.appendChild(span);
      box.appendChild(lbl);
    });
  }

  function getCheckedRoles(containerId){
    return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]`))
      .filter(x => x.checked)
      .map(x => x.value);
  }

  /********************************************************************
   * Admin render
   ********************************************************************/
  function renderAdmin(){
    const session = getSession();
    if (!session || session.mode !== "ADMIN") return;

    const wdb = loadWorkingDB();
    setWorkingDB(wdb);

    document.getElementById("pendingInfo").textContent =
      hasPendingChanges() ? "Taslak değişiklik var (Kaydet bekliyor)" : "Taslak değişiklik yok";

    // firmKey preview (edit değilse)
    const editingFirmKey = document.getElementById("firmEditingKey").value || "";
    if (!editingFirmKey){
      const fd = document.getElementById("firmDisplayIn").value || "";
      document.getElementById("firmKeyOut").value = firmKeyFromInput(fd, wdb) || "";
    }

    // selects
    fillFirmSelects(wdb);
    fillReportPick(wdb);
    fillMappingSelects(wdb);

    // active roles list for checkboxes
    const actRoles = activeRoles(wdb).sort();

    // USER ROLE BOX
    const editingUserKey = document.getElementById("userEditingKey").value || "";
    if (!editingUserKey){
      buildRoleCheckboxes("userRoleBox", actRoles, []);
    } else {
      const wu = (wdb.users||[]).find(x => norm(x.username) === norm(editingUserKey));
      buildRoleCheckboxes("userRoleBox", actRoles, (wu && wu.roles) ? wu.roles : []);
    }

    if (!document.getElementById("repEditingId").value){
      buildRoleCheckboxes("repRoleBox", actRoles, []);
    }

    // firm roles
    const firmKey = document.getElementById("firmSelForRoles").value || (wdb.firms[0] ? wdb.firms[0].key : "");
    const currentFirmRoles = (wdb.firmAccessRoles && wdb.firmAccessRoles[firmKey]) ? wdb.firmAccessRoles[firmKey] : [];
    buildRoleCheckboxes("firmRoleBox", actRoles, currentFirmRoles);

    // lists
    renderRoleList(wdb);
    renderFirmList(wdb);
    renderUserList(wdb);
    renderReportList(wdb);

    // KEY USER list (new)
    renderKeyUserList(wdb);

    refreshTopbar();
  }

  function fillFirmSelects(db){
    const firms = (db.firms || []).slice().sort((a,b)=>a.display.localeCompare(b.display));
    const repFirmSel = document.getElementById("repFirmSel");
    const firmSelForRoles = document.getElementById("firmSelForRoles");

    repFirmSel.innerHTML = "";
    firmSelForRoles.innerHTML = "";

    firms.forEach(f => {
      const o1 = document.createElement("option");
      o1.value = f.key;
      o1.textContent = `${f.display} (${f.key})`;
      repFirmSel.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = f.key;
      o2.textContent = `${f.display} (${f.key})`;
      firmSelForRoles.appendChild(o2);
    });
  }

  function fillReportPick(db){
    const sel = document.getElementById("repPickSel");
    sel.innerHTML = "";
    (db.reports || []).slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = `${r.name} (${r.firm}/${r.cat})`;
      sel.appendChild(opt);
    });
  }

  function fillMappingSelects(db){
    const firmSel = document.getElementById("mapFirmSel");
    const roleSel = document.getElementById("mapRoleSel");
    if (!firmSel || !roleSel) return;

    firmSel.innerHTML = "";
    roleSel.innerHTML = "";

    (db.firms || []).slice().sort((a,b)=>a.display.localeCompare(b.display)).forEach(f => {
      const o = document.createElement("option");
      o.value = f.key;
      o.textContent = `${f.display} (${f.key})`;
      firmSel.appendChild(o);
    });

    activeRoles(db).slice().sort().forEach(r => {
      const o = document.createElement("option");
      o.value = r;
      o.textContent = r;
      roleSel.appendChild(o);
    });
  }

  /********************************************************************
   * Render lists
   ********************************************************************/
  function renderRoleList(db){
    const list = document.getElementById("roleList");
    list.innerHTML = "";

    const roles = (db.roles || []).slice().sort((a,b)=>a.key.localeCompare(b.key));
    roles.forEach(r => {
      const row = document.createElement("div");
      row.className = "item";

      const active = r.active !== false;
      const pillClass = active ? "pill2" : "pill2 off";

      row.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(r.key)}</b>
          <span>${escapeHtml(r.desc || "")}</span>
        </div>
        <div class="pills">
          <span class="${pillClass}">${active ? "AKTİF" : "PASİF"}</span>
          <button class="btn2 ${active ? "warn" : "ok"}" type="button" data-act="${escapeHtml(r.key)}">${active ? "Pasif Yap" : "Aktif Yap"}</button>
          <button class="btn2 info" type="button" data-ren="${escapeHtml(r.key)}">Ad Değiştir</button>
          <button class="btn2 danger" type="button" data-del="${escapeHtml(r.key)}">Sil</button>
        </div>
      `;
      list.appendChild(row);
    });

    list.querySelectorAll("[data-act]").forEach(b => b.onclick = () => toggleRoleActive(b.getAttribute("data-act")));
    list.querySelectorAll("[data-ren]").forEach(b => b.onclick = () => renameRole(b.getAttribute("data-ren")));
    list.querySelectorAll("[data-del]").forEach(b => b.onclick = () => deleteRole(b.getAttribute("data-del")));
  }

  function renderFirmList(db){
    const list = document.getElementById("firmList");
    list.innerHTML = "";

    const far = db.firmAccessRoles || {};
    const rolesMeta = roleMetaMap(db);

    (db.firms || []).slice().sort((a,b)=>a.display.localeCompare(b.display)).forEach(f => {
      const req = Array.isArray(far[f.key]) ? far[f.key] : [`${f.key}_VIEW`];
      const pills = req.slice(0,4).map(rr => {
        const m = rolesMeta[rr];
        const off = m && m.active === false;
        return `<span class="pill2 ${off?"off":""}">${escapeHtml(rr)}</span>`;
      }).join("") + (req.length>4 ? `<span class="pill2">+${req.length-4}</span>` : "");

      const active = f.active !== false;
      const pillClass = active ? "pill2" : "pill2 off";

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(f.display)}</b>
          <span>Key: ${escapeHtml(f.key)} • Giriş Rol(leri): ${req.length}</span>
        </div>
        <div class="pills">
          ${pills}
          <span class="${pillClass}">${active ? "AKTİF" : "PASİF"}</span>
          <button class="btn2 info" type="button" data-fedit="${escapeHtml(f.key)}">Düzenle</button>
          <button class="btn2 ${active ? "warn" : "ok"}" type="button" data-fact="${escapeHtml(f.key)}">${active ? "Pasif Yap" : "Aktif Yap"}</button>
          <button class="btn2 danger" type="button" data-fdel="${escapeHtml(f.key)}">Sil</button>
        </div>
      `;
      list.appendChild(row);
    });

    list.querySelectorAll("[data-fedit]").forEach(b => b.onclick = () => startEditFirm(b.getAttribute("data-fedit")));
    list.querySelectorAll("[data-fact]").forEach(b => b.onclick = () => toggleFirmActive(b.getAttribute("data-fact")));
    list.querySelectorAll("[data-fdel]").forEach(b => b.onclick = () => deleteFirm(b.getAttribute("data-fdel")));
  }

  function renderUserList(db){
    const list = document.getElementById("userList");
    list.innerHTML = "";
    const meta = roleMetaMap(db);

    (db.users || []).slice().sort((a,b)=>a.username.localeCompare(b.username)).forEach(u => {
      const pills = (u.roles||[]).slice(0,4).map(rr => {
        const off = meta[rr] && meta[rr].active === false;
        return `<span class="pill2 ${off?"off":""}">${escapeHtml(rr)}</span>`;
      }).join("") + ((u.roles||[]).length>4 ? `<span class="pill2">+${(u.roles||[]).length-4}</span>` : "");

      const active = u.active !== false;
      const pillClass = active ? "pill2" : "pill2 off";

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(u.username)} • ${escapeHtml(u.display || "")}</b>
          <span>${escapeHtml((u.email||""))}</span>
          <span>${escapeHtml((u.roles||[]).join(", ") || "-")}</span>
        </div>
        <div class="pills">
          ${pills}
          <span class="${pillClass}">${active ? "AKTİF" : "PASİF"}</span>
          <button class="btn2 info" type="button" data-uedit="${escapeHtml(u.username)}">Düzenle</button>
          <button class="btn2 ${active ? "warn" : "ok"}" type="button" data-uact="${escapeHtml(u.username)}">${active ? "Pasif Yap" : "Aktif Yap"}</button>
          <button class="btn2 danger" type="button" data-udel="${escapeHtml(u.username)}">Sil</button>
        </div>
      `;
      list.appendChild(row);
    });

    list.querySelectorAll("[data-uedit]").forEach(b => b.onclick = () => startEditUser(b.getAttribute("data-uedit")));
    list.querySelectorAll("[data-uact]").forEach(b => b.onclick = () => toggleUserActive(b.getAttribute("data-uact")));
    list.querySelectorAll("[data-udel]").forEach(b => b.onclick = () => deleteUser(b.getAttribute("data-udel")));
  }

  function renderReportList(db){
    const list = document.getElementById("reportList");
    list.innerHTML = "";
    const meta = roleMetaMap(db);

    const reps = (db.reports || []).slice().sort((a,b)=> (a.firm+a.cat+a.name).localeCompare(b.firm+b.cat+b.name));
    reps.forEach(r => {
      const roles = (r.acl && Array.isArray(r.acl.allowRoles)) ? r.acl.allowRoles : [];
      const pills = roles.slice(0,4).map(rr => {
        const off = meta[rr] && meta[rr].active === false;
        return `<span class="pill2 ${off?"off":""}">${escapeHtml(rr)}</span>`;
      }).join("") + (roles.length>4 ? `<span class="pill2">+${roles.length-4}</span>` : "");

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(r.name)}</b>
          <span>${escapeHtml(r.firm)} • ${escapeHtml(r.cat)} • ${r.url ? "URL var" : "URL yok"}</span>
        </div>
        <div class="pills">
          <span class="pill2">${escapeHtml(r.firm)}</span>
          <span class="pill2">${escapeHtml(r.cat)}</span>
          ${pills}
        </div>
      `;
      list.appendChild(row);
    });
  }

  /********************************************************************
   * Admin Actions: Roles
   ********************************************************************/
  function addRole(){
    const wdb = loadWorkingDB();
    const keyRaw = document.getElementById("roleNewKey").value;
    const desc = trim(document.getElementById("roleNewDesc").value);
    const key = normalizeRoleKey(keyRaw);

    if (!key){ setMsg("roleMsg","Rol kodu boş olamaz.","err"); return; }
    if (!wdb.roles) wdb.roles = [];
    if (wdb.roles.some(r => r.key === key)){ setMsg("roleMsg","Bu rol zaten var.","warn"); return; }

    wdb.roles.push({ key, desc, active:true });
    setWorkingDB(wdb);

    document.getElementById("roleNewKey").value = "";
    document.getElementById("roleNewDesc").value = "";

    setMsg("roleMsg",`Rol eklendi: ${key}`,"ok");
    renderAdmin();
  }

  function toggleRoleActive(roleKey){
    const wdb = loadWorkingDB();
    const r = (wdb.roles||[]).find(x => x.key === roleKey);
    if (!r){ setMsg("roleMsg","Rol bulunamadı.","err"); return; }
    r.active = (r.active === false) ? true : false;
    setWorkingDB(wdb);
    setMsg("roleMsg",`${roleKey} => ${r.active ? "AKTİF" : "PASİF"}`,"info");
    renderAdmin();
  }

  function renameRole(roleKey){
    const wdb = loadWorkingDB();
    const r = (wdb.roles||[]).find(x => x.key === roleKey);
    if (!r){ setMsg("roleMsg","Rol bulunamadı.","err"); return; }

    const newKey = normalizeRoleKey(prompt("Yeni rol kodu:", roleKey) || "");
    if (!newKey || newKey === roleKey) return;
    if ((wdb.roles||[]).some(x => x.key === newKey)){
      setMsg("roleMsg","Bu rol kodu zaten var.","err"); return;
    }

    r.key = newKey;

    (wdb.users||[]).forEach(u => { u.roles = (u.roles||[]).map(x => x === roleKey ? newKey : x); });

    (wdb.reports||[]).forEach(rep => {
      if (rep.acl && Array.isArray(rep.acl.allowRoles)){
        rep.acl.allowRoles = rep.acl.allowRoles.map(x => x === roleKey ? newKey : x);
      }
    });

    wdb.firmAccessRoles = wdb.firmAccessRoles || {};
    Object.keys(wdb.firmAccessRoles).forEach(fk => {
      wdb.firmAccessRoles[fk] = (wdb.firmAccessRoles[fk]||[]).map(x => x === roleKey ? newKey : x);
    });

    setWorkingDB(wdb);
    setMsg("roleMsg",`Rol adı değişti: ${roleKey} -> ${newKey}`,"ok");
    renderAdmin();
  }

  function roleUsageCount(db, roleKey){
    let users = 0, reports = 0, firms = 0;
    (db.users||[]).forEach(u => { if ((u.roles||[]).includes(roleKey)) users++; });
    (db.reports||[]).forEach(r => { if (r.acl && (r.acl.allowRoles||[]).includes(roleKey)) reports++; });
    (db.firmAccessRoles ? Object.values(db.firmAccessRoles) : []).forEach(arr => {
      if (Array.isArray(arr) && arr.includes(roleKey)) firms++;
    });
    return {users, reports, firms};
  }

  function deleteRole(roleKey){
    const wdb = loadWorkingDB();
    const usage = roleUsageCount(wdb, roleKey);

    const proceed = confirm(
      `Rol silinsin mi?\n\n${roleKey}\n\nKullanım:\n- Kullanıcı: ${usage.users}\n- Rapor: ${usage.reports}\n- Firma: ${usage.firms}\n\nSilersen bu atamalar otomatik temizlenir.`
    );
    if (!proceed) return;

    wdb.roles = (wdb.roles||[]).filter(r => r.key !== roleKey);
    (wdb.users||[]).forEach(u => { u.roles = (u.roles||[]).filter(x => x !== roleKey); });
    (wdb.reports||[]).forEach(rep => {
      if (rep.acl && Array.isArray(rep.acl.allowRoles)){
        rep.acl.allowRoles = rep.acl.allowRoles.filter(x => x !== roleKey);
      }
    });

    wdb.firmAccessRoles = wdb.firmAccessRoles || {};
    Object.keys(wdb.firmAccessRoles).forEach(fk => {
      wdb.firmAccessRoles[fk] = (wdb.firmAccessRoles[fk]||[]).filter(x => x !== roleKey);
    });

    setWorkingDB(wdb);
    setMsg("roleMsg",`Rol silindi: ${roleKey}`,"ok");
    renderAdmin();
  }

  function normalizeRoles(){
    const wdb = loadWorkingDB();
    if (!wdb.roles) wdb.roles = [];
    wdb.roles.forEach(r => { r.key = normalizeRoleKey(r.key); });
    const seen = new Set();
    wdb.roles = wdb.roles.filter(r => (seen.has(r.key) ? false : (seen.add(r.key), true)));
    setWorkingDB(wdb);
    setMsg("roleMsg","Rol kodları normalize edildi.","ok");
    renderAdmin();
  }

  /********************************************************************
   * Admin Actions: Firms (CRUD)
   ********************************************************************/
  function onFirmDisplayInput(){
    const wdb = loadWorkingDB();
    const editingKey = document.getElementById("firmEditingKey").value || "";
    if (editingKey) return;
    document.getElementById("firmKeyOut").value =
      firmKeyFromInput(document.getElementById("firmDisplayIn").value, wdb) || "";
  }

  function clearFirmForm(){
    document.getElementById("firmEditingKey").value = "";
    document.getElementById("firmDisplayIn").value = "";
    document.getElementById("firmKeyOut").value = "";
    document.getElementById("addFirmBtn").style.display = "inline-block";
    document.getElementById("updateFirmBtn").style.display = "none";
    document.getElementById("cancelFirmEditBtn").style.display = "none";
  }

  function startEditFirm(firmKey){
    const wdb = loadWorkingDB();
    const f = (wdb.firms||[]).find(x => x.key === firmKey);
    if (!f){ setMsg("firmMsg","Firma bulunamadı.","err"); return; }

    document.getElementById("firmEditingKey").value = f.key;
    document.getElementById("firmDisplayIn").value = f.display;
    document.getElementById("firmKeyOut").value = f.key;

    document.getElementById("addFirmBtn").style.display = "none";
    document.getElementById("updateFirmBtn").style.display = "inline-block";
    document.getElementById("cancelFirmEditBtn").style.display = "inline-block";

    setMsg("firmMsg",`Düzenleme modu: ${f.display} (${f.key})`,"info");
  }

  function updateFirm(){
    const wdb = loadWorkingDB();
    const key = document.getElementById("firmEditingKey").value || "";
    if (!key){ setMsg("firmMsg","Güncellenecek firma seçilmedi.","err"); return; }

    const f = (wdb.firms||[]).find(x => x.key === key);
    if (!f){ setMsg("firmMsg","Firma bulunamadı.","err"); return; }

    const newDisplay = trim(document.getElementById("firmDisplayIn").value);
    if (!newDisplay){ setMsg("firmMsg","Firma adı boş olamaz.","err"); return; }

    f.display = newDisplay;

    const aliasKey = normalizeFirmNameForAlias(newDisplay);
    wdb.aliases = wdb.aliases || {};
    wdb.aliases[aliasKey] = f.key;

    setWorkingDB(wdb);
    setMsg("firmMsg",`Firma güncellendi: ${f.display} (${f.key})`,"ok");
    clearFirmForm();
    renderAdmin();
  }

  function addFirm(){
    const wdb = loadWorkingDB();
    const display = trim(document.getElementById("firmDisplayIn").value);
    if (!display){ setMsg("firmMsg","Firma adı boş olamaz.","err"); return; }

    const key = firmKeyFromInput(display, wdb) || firmKeyAuto(display);
    const exists = (wdb.firms || []).some(f => f.key === key);
    if (exists){ setMsg("firmMsg",`Bu firma key zaten var: ${key}`,"warn"); return; }

    wdb.firms = wdb.firms || [];
    wdb.firms.push({ key, display, active:true });

    const aliasKey = normalizeFirmNameForAlias(display);
    wdb.aliases = wdb.aliases || {};
    wdb.aliases[aliasKey] = key;

    wdb.firmAccessRoles = wdb.firmAccessRoles || {};
    const roleSet = new Set((wdb.roles||[]).map(r => r.key));
    const defaultRole = `${key}_VIEW`;
    if (roleSet.has(defaultRole)) wdb.firmAccessRoles[key] = [defaultRole];
    else wdb.firmAccessRoles[key] = [];

    setWorkingDB(wdb);
    setMsg("firmMsg",`Firma eklendi: ${display} (${key})`,"ok");
    clearFirmForm();
    renderAdmin();
  }

  function addAliasForFirmInput(){
    const wdb = loadWorkingDB();
    const display = trim(document.getElementById("firmDisplayIn").value);
    if (!display){ setMsg("firmMsg","Alias eklemek için önce firma yaz.","err"); return; }
    const firmKey = (document.getElementById("firmEditingKey").value || "") || firmKeyFromInput(display, wdb) || firmKeyAuto(display);
    const aliasKey = normalizeFirmNameForAlias(display);
    wdb.aliases = wdb.aliases || {};
    wdb.aliases[aliasKey] = firmKey;
    setWorkingDB(wdb);
    setMsg("firmMsg",`Alias eklendi: "${aliasKey}" -> ${firmKey}`,"ok");
    renderAdmin();
  }

  function loadFirmRoles(){
    const wdb = loadWorkingDB();
    const fk = document.getElementById("firmSelForRoles").value;
    const actRoles = activeRoles(wdb).sort();
    const current = (wdb.firmAccessRoles && wdb.firmAccessRoles[fk]) ? wdb.firmAccessRoles[fk] : [];
    buildRoleCheckboxes("firmRoleBox", actRoles, current);
  }

  function saveFirmRoles(){
    const wdb = loadWorkingDB();
    const fk = document.getElementById("firmSelForRoles").value;
    const roles = getCheckedRoles("firmRoleBox");
    wdb.firmAccessRoles = wdb.firmAccessRoles || {};
    wdb.firmAccessRoles[fk] = roles;
    setWorkingDB(wdb);
    setMsg("firmRoleMsg",`Firma roller güncellendi (${fk}).`,"ok");
    renderAdmin();
  }

  function clearFirmRoles(){
    const wdb = loadWorkingDB();
    const fk = document.getElementById("firmSelForRoles").value;
    wdb.firmAccessRoles = wdb.firmAccessRoles || {};
    wdb.firmAccessRoles[fk] = [];
    setWorkingDB(wdb);
    setMsg("firmRoleMsg",`Firma rol listesi temizlendi (${fk}).`,"ok");
    renderAdmin();
  }

  function toggleFirmActive(firmKey){
    const wdb = loadWorkingDB();
    const f = (wdb.firms||[]).find(x => x.key === firmKey);
    if (!f){ setMsg("firmMsg","Firma bulunamadı.","err"); return; }
    f.active = (f.active === false) ? true : false;
    setWorkingDB(wdb);
    setMsg("firmMsg",`${firmKey} => ${f.active ? "AKTİF" : "PASİF"}`,"info");
    renderAdmin();
  }

  function deleteFirm(firmKey){
    const wdb = loadWorkingDB();
    const f = (wdb.firms||[]).find(x => x.key === firmKey);
    if (!f){ setMsg("firmMsg","Firma bulunamadı.","err"); return; }

    const repCount = (wdb.reports||[]).filter(r => r.firm === firmKey).length;
    const ok = confirm(
      `Firma silinsin mi?\n\n${f.display} (${f.key})\n\nEtkiler:\n- ${repCount} rapor silinecek\n- Firma giriş rol tanımı silinecek\n- Alias kayıtları temizlenecek`
    );
    if (!ok) return;

    wdb.firms = (wdb.firms||[]).filter(x => x.key !== firmKey);
    wdb.reports = (wdb.reports||[]).filter(r => r.firm !== firmKey);

    wdb.firmAccessRoles = wdb.firmAccessRoles || {};
    delete wdb.firmAccessRoles[firmKey];

    wdb.aliases = wdb.aliases || {};
    Object.keys(wdb.aliases).forEach(a => {
      if (wdb.aliases[a] === firmKey) delete wdb.aliases[a];
    });

    setWorkingDB(wdb);
    setMsg("firmMsg",`Firma silindi: ${firmKey}`,"ok");
    renderAdmin();
  }

  /********************************************************************
   * Admin Actions: Users (CRUD + edit)
   ********************************************************************/
  function clearUserForm(){
    document.getElementById("userEditingKey").value = "";
    document.getElementById("newUserU").value = "";
    document.getElementById("newUserP").value = "";
    document.getElementById("newUserD").value = "";
    document.getElementById("newUserE").value = "";

    document.getElementById("newUserU").disabled = false;
    document.getElementById("addUserBtn").style.display = "inline-block";
    document.getElementById("updateUserBtn").style.display = "none";
    document.getElementById("resetUserPwdBtn").style.display = "none";
    document.getElementById("cancelUserEditBtn").style.display = "none";

    const wdb = loadWorkingDB();
    buildRoleCheckboxes("userRoleBox", activeRoles(wdb).sort(), []);
  }

  function startEditUser(username){
    const wdb = loadWorkingDB();
    const u = (wdb.users||[]).find(x => norm(x.username) === norm(username));
    if (!u){ setMsg("userMsg","Kullanıcı bulunamadı.","err"); return; }
    if (norm(u.username) === norm(ADMIN_LOGIN.username)){
      setMsg("userMsg","Admin kullanıcısı düzenlenemez.","err");
      return;
    }

    document.getElementById("userEditingKey").value = u.username;
    document.getElementById("newUserU").value = u.username;
    document.getElementById("newUserP").value = "";
    document.getElementById("newUserD").value = u.display || "";
    document.getElementById("newUserE").value = u.email || "";

    document.getElementById("newUserU").disabled = true;

    document.getElementById("addUserBtn").style.display = "none";
    document.getElementById("updateUserBtn").style.display = "inline-block";
    document.getElementById("resetUserPwdBtn").style.display = "inline-block";
    document.getElementById("cancelUserEditBtn").style.display = "inline-block";

    buildRoleCheckboxes("userRoleBox", activeRoles(wdb).sort(), u.roles || []);
    setMsg("userMsg",`Düzenleme modu: ${u.username}`,"info");
  }

  function addUser(){
    const wdb = loadWorkingDB();
    const username = trim(document.getElementById("newUserU").value);
    const password = document.getElementById("newUserP").value || "";
    const display = trim(document.getElementById("newUserD").value);
    const email = trim(document.getElementById("newUserE").value);
    const roles = getCheckedRoles("userRoleBox");

    if (!username || !password){ setMsg("userMsg","Kullanıcı adı ve şifre zorunlu.","err"); return; }
    if (norm(username) === norm(ADMIN_LOGIN.username)){ setMsg("userMsg","Bu kullanıcı adı Admin için ayrılmış.","err"); return; }
    if ((wdb.keyUsers||[]).some(x => norm(x.username) === norm(username))){ setMsg("userMsg","Bu kullanıcı adı Key User olarak zaten var.","err"); return; }

    const exists = (wdb.users || []).some(u => norm(u.username) === norm(username));
    if (exists){ setMsg("userMsg","Bu kullanıcı adı zaten var.","warn"); return; }
    if (!roles.length){ setMsg("userMsg","En az 1 rol seçilmelidir.","err"); return; }

    wdb.users = wdb.users || [];
    wdb.users.push({ username, password, display, email, roles, active:true });

    setWorkingDB(wdb);
    setMsg("userMsg",`Kullanıcı eklendi: ${username}`,"ok");
    clearUserForm();
    renderAdmin();
  }

  function updateUser(){
    const wdb = loadWorkingDB();
    const editing = document.getElementById("userEditingKey").value || "";
    if (!editing){ setMsg("userMsg","Güncellenecek kullanıcı seçilmedi.","err"); return; }

    const u = (wdb.users||[]).find(x => norm(x.username) === norm(editing));
    if (!u){ setMsg("userMsg","Kullanıcı bulunamadı.","err"); return; }

    const display = trim(document.getElementById("newUserD").value);
    const email = trim(document.getElementById("newUserE").value);
    const roles = getCheckedRoles("userRoleBox");

    if (!roles.length){ setMsg("userMsg","En az 1 rol seçilmelidir.","err"); return; }

    u.display = display;
    u.email = email;
    u.roles = roles;

    setWorkingDB(wdb);
    setMsg("userMsg",`Kullanıcı güncellendi: ${u.username}`,"ok");
    clearUserForm();
    renderAdmin();
  }

  function resetUserPassword(){
    const wdb = loadWorkingDB();
    const editing = document.getElementById("userEditingKey").value || "";
    if (!editing){ setMsg("userMsg","Şifre sıfırlamak için kullanıcı seç.","err"); return; }

    const u = (wdb.users||[]).find(x => norm(x.username) === norm(editing));
    if (!u){ setMsg("userMsg","Kullanıcı bulunamadı.","err"); return; }

    const newPwd = document.getElementById("newUserP").value || "";
    if (!newPwd){ setMsg("userMsg","Yeni şifre alanını doldur.","err"); return; }

    u.password = newPwd;
    setWorkingDB(wdb);
    setMsg("userMsg","Şifre güncellendi (taslak).","ok");
    document.getElementById("newUserP").value = "";
    renderAdmin();
  }

  function toggleUserActive(username){
    const wdb = loadWorkingDB();
    const u = (wdb.users||[]).find(x => norm(x.username) === norm(username));
    if (!u){ setMsg("userMsg","Kullanıcı bulunamadı.","err"); return; }
    if (norm(u.username) === norm(ADMIN_LOGIN.username)){
      setMsg("userMsg","Admin kullanıcısı değiştirilemez.","err");
      return;
    }
    u.active = (u.active === false) ? true : false;
    setWorkingDB(wdb);
    setMsg("userMsg",`${u.username} => ${u.active ? "AKTİF" : "PASİF"}`,"info");
    renderAdmin();
  }

  function deleteUser(username){
    const wdb = loadWorkingDB();
    const u = (wdb.users||[]).find(x => norm(x.username) === norm(username));
    if (!u){ setMsg("userMsg","Kullanıcı bulunamadı.","err"); return; }
    if (norm(u.username) === norm(ADMIN_LOGIN.username)){
      setMsg("userMsg","Admin kullanıcısı silinemez.","err");
      return;
    }
    const ok = confirm(`Kullanıcı silinsin mi?\n\n${u.username} • ${u.display || ""}`);
    if (!ok) return;

    wdb.users = (wdb.users||[]).filter(x => norm(x.username) !== norm(username));
    setWorkingDB(wdb);
    setMsg("userMsg",`Kullanıcı silindi: ${username}`,"ok");
    if ((document.getElementById("userEditingKey").value||"") && norm(document.getElementById("userEditingKey").value) === norm(username)){
      clearUserForm();
    }
    renderAdmin();
  }

  /********************************************************************
   * Admin Actions: Reports CRUD
   ********************************************************************/
  function clearReportForm(){
    document.getElementById("repEditingId").value = "";
    document.getElementById("repCat").value = "";
    document.getElementById("repName").value = "";
    document.getElementById("repDesc").value = "";
    document.getElementById("repUrl").value = "";
    setMsg("repMsg","Form temizlendi (yeni rapor).","info");

    const wdb = loadWorkingDB();
    buildRoleCheckboxes("repRoleBox", activeRoles(wdb).sort(), []);
    renderAdmin();
  }

  function loadPickedReportIntoForm(){
    const wdb = loadWorkingDB();
    const id = document.getElementById("repPickSel").value;
    const rep = (wdb.reports||[]).find(r => r.id === id);
    if (!rep){ setMsg("repMsg","Rapor bulunamadı.","err"); return; }

    document.getElementById("repEditingId").value = rep.id;
    document.getElementById("repFirmSel").value = rep.firm;
    document.getElementById("repCat").value = rep.cat || "";
    document.getElementById("repName").value = rep.name || "";
    document.getElementById("repDesc").value = rep.desc || "";
    document.getElementById("repUrl").value = rep.url || "";

    const actRoles = activeRoles(wdb).sort();
    const allow = (rep.acl && Array.isArray(rep.acl.allowRoles)) ? rep.acl.allowRoles : [];
    buildRoleCheckboxes("repRoleBox", actRoles, allow);

    setMsg("repMsg","Rapor yüklendi. Düzenleyip Kaydet'e basabilirsin.","ok");
  }

  function deletePickedReport(){
    const wdb = loadWorkingDB();
    const id = document.getElementById("repPickSel").value;
    const rep = (wdb.reports||[]).find(r => r.id === id);
    if (!rep){ setMsg("repMsg","Rapor bulunamadı.","err"); return; }

    const ok = confirm(`Rapor silinsin mi?\n\n${rep.name}\n(${rep.firm}/${rep.cat})`);
    if (!ok) return;

    wdb.reports = (wdb.reports||[]).filter(r => r.id !== id);
    setWorkingDB(wdb);
    setMsg("repMsg","Rapor silindi.","ok");
    clearReportForm();
    renderAdmin();
  }

  function upsertReport(){
    const wdb = loadWorkingDB();

    const editingId = document.getElementById("repEditingId").value || "";
    const firm = document.getElementById("repFirmSel").value;
    const cat  = trim(document.getElementById("repCat").value);
    const name = trim(document.getElementById("repName").value);
    const desc = trim(document.getElementById("repDesc").value);
    const url  = trim(document.getElementById("repUrl").value);
    const roles = getCheckedRoles("repRoleBox");

    if (!firm || !cat || !name){
      setMsg("repMsg","Firma, kategori ve rapor adı zorunlu.","err"); return;
    }
    if (!roles.length){
      setMsg("repMsg","Bu rapor için en az 1 rol seç.","err"); return;
    }

    wdb.reports = wdb.reports || [];

    if (editingId){
      const rep = wdb.reports.find(r => r.id === editingId);
      if (!rep){ setMsg("repMsg","Güncellenecek rapor bulunamadı.","err"); return; }

      rep.firm = firm;
      rep.cat = cat;
      rep.name = name;
      rep.desc = desc;
      rep.url = url;
      rep.acl = rep.acl || {};
      rep.acl.allowRoles = roles;

      setWorkingDB(wdb);
      setMsg("repMsg","Rapor güncellendi.","ok");
      renderAdmin();
      return;
    }

    wdb.reports.push({
      id: genId(),
      firm, cat, name, url, desc,
      acl: { allowRoles: roles }
    });

    setWorkingDB(wdb);
    setMsg("repMsg","Rapor eklendi.","ok");
    clearReportForm();
    renderAdmin();
  }

  /********************************************************************
   * 6) Firmaya & Role Rapor Tanımlama (bulk mapping)
   ********************************************************************/
  function loadFirmRoleReports(){
    const wdb = loadWorkingDB();
    const firmKey = document.getElementById("mapFirmSel").value;
    const roleKey = document.getElementById("mapRoleSel").value;

    const list = document.getElementById("firmRoleReportList");
    list.innerHTML = "";

    const reps = (wdb.reports || []).filter(r => r.firm === firmKey).slice()
      .sort((a,b)=> (a.cat+a.name).localeCompare(b.cat+b.name));

    if (!reps.length){
      list.innerHTML = `<div style="color:rgba(255,255,255,.55);font-size:12px;">Bu firmada rapor yok.</div>`;
      return;
    }

    reps.forEach(r => {
      const allow = (r.acl && Array.isArray(r.acl.allowRoles)) ? r.acl.allowRoles : [];
      const checked = allow.includes(roleKey);

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(r.name)}</b>
          <span>${escapeHtml(r.cat)} • ${r.url ? "URL var" : "URL yok"}</span>
        </div>
        <div class="pills">
          <label class="chk" style="margin:0;">
            <input type="checkbox" data-maprep="${escapeHtml(r.id)}" ${checked ? "checked":""}/>
            <span>${checked ? "Açık" : "Kapalı"}</span>
          </label>
        </div>
      `;
      list.appendChild(row);
    });

    setMsg("mapMsg",`Listelendi: ${firmKey} / ${roleKey}`,"info");
  }

  function applyFirmRoleReports(){
    const wdb = loadWorkingDB();
    const firmKey = document.getElementById("mapFirmSel").value;
    const roleKey = document.getElementById("mapRoleSel").value;

    const checks = Array.from(document.querySelectorAll(`#firmRoleReportList input[type="checkbox"][data-maprep]`));
    if (!checks.length){ setMsg("mapMsg","Uygulanacak rapor listesi yok.","warn"); return; }

    const chosen = new Set(checks.filter(x=>x.checked).map(x=>x.getAttribute("data-maprep")));

    (wdb.reports || []).forEach(r => {
      if (r.firm !== firmKey) return;
      r.acl = r.acl || {};
      r.acl.allowRoles = Array.isArray(r.acl.allowRoles) ? r.acl.allowRoles : [];

      const has = r.acl.allowRoles.includes(roleKey);
      const want = chosen.has(r.id);

      if (want && !has) r.acl.allowRoles.push(roleKey);
      if (!want && has) r.acl.allowRoles = r.acl.allowRoles.filter(x=>x !== roleKey);
    });

    setWorkingDB(wdb);
    setMsg("mapMsg","Seçimler uygulandı (taslak). Sağ üst Kaydet ile kalıcılaştır.","ok");
    renderAdmin();
  }

  function clearRoleFromFirmReports(){
    const wdb = loadWorkingDB();
    const firmKey = document.getElementById("mapFirmSel").value;
    const roleKey = document.getElementById("mapRoleSel").value;

    const ok = confirm(`Bu rol, bu firmadaki tüm raporlardan kaldırılsın mı?\n\nFirma: ${firmKey}\nRol: ${roleKey}`);
    if (!ok) return;

    (wdb.reports || []).forEach(r => {
      if (r.firm !== firmKey) return;
      if (r.acl && Array.isArray(r.acl.allowRoles)){
        r.acl.allowRoles = r.acl.allowRoles.filter(x => x !== roleKey);
      }
    });

    setWorkingDB(wdb);
    setMsg("mapMsg","Rol tüm raporlardan kaldırıldı (taslak).","ok");
    renderAdmin();
  }

  /********************************************************************
   * Admin Actions: KEY USERS (NEW)
   ********************************************************************/
  function clearKeyUserForm(){
    document.getElementById("keyUserEditingKey").value = "";
    document.getElementById("keyUserU").value = "";
    document.getElementById("keyUserP").value = "";
    document.getElementById("keyUserD").value = "";
    document.getElementById("keyUserE").value = "";

    document.getElementById("keyUserU").disabled = false;
    document.getElementById("addKeyUserBtn").style.display = "inline-block";
    document.getElementById("updateKeyUserBtn").style.display = "none";
    document.getElementById("resetKeyUserPwdBtn").style.display = "none";
    document.getElementById("cancelKeyUserEditBtn").style.display = "none";
  }

  function renderKeyUserList(db){
    const list = document.getElementById("keyUserList");
    if (!list) return;
    list.innerHTML = "";

    (db.keyUsers || []).slice().sort((a,b)=>a.username.localeCompare(b.username)).forEach(u => {
      const active = u.active !== false;
      const pillClass = active ? "pill2" : "pill2 off";

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(u.username)} • ${escapeHtml(u.display || "")}</b>
          <span>${escapeHtml(u.email || "")}</span>
        </div>
        <div class="pills">
          <span class="pill2">KEY USER</span>
          <span class="${pillClass}">${active ? "AKTİF" : "PASİF"}</span>
          <button class="btn2 info" type="button" data-kedit="${escapeHtml(u.username)}">Düzenle</button>
          <button class="btn2 ${active ? "warn" : "ok"}" type="button" data-kact="${escapeHtml(u.username)}">${active ? "Pasif Yap" : "Aktif Yap"}</button>
          <button class="btn2 danger" type="button" data-kdel="${escapeHtml(u.username)}">Sil</button>
        </div>
      `;
      list.appendChild(row);
    });

    list.querySelectorAll("[data-kedit]").forEach(b => b.onclick = () => startEditKeyUser(b.getAttribute("data-kedit")));
    list.querySelectorAll("[data-kact]").forEach(b => b.onclick = () => toggleKeyUserActive(b.getAttribute("data-kact")));
    list.querySelectorAll("[data-kdel]").forEach(b => b.onclick = () => deleteKeyUser(b.getAttribute("data-kdel")));
  }

  function addKeyUser(){
    const wdb = loadWorkingDB();
    wdb.keyUsers = wdb.keyUsers || [];

    const username = trim(document.getElementById("keyUserU").value);
    const password = document.getElementById("keyUserP").value || "";
    const display  = trim(document.getElementById("keyUserD").value);
    const email    = trim(document.getElementById("keyUserE").value);

    if (!username || !password){
      setMsg("keyUserMsg","Kullanıcı adı ve şifre zorunlu.","err"); return;
    }
    if (norm(username) === norm(ADMIN_LOGIN.username)){
      setMsg("keyUserMsg","Bu kullanıcı adı Admin için ayrılmış.","err"); return;
    }
    if ((wdb.users||[]).some(u => norm(u.username) === norm(username))){
      setMsg("keyUserMsg","Bu kullanıcı adı normal kullanıcı olarak zaten var.","err"); return;
    }
    if (wdb.keyUsers.some(u => norm(u.username) === norm(username))){
      setMsg("keyUserMsg","Bu Key User zaten var.","warn"); return;
    }

    wdb.keyUsers.push({ username, password, display, email, active:true });
    setWorkingDB(wdb);
    setMsg("keyUserMsg",`Key User eklendi: ${username}`,"ok");
    clearKeyUserForm();
    renderAdmin();
  }

  function startEditKeyUser(username){
    const wdb = loadWorkingDB();
    const u = (wdb.keyUsers||[]).find(x => norm(x.username) === norm(username));
    if (!u){ setMsg("keyUserMsg","Key User bulunamadı.","err"); return; }

    document.getElementById("keyUserEditingKey").value = u.username;
    document.getElementById("keyUserU").value = u.username;
    document.getElementById("keyUserP").value = "";
    document.getElementById("keyUserD").value = u.display || "";
    document.getElementById("keyUserE").value = u.email || "";

    document.getElementById("keyUserU").disabled = true;
    document.getElementById("addKeyUserBtn").style.display = "none";
    document.getElementById("updateKeyUserBtn").style.display = "inline-block";
    document.getElementById("resetKeyUserPwdBtn").style.display = "inline-block";
    document.getElementById("cancelKeyUserEditBtn").style.display = "inline-block";

    setMsg("keyUserMsg",`Düzenleme modu: ${u.username}`,"info");
  }

  function updateKeyUser(){
    const wdb = loadWorkingDB();
    const editing = document.getElementById("keyUserEditingKey").value || "";
    if (!editing){ setMsg("keyUserMsg","Güncellenecek Key User seçilmedi.","err"); return; }

    const u = (wdb.keyUsers||[]).find(x => norm(x.username) === norm(editing));
    if (!u){ setMsg("keyUserMsg","Key User bulunamadı.","err"); return; }

    u.display = trim(document.getElementById("keyUserD").value);
    u.email   = trim(document.getElementById("keyUserE").value);

    setWorkingDB(wdb);
    setMsg("keyUserMsg",`Key User güncellendi: ${u.username}`,"ok");
    clearKeyUserForm();
    renderAdmin();
  }

  function resetKeyUserPassword(){
    const wdb = loadWorkingDB();
    const editing = document.getElementById("keyUserEditingKey").value || "";
    if (!editing){ setMsg("keyUserMsg","Şifre sıfırlamak için Key User seç.","err"); return; }

    const u = (wdb.keyUsers||[]).find(x => norm(x.username) === norm(editing));
    if (!u){ setMsg("keyUserMsg","Key User bulunamadı.","err"); return; }

    const newPwd = document.getElementById("keyUserP").value || "";
    if (!newPwd){ setMsg("keyUserMsg","Yeni şifre alanını doldur.","err"); return; }

    u.password = newPwd;
    setWorkingDB(wdb);
    setMsg("keyUserMsg","Key User şifresi güncellendi (taslak).","ok");
    document.getElementById("keyUserP").value = "";
    renderAdmin();
  }

  function toggleKeyUserActive(username){
    const wdb = loadWorkingDB();
    const u = (wdb.keyUsers||[]).find(x => norm(x.username) === norm(username));
    if (!u){ setMsg("keyUserMsg","Key User bulunamadı.","err"); return; }
    u.active = (u.active === false) ? true : false;
    setWorkingDB(wdb);
    setMsg("keyUserMsg",`${u.username} => ${u.active ? "AKTİF" : "PASİF"}`,"info");
    renderAdmin();
  }

  function deleteKeyUser(username){
    const wdb = loadWorkingDB();
    const u = (wdb.keyUsers||[]).find(x => norm(x.username) === norm(username));
    if (!u){ setMsg("keyUserMsg","Key User bulunamadı.","err"); return; }

    const ok = confirm(`Key User silinsin mi?\n\n${u.username} • ${u.display || ""}`);
    if (!ok) return;

    wdb.keyUsers = (wdb.keyUsers||[]).filter(x => norm(x.username) !== norm(username));
    setWorkingDB(wdb);
    setMsg("keyUserMsg",`Key User silindi: ${username}`,"ok");

    if ((document.getElementById("keyUserEditingKey").value||"") && norm(document.getElementById("keyUserEditingKey").value) === norm(username)){
      clearKeyUserForm();
    }
    renderAdmin();
  }

  /********************************************************************
   * Save flow
   ********************************************************************/
  function discardDraft(){
    discardWorking();
    setMsg("flowMsg","Taslak değişiklikler atıldı.","ok");
    renderAdmin();
  }

  function goPortalFromAdmin(){
    setMsg("flowMsg","Portal’a geçildi. Kaydet butonu (varsa) sağ üstte.","ok");
    showAdmin(false);

    const session = getSession();
    refreshTopbar();
    setPortalTitle(session);

    if (session && session.mode === "KEY"){
      showKey(true);
      buildKeyFirmChips();
      buildKeyCatChips();
      renderKeyPortal();
    } else {
      showPortal(true);
      buildCategoryChips();
      renderPortal();
    }
  }

  function onSave(){
    const session = getSession();
    if (!session || session.mode !== "ADMIN") return;
    const ok = commitWorkingToDB();
    refreshTopbar();
    if (ok){
      renderAdmin();
      alert("Kaydedildi. Portal verisi güncellendi.");
    } else {
      alert("Kaydedilecek taslak yok.");
    }
  }

  function openAdmin(){
    const session = getSession();
    if (!session || session.mode !== "ADMIN") return;
    showAdmin(true);
    refreshTopbar();
    setPortalTitle(session);
    renderAdmin();
  }

  /********************************************************************
   * Bindings
   ********************************************************************/
  document.getElementById("loginBtn").addEventListener("click", doLogin);
  document.getElementById("logoutBtn").addEventListener("click", doLogout);
  document.getElementById("adminBtn").addEventListener("click", openAdmin);
  document.getElementById("saveBtn").addEventListener("click", onSave);

  ["u","p","firmName"].forEach(id => {
    document.getElementById(id).addEventListener("keydown", (e) => {
      if (e.key === "Enter") doLogin();
    });
  });

  document.getElementById("q").addEventListener("input", renderPortal);

  document.getElementById("kq").addEventListener("input", renderKeyPortal);

  // roles
  document.getElementById("addRoleBtn").addEventListener("click", addRole);
  document.getElementById("normalizeRolesBtn").addEventListener("click", normalizeRoles);

  // firm
  document.getElementById("firmDisplayIn").addEventListener("input", onFirmDisplayInput);
  document.getElementById("addFirmBtn").addEventListener("click", addFirm);
  document.getElementById("updateFirmBtn").addEventListener("click", updateFirm);
  document.getElementById("cancelFirmEditBtn").addEventListener("click", () => { clearFirmForm(); setMsg("firmMsg","Düzenleme iptal edildi.","info"); renderAdmin(); });
  document.getElementById("addAliasBtn").addEventListener("click", addAliasForFirmInput);

  // firm-role
  document.getElementById("firmSelForRoles").addEventListener("change", loadFirmRoles);
  document.getElementById("saveFirmRolesBtn").addEventListener("click", saveFirmRoles);
  document.getElementById("clearFirmRolesBtn").addEventListener("click", clearFirmRoles);

  // user
  document.getElementById("addUserBtn").addEventListener("click", addUser);
  document.getElementById("updateUserBtn").addEventListener("click", updateUser);
  document.getElementById("resetUserPwdBtn").addEventListener("click", resetUserPassword);
  document.getElementById("cancelUserEditBtn").addEventListener("click", () => { clearUserForm(); setMsg("userMsg","Düzenleme iptal edildi.","info"); renderAdmin(); });

  // report CRUD
  document.getElementById("loadReportBtn").addEventListener("click", loadPickedReportIntoForm);
  document.getElementById("deletePickedReportBtn").addEventListener("click", deletePickedReport);
  document.getElementById("clearReportFormBtn").addEventListener("click", clearReportForm);
  document.getElementById("upsertReportBtn").addEventListener("click", upsertReport);

  // mapping
  document.getElementById("loadFirmRoleReportsBtn").addEventListener("click", loadFirmRoleReports);
  document.getElementById("applyFirmRoleReportsBtn").addEventListener("click", applyFirmRoleReports);
  document.getElementById("clearFirmRoleReportsBtn").addEventListener("click", clearRoleFromFirmReports);

  // flow
  document.getElementById("discardBtn").addEventListener("click", discardDraft);
  document.getElementById("goPortalBtn").addEventListener("click", goPortalFromAdmin);

  // key users
  document.getElementById("addKeyUserBtn").addEventListener("click", addKeyUser);
  document.getElementById("updateKeyUserBtn").addEventListener("click", updateKeyUser);
  document.getElementById("resetKeyUserPwdBtn").addEventListener("click", resetKeyUserPassword);
  document.getElementById("cancelKeyUserEditBtn").addEventListener("click", () => { clearKeyUserForm(); setMsg("keyUserMsg","Düzenleme iptal edildi.","info"); renderAdmin(); });

  /********************************************************************
   * Boot (Portal sayfası açılınca otomatik açılsın)
   ********************************************************************/
  (function boot(){
    ensureDB();
    const session = getSession();

    if (!session){
      showLogin(true);
      showPortal(false);
      showKey(false);
      showAdmin(false);
      refreshTopbar();
      setPortalTitle(null);
      return;
    }

    showLogin(false);
    refreshTopbar();
    setPortalTitle(session);

    if (session.mode === "ADMIN"){
      showAdmin(true);
      renderAdmin();
      return;
    }

    if (session.mode === "KEY"){
      selectedFirmK = "ALL";
      selectedCatK = "ALL";
      showAdmin(false);
      showPortal(false);
      showKey(true);
      buildKeyFirmChips();
      buildKeyCatChips();
      renderKeyPortal();
      return;
    }

    selectedCat = "ALL";
    showAdmin(false);
    showKey(false);
    showPortal(true);
    buildCategoryChips();
    renderPortal();
  })();
</script>
</body>
</html>
