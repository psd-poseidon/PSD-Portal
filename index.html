<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSD Portal</title>
  <style>
    :root{
      --bg:#0b1020; --card:#0f1730; --muted:#9aa7c7; --txt:#e9efff;
      --line:rgba(255,255,255,.10); --good:#42d392; --bad:#ff5a6b; --warn:#ffcc00;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --accent:#3b82f6;
      --accent2:#22c55e;
      --accentSoft: rgba(59,130,246,.14);
      --accentLine: rgba(147,197,253,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--sans);color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 30%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 700px at 40% 110%, rgba(245,158,11,.18), transparent 55%),
        var(--bg);
    }
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1280px;margin:0 auto;padding:22px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:var(--shadow)
    }
    .title{display:flex;flex-direction:column;line-height:1.1}
    .title b{font-size:16px}
    .title span{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .card{
      background:rgba(15,23,48,.82);
      backdrop-filter: blur(6px);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow)
    }
    .card .hd{padding:14px 14px 0 14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .card .hd h2{margin:0;font-size:15px}
    .card .hd p{margin:6px 0 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:14px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2, minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3, minmax(0,1fr))}
    @media(max-width:980px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .input, select, textarea{
      width:100%; padding:10px 11px; border-radius:12px; border:1px solid var(--line);
      background:rgba(8,12,25,.78); color:var(--txt); outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .input:focus, select:focus, textarea:focus{border-color:var(--accentLine); box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center; gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:transparent; color:var(--txt); cursor:pointer; user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accentSoft); border-color:rgba(59,130,246,.45)}
    .btn.success{background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.45)}
    .btn.warn{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.45)}
    .btn.danger{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.45)}
    .btn.ghost{background:transparent}
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .hidden{display:none !important}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      cursor:pointer;font-size:12px;color:var(--muted);display:inline-flex;gap:8px;align-items:center
    }
    .tab.active{color:var(--txt); border-color:var(--accentLine); background:var(--accentSoft)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;color:var(--muted)}
    .badge.good{border-color:rgba(34,197,94,.5); color:#bdf7d6}
    .badge.bad{border-color:rgba(239,68,68,.5); color:#ffd0d6}
    .badge.warn{border-color:rgba(245,158,11,.55); color:#ffe7b3}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(10,14,28,.92); border:1px solid var(--line); border-radius:16px;
      padding:10px 12px; box-shadow:var(--shadow);
      display:flex; align-items:center; gap:10px;
      max-width:min(860px, calc(100% - 24px));
      z-index:50;
    }
    .toast .msg{font-size:13px}
    .toast .x{margin-left:auto}
    .loginModes{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:980px){ .loginModes{grid-template-columns:1fr} }
    .modeCard{
      padding:12px;border:1px solid var(--line);border-radius:16px;
      background:linear-gradient(180deg, rgba(8,12,25,.62), rgba(8,12,25,.42));
      cursor:pointer; user-select:none;
    }
    .modeCard.active{
      border-color:var(--accentLine);
      background:linear-gradient(180deg, rgba(59,130,246,.18), rgba(8,12,25,.42));
    }
    .modeCard b{display:block}
    .modeCard span{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:9px 8px;text-align:left;font-size:12px;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .icon{
      width:18px;height:18px;border-radius:6px;border:1px solid var(--line);
      display:inline-flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);
      background:rgba(8,12,25,.55)
    }
    .right-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>PSD Portal</b>
        <span>GitHub Pages UI ¬∑ Google Apps Script API ¬∑ Google Sheet DB</span>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
      <span id="statusPill" class="pill">Baƒülantƒ±: kontrol ediliyor‚Ä¶</span>
      <button class="btn ghost small" id="btnLogout" onclick="logout()" style="display:none;">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <!-- CONFIG -->
  <div class="card" id="cardConfig">
    <div class="hd">
      <div>
        <h2>Kurulum</h2>
        <p>Apps Script Web App URL‚Äôsini gir ve kaydet.</p>
      </div>
      <div class="status">
        <div id="apiDot" class="dot warn"></div>
        <span id="apiText">API yok</span>
      </div>
    </div>
    <div class="bd grid grid-2">
      <div>
        <label>API URL (Apps Script Web App)</label>
        <input class="input mono" id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" />
        <div class="muted" style="font-size:12px;margin-top:8px">
          Deploy: <span class="mono">Execute as: Me</span> ¬∑ <span class="mono">Who has access: Anyone</span> (test i√ßin).
        </div>
      </div>
      <div class="grid">
        <div class="right-actions" style="align-items:end">
          <button class="btn primary" onclick="saveConfig()">Kaydet</button>
          <button class="btn warn" onclick="testApi()">API Test (ping)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="row" id="rowLogin" style="margin-top:14px">
    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Giri≈ü</h2>
          <p>Normal Kullanƒ±cƒ± ¬∑ Super User ¬∑ Admin</p>
        </div>
        <span class="badge" id="modeBadge">NORMAL</span>
      </div>

      <div class="bd grid" style="gap:12px">

        <!-- MODE SELECT -->
        <div class="loginModes">
          <div class="modeCard active" id="mode_NORMAL" onclick="setLoginMode('NORMAL')">
            <b>Normal Kullanƒ±cƒ±</b>
            <span>Firma zorunlu ¬∑ Firma i√ßi raporlar</span>
          </div>
          <div class="modeCard" id="mode_KEY" onclick="setLoginMode('KEY')">
            <b>Super User</b>
            <span>T√ºm firmalar / Firma se√ßimi opsiyonel</span>
          </div>
          <div class="modeCard" id="mode_ADMIN" onclick="setLoginMode('ADMIN')">
            <b>Admin</b>
            <span>DB y√∂netimi ¬∑ Yetki ve rapor y√∂netimi</span>
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label>Kullanƒ±cƒ± Adƒ±</label>
            <input class="input" id="inUser" autocomplete="username" />
          </div>
          <div>
            <label>≈ûifre</label>
            <input class="input" id="inPass" type="password" autocomplete="current-password" />
          </div>
        </div>

        <!-- FIRM INPUT / SELECT -->
        <div id="firmNormalWrap">
          <label>Firma (Normal Kullanƒ±cƒ± i√ßin zorunlu)</label>
          <input class="input" id="inFirm" placeholder="√ñrn: Sudesan / Elida / ..." />
          <div class="muted" style="font-size:12px;margin-top:6px">
            Not: Firma adƒ± alias tablosu ile firmKey‚Äôe e≈üle≈ütirilir.
          </div>
        </div>

        <div id="firmKeyWrap" class="hidden">
          <label>Firma G√∂r√ºn√ºm√º (Super User i√ßin opsiyonel)</label>
          <select class="input" id="keyFirmSel">
            <option value="">‚Äî T√ºm firmalar ‚Äî</option>
          </select>
        </div>

        <div class="right-actions">
          <button class="btn primary" onclick="login()">Giri≈ü Yap</button>
          <button class="btn ghost" onclick="fillDemo()">Demo doldur</button>
        </div>

        <div class="muted" style="font-size:12px;line-height:1.45">
          <b>Not:</b> ‚ÄúKullanƒ±cƒ±lar / firmalar silindi‚Äù hissi genelde yanlƒ±≈ülƒ±kla bo≈ü DB ile <span class="mono">saveDB</span> √ßalƒ±≈ütƒ±rƒ±lƒ±nca olur.
          Admin panelde <b>Backup / Restore / Seed</b> ile tek tƒ±k geri d√∂n√º≈ü var.
        </div>
      </div>
    </div>

    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>√ñzet</h2>
          <p>Tek dosya UI ¬∑ Yetkiler API‚Äôde</p>
        </div>
      </div>
      <div class="bd">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="badge" id="kpiFirms">Firms: ‚Äî</div>
          <div class="badge" id="kpiUsers">Users: ‚Äî</div>
          <div class="badge" id="kpiReports">Reports: ‚Äî</div>
        </div>
        <div class="hr"></div>
        <div class="muted" style="font-size:12px">
          Admin giri≈ü yaptƒ±ktan sonra DB mod√ºlleri: Firms, Users, Super Users, Roles, Firm Access, Reports, Backup/Restore/Seed, Audit.
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="row hidden" id="rowMain" style="margin-top:14px">
    <!-- LEFT -->
    <div class="card" style="flex:2.2;min-width:320px">
      <div class="hd">
        <div>
          <h2 id="mainTitle">Portal</h2>
          <p id="mainSub" class="muted">‚Äî</p>
        </div>
        <div class="right-actions">
          <button class="btn small" onclick="refreshDB()">Yenile</button>
          <button class="btn small warn hidden" id="btnAdminOpen" onclick="openAdmin()">Admin Paneli</button>
        </div>
      </div>

      <div class="bd grid" style="gap:10px">
        <div class="grid grid-3">
          <div>
            <label>Arama</label>
            <input class="input" id="qSearch" placeholder="√ñrn: KPI, WMS, S&OP..." oninput="renderReports()" />
          </div>
          <div>
            <label>Kategori</label>
            <select class="input" id="catSel" onchange="renderReports()">
              <option value="ALL">T√ºm√º</option>
            </select>
          </div>
          <div>
            <label>Sƒ±ralama</label>
            <select class="input" id="sortSel" onchange="renderReports()">
              <option value="cat_name">Kategori + ƒ∞sim</option>
              <option value="name">ƒ∞sim</option>
            </select>
          </div>
        </div>

        <div id="reportsList" class="grid" style="gap:10px"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="flex:1;min-width:320px">
      <div class="hd">
        <div>
          <h2>Oturum</h2>
          <p>Kimlik ve mod</p>
        </div>
        <span class="badge" id="sessBadge">‚Äî</span>
      </div>
      <div class="bd grid" style="gap:10px">
        <div>
          <div class="muted" style="font-size:12px">Kullanƒ±cƒ±</div>
          <div id="sessUser" style="font-weight:700">‚Äî</div>
        </div>
        <div class="grid grid-2">
          <div>
            <div class="muted" style="font-size:12px">Mod</div>
            <div id="sessMode">‚Äî</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Firma</div>
            <div id="sessFirm">‚Äî</div>
          </div>
        </div>
        <div>
          <div class="muted" style="font-size:12px">Roller</div>
          <div id="sessRoles" class="mono" style="font-size:12px;word-break:break-word">‚Äî</div>
        </div>
        <div class="right-actions">
          <button class="btn danger" onclick="logout()">√áƒ±kƒ±≈ü</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="card hidden" id="cardAdmin" style="margin-top:14px">
    <div class="hd">
      <div>
        <h2>Admin Panel</h2>
        <p>DB mod√ºlleri (y√∂netim)</p>
      </div>
      <div class="right-actions">
        <button class="btn small" onclick="adminBackupLocal()"><span class="icon">‚ßâ</span> Backup</button>
        <button class="btn small warn" onclick="adminRestoreLocal()"><span class="icon">‚Ü©</span> Restore</button>
        <button class="btn small danger" onclick="adminSeedDefaults()"><span class="icon">‚ö°</span> Seed</button>
        <span style="width:1px;height:24px;background:var(--line)"></span>
        <button class="btn small" onclick="closeAdmin()">Kapat</button>
        <button class="btn small success" onclick="saveAdmin()">Kaydet (saveDB)</button>
      </div>
    </div>
    <div class="bd">
      <div class="tabs" id="adminTabs"></div>
      <div id="adminArea"></div>
      <div class="hr"></div>
      <div class="muted mono" style="font-size:12px" id="backupInfo">Local backup: ‚Äî</div>
    </div>
  </div>

</div>

<div id="toast" class="toast hidden">
  <div id="toastDot" class="dot warn"></div>
  <div id="toastMsg" class="msg">‚Äî</div>
  <button class="btn small ghost x" onclick="hideToast()">Kapat</button>
</div>

<script>
/** =========================
 *  STATE / LOCAL STORAGE
 *  ========================= */
let API_URL = "";
const LS = {
  api: "PSD_API_URL",
  sess: "PSD_SESSION",
  loginMode: "PSD_LOGIN_MODE", // NEW
  keyFirmView: "PSD_KEY_FIRM_VIEW",
  backup: "PSD_DB_BACKUP_V1",
  backupMeta: "PSD_DB_BACKUP_META_V1"
};

let loginMode = localStorage.getItem(LS.loginMode) || "NORMAL"; // NORMAL | KEY | ADMIN
let session = null;
let DB = null;
let adminActiveTab = "Firms";

function init() {
  API_URL = localStorage.getItem(LS.api) || "";
  document.getElementById("apiUrl").value = API_URL;

  const s = localStorage.getItem(LS.sess);
  if (s) { try { session = JSON.parse(s); } catch(_) {} }

  setLoginMode(loginMode, true);

  updateConnPill("warn","Baƒülantƒ±: ayarlanmadƒ±");
  if (API_URL) testApi(true);

  // Eƒüer session varsa auto-open
  if (session && session.token) {
    refreshDB(true).then(() => showMain()).catch(() => logout(true));
  }
}
window.addEventListener("DOMContentLoaded", init);

/** =========================
 *  LOGIN MODE UI
 *  ========================= */
function setLoginMode(mode, silent=false) {
  loginMode = mode;
  localStorage.setItem(LS.loginMode, mode);
  document.getElementById("modeBadge").textContent = mode;

  // active cards
  ["NORMAL","KEY","ADMIN"].forEach(m => {
    document.getElementById("mode_"+m).classList.toggle("active", m === mode);
  });

  // firm fields
  const firmNormalWrap = document.getElementById("firmNormalWrap");
  const firmKeyWrap = document.getElementById("firmKeyWrap");

  if (mode === "NORMAL") {
    firmNormalWrap.classList.remove("hidden");
    firmKeyWrap.classList.add("hidden");
  } else if (mode === "KEY") {
    firmNormalWrap.classList.add("hidden");
    firmKeyWrap.classList.remove("hidden");
    hydrateKeyFirmSelect(); // DB varsa doldur
  } else { // ADMIN
    firmNormalWrap.classList.add("hidden");
    firmKeyWrap.classList.add("hidden");
  }

  if (!silent) toast("good","Giri≈ü modu: " + mode);
}

function hydrateKeyFirmSelect() {
  const sel = document.getElementById("keyFirmSel");
  if (!sel) return;
  const firms = (DB?.firms || []).filter(f => String(f.active).toLowerCase() !== "false");
  const current = localStorage.getItem(LS.keyFirmView) || "";
  sel.innerHTML = `<option value="">‚Äî T√ºm firmalar ‚Äî</option>` + firms
    .sort((a,b)=> String(a.display||a.firmKey||"").localeCompare(String(b.display||b.firmKey||""), "tr"))
    .map(f => `<option value="${escapeHtml(String(f.firmKey||"").trim())}">${escapeHtml(String(f.display||f.firmKey||"").trim())}</option>`)
    .join("");
  sel.value = current;
  sel.onchange = () => localStorage.setItem(LS.keyFirmView, sel.value || "");
}

/** =========================
 *  CONFIG / API
 *  ========================= */
function saveConfig() {
  API_URL = (document.getElementById("apiUrl").value || "").trim();
  localStorage.setItem(LS.api, API_URL);
  toast("good","Kaydedildi. API Test √∂nerilir.");
  testApi();
}

async function apiCall(payload) {
  if (!API_URL) throw new Error("API URL yok");
  const resp = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const txt = await resp.text();
  try { return JSON.parse(txt); }
  catch(e){ throw new Error("JSON parse error: " + txt.slice(0,200)); }
}

async function testApi(silent=false) {
  if (!API_URL) {
    setApiStatus(false, "API URL yok");
    updateConnPill("warn","Baƒülantƒ±: API URL yok");
    if (!silent) toast("warn","API URL girilmemi≈ü.");
    return;
  }
  try {
    const res = await apiCall({ action:"ping" });
    if (res && res.ok) {
      setApiStatus(true, "API hazƒ±r");
      updateConnPill("good","Baƒülantƒ±: OK");
      if (!silent) toast("good","API ping ba≈üarƒ±lƒ±.");
    } else {
      setApiStatus(false, "API cevap hatasƒ±");
      updateConnPill("bad","Baƒülantƒ±: HATA");
      if (!silent) toast("bad","API ping ba≈üarƒ±sƒ±z: " + (res?.error || "unknown"));
    }
  } catch (e) {
    setApiStatus(false, "API eri≈üilemiyor");
    updateConnPill("bad","Baƒülantƒ±: HATA");
    if (!silent) toast("bad","API eri≈üilemiyor: " + e.message);
  }
}

function setApiStatus(ok, text) {
  document.getElementById("apiDot").className = "dot " + (ok ? "good" : "bad");
  document.getElementById("apiText").textContent = text;
}
function updateConnPill(level, text) {
  document.getElementById("statusPill").textContent = text;
}

/** =========================
 *  LOGIN
 *  ========================= */
function fillDemo() {
  if (loginMode === "NORMAL") {
    document.getElementById("inUser").value = "sud_user";
    document.getElementById("inPass").value = "sud123";
    document.getElementById("inFirm").value = "Sudesan";
  } else if (loginMode === "KEY") {
    document.getElementById("inUser").value = "keyuser";
    document.getElementById("inPass").value = "key123";
  } else {
    document.getElementById("inUser").value = "admin";
    document.getElementById("inPass").value = "admin123";
  }
}

async function login() {
  const username = (document.getElementById("inUser").value || "").trim();
  const password = (document.getElementById("inPass").value || "");

  if (!API_URL) return toast("warn","√ñnce API URL kaydet.");
  if (!username || !password) return toast("warn","Kullanƒ±cƒ±/≈üifre gir.");

  // Mode-specific fields
  let firmName = "";
  let keyFirm = "";

  if (loginMode === "NORMAL") {
    firmName = (document.getElementById("inFirm").value || "").trim();
    if (!firmName) return toast("warn","Normal kullanƒ±cƒ± i√ßin firma zorunlu.");
  }
  if (loginMode === "KEY") {
    keyFirm = (document.getElementById("keyFirmSel").value || "").trim(); // opsiyonel
    localStorage.setItem(LS.keyFirmView, keyFirm);
  }

  try {
    // API action: login
    // mode bilgisini UI g√∂nderiyor; API bunu doƒürulayƒ±p doƒüru mode d√∂nd√ºrmeli.
    const res = await apiCall({ action:"login", username, password, firmName, desiredMode: loginMode });
    if (!res.ok) return toast("bad", res.error || "Giri≈ü ba≈üarƒ±sƒ±z");

    // session
    session = { token: res.token, mode: res.mode, user: res.user };
    localStorage.setItem(LS.sess, JSON.stringify(session));

    toast("good","Giri≈ü ba≈üarƒ±lƒ±: " + res.mode);
    await refreshDB(true);
    showMain();
  } catch (e) {
    toast("bad","Login hata: " + e.message);
  }
}

/** =========================
 *  SESSION / DB
 *  ========================= */
function logout(silent=false) {
  session = null; DB = null;
  localStorage.removeItem(LS.sess);

  document.getElementById("rowMain").classList.add("hidden");
  document.getElementById("cardAdmin").classList.add("hidden");
  document.getElementById("rowLogin").classList.remove("hidden");
  document.getElementById("btnLogout").style.display = "none";

  document.getElementById("kpiFirms").textContent = "Firms: ‚Äî";
  document.getElementById("kpiUsers").textContent = "Users: ‚Äî";
  document.getElementById("kpiReports").textContent = "Reports: ‚Äî";

  if (!silent) toast("warn","√áƒ±kƒ±≈ü yapƒ±ldƒ±.");
}

async function refreshDB(silent=false) {
  if (!session?.token) throw new Error("No session");
  const res = await apiCall({ action:"getDB", token: session.token });
  if (!res.ok) throw new Error(res.error || "getDB error");

  DB = res.db || {};
  const firmsN = (DB?.firms || []).length;
  const usersN = (DB?.users || []).length + (DB?.keyUsers || []).length;
  const repsN  = (DB?.reports || []).length;

  document.getElementById("kpiFirms").textContent = "Firms: " + firmsN;
  document.getElementById("kpiUsers").textContent = "Users: " + usersN;
  document.getElementById("kpiReports").textContent = "Reports: " + repsN;

  // Key select hydrate
  if (loginMode === "KEY") hydrateKeyFirmSelect();
  if (!silent) toast("good","DB yenilendi.");
}

/** =========================
 *  MAIN UI
 *  ========================= */
function showMain() {
  document.getElementById("rowLogin").classList.add("hidden");
  document.getElementById("rowMain").classList.remove("hidden");
  document.getElementById("btnLogout").style.display = "inline-flex";

  document.getElementById("btnAdminOpen").classList.toggle("hidden", session?.mode !== "ADMIN");

  const u = session?.user || {};
  document.getElementById("sessBadge").textContent = session?.mode || "‚Äî";
  document.getElementById("sessUser").textContent = u.display || u.username || "‚Äî";
  document.getElementById("sessMode").textContent = session?.mode || "‚Äî";
  document.getElementById("sessFirm").textContent = u.firmDisplay || u.firmKey || "‚Äî";
  document.getElementById("sessRoles").textContent = (u.roles || []).join(", ") || "‚Äî";

  if (session?.mode === "ADMIN") {
    document.getElementById("mainTitle").textContent = "Admin";
    document.getElementById("mainSub").textContent = "T√ºm raporlar + DB y√∂netimi";
  } else if (session?.mode === "KEY") {
    const k = localStorage.getItem(LS.keyFirmView) || "";
    document.getElementById("mainTitle").textContent = "Super User";
    document.getElementById("mainSub").textContent = k ? ("Firma g√∂r√ºn√ºm√º: " + k) : "Firma g√∂r√ºn√ºm√º: T√ºm firmalar";
  } else {
    document.getElementById("mainTitle").textContent = "Portal";
    document.getElementById("mainSub").textContent = u.firmDisplay ? ("Firma: " + u.firmDisplay) : "‚Äî";
  }

  hydrateCategories();
  renderReports();
}

function hydrateCategories() {
  const sel = document.getElementById("catSel");
  const reports = (DB?.reports || []).filter(r => String(r.active).toLowerCase() !== "false").filter(canSeeReport);
  const cats = Array.from(new Set(reports.map(r => String(r.cat||"Genel"))))
    .sort((a,b)=>a.localeCompare(b,"tr"));

  const current = sel.value || "ALL";
  sel.innerHTML = `<option value="ALL">T√ºm√º</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  sel.value = cats.includes(current) ? current : "ALL";
}

function canSeeReport(r) {
  const mode = session?.mode;
  const u = session?.user || {};
  const firmKey = String(r.firmKey||"").trim();

  if (mode === "ADMIN") return true;

  if (mode === "PORTAL") {
    const myFirm = String(u.firmKey||"").trim();
    if (firmKey && myFirm && firmKey !== myFirm) return false;
    if (firmKey && !myFirm) return false;
  }

  if (mode === "KEY") {
    const viewFirm = localStorage.getItem(LS.keyFirmView) || "";
    if (viewFirm && firmKey && firmKey !== viewFirm) return false;
  }

  // allowRolesCsv / allowUsersCsv
  const allowRoles = csvToArr(r.allowRolesCsv);
  const allowUsers = csvToArr(r.allowUsersCsv).map(x=>x.toLowerCase());

  if (!allowRoles.length && !allowUsers.length) return true;

  const uname = String(u.username||"").toLowerCase();
  if (allowUsers.includes(uname)) return true;

  const myRoles = u.roles || [];
  return allowRoles.some(rr => myRoles.includes(rr));
}

function renderReports() {
  const list = document.getElementById("reportsList");
  list.innerHTML = "";

  const q = (document.getElementById("qSearch").value || "").trim().toLowerCase();
  const cat = (document.getElementById("catSel").value || "ALL");
  const sortMode = (document.getElementById("sortSel").value || "cat_name");

  let reports = (DB?.reports || [])
    .filter(r => String(r.active).toLowerCase() !== "false")
    .filter(canSeeReport);

  if (cat !== "ALL") reports = reports.filter(r => String(r.cat||"Genel") === cat);

  if (q) {
    reports = reports.filter(r => (`${r.name||""} ${r.desc||""} ${r.cat||""}`).toLowerCase().includes(q));
  }

  reports.sort((a,b)=>{
    if (sortMode === "name") return String(a.name||"").localeCompare(String(b.name||""), "tr");
    const ca = String(a.cat||""); const cb = String(b.cat||"");
    if (ca !== cb) return ca.localeCompare(cb, "tr");
    return String(a.name||"").localeCompare(String(b.name||""), "tr");
  });

  if (!reports.length) {
    const d = document.createElement("div");
    d.className = "muted";
    d.style.fontSize = "12px";
    d.textContent = "G√∂r√ºnt√ºlenecek rapor bulunamadƒ±.";
    list.appendChild(d);
    return;
  }

  reports.forEach(r=>{
    const box = document.createElement("div");
    box.className = "card";
    box.style.background = "rgba(8,12,25,.52)";
    const bd = document.createElement("div");
    bd.className = "bd";

    const h = document.createElement("div");
    h.style.display = "flex";
    h.style.justifyContent = "space-between";
    h.style.gap = "10px";
    h.style.alignItems = "flex-start";

    const left = document.createElement("div");
    const title = document.createElement("div");
    title.style.fontWeight = "800";
    title.textContent = r.name || "Unnamed report";
    const sub = document.createElement("div");
    sub.className = "muted";
    sub.style.fontSize = "12px";
    sub.style.marginTop = "4px";
    sub.textContent = (r.desc || "");
    left.appendChild(title);
    left.appendChild(sub);

    const right = document.createElement("div");
    right.className = "right-actions";
    const open = document.createElement("button");
    open.className = "btn small primary";
    open.textContent = "A√ß";
    open.onclick = () => {
      const url = String(r.url||"").trim();
      if (!url) return toast("warn","URL bo≈ü.");
      window.open(url, "_blank", "noopener,noreferrer");
    };
    right.appendChild(open);

    h.appendChild(left);
    h.appendChild(right);

    const meta = document.createElement("div");
    meta.style.marginTop = "10px";
    meta.style.display = "flex";
    meta.style.gap = "8px";
    meta.style.flexWrap = "wrap";
    meta.innerHTML = `
      <span class="badge">Kategori: ${escapeHtml(String(r.cat||"Genel"))}</span>
      ${r.firmKey ? `<span class="badge">Firma: ${escapeHtml(String(r.firmKey))}</span>` : ``}
    `;

    bd.appendChild(h);
    bd.appendChild(meta);
    box.appendChild(bd);
    list.appendChild(box);
  });
}

/** =========================
 *  ADMIN PANEL (Mod√ºller)
 *  ========================= */
function openAdmin() {
  if (session?.mode !== "ADMIN") return toast("bad","Admin gerekli");
  document.getElementById("cardAdmin").classList.remove("hidden");
  renderAdminTabs();
  renderAdminTable();
  refreshBackupInfo();
}
function closeAdmin() { document.getElementById("cardAdmin").classList.add("hidden"); }

function renderAdminTabs() {
  const tabs = document.getElementById("adminTabs");
  tabs.innerHTML = "";

  // Admin ekranƒ±nda ‚Äúolmasƒ± gerekenler‚Äù (sen listeyi yazƒ±nca aynen revize edeceƒüim)
  const tabList = [
    { key:"Firms", label:"Firms" },
    { key:"Aliases", label:"Aliases" },
    { key:"Roles", label:"Roles" },
    { key:"Users", label:"Users" },
    { key:"KeyUsers", label:"Super Users" },
    { key:"FirmAccessRoles", label:"Firm Access" },
    { key:"Reports", label:"Reports" },
    { key:"Audit", label:"Audit (log)" }
  ];

  tabList.forEach(t=>{
    const el = document.createElement("div");
    el.className = "tab" + (adminActiveTab === t.key ? " active" : "");
    el.textContent = t.label;
    el.onclick = () => { adminActiveTab = t.key; renderAdminTabs(); renderAdminTable(); };
    tabs.appendChild(el);
  });
}

function getTabKeyToDBKey(tab){
  if (tab === "FirmAccessRoles") return "firmAccessRoles";
  if (tab === "KeyUsers") return "keyUsers";
  if (tab === "Audit") return "audit";
  return tab.toLowerCase();
}

function inferColumns(tab) {
  if (tab === "Firms") return ["firmKey","display","active"];
  if (tab === "Aliases") return ["alias","firmKey"];
  if (tab === "Roles") return ["roleKey","desc","active"];
  if (tab === "Users") return ["username","passHash","display","email","rolesCsv","active"];
  if (tab === "KeyUsers") return ["username","passHash","display","email","active"];
  if (tab === "FirmAccessRoles") return ["firmKey","requiredRolesCsv"];
  if (tab === "Reports") return ["id","firmKey","cat","name","url","desc","allowRolesCsv","allowUsersCsv","active"];
  if (tab === "Audit") return ["at","actor","action","entity","before","after"];
  return [];
}

function renderAdminTable() {
  const area = document.getElementById("adminArea");
  area.innerHTML = "";

  const dbKey = getTabKeyToDBKey(adminActiveTab);

  // Audit DB yoksa bo≈ü g√∂ster
  if (!DB[dbKey]) DB[dbKey] = (dbKey === "audit") ? [] : (DB[dbKey] || []);
  const rows = DB[dbKey] || [];
  const cols = inferColumns(adminActiveTab);

  const top = document.createElement("div");
  top.className = "right-actions";
  top.style.marginBottom = "10px";

  const addBtn = document.createElement("button");
  addBtn.className = "btn small success";
  addBtn.innerHTML = `<span class="icon">Ôºã</span> Satƒ±r Ekle`;
  addBtn.onclick = () => {
    const blank = {};
    cols.forEach(c => blank[c] = "");
    DB[dbKey] = (DB[dbKey] || []).concat([blank]);
    renderAdminTable();
  };

  const delBtn = document.createElement("button");
  delBtn.className = "btn small danger";
  delBtn.innerHTML = `<span class="icon">üóë</span> Se√ßili Sil`;
  delBtn.onclick = () => deleteSelectedRows();

  // Audit tabƒ±nda ekleme/silme kapalƒ± (√∂rnek)
  if (adminActiveTab !== "Audit") {
    top.appendChild(addBtn);
    top.appendChild(delBtn);
  } else {
    const info = document.createElement("div");
    info.className = "muted";
    info.style.fontSize = "12px";
    info.textContent = "Audit log salt okunur (√∂rnek).";
    area.appendChild(info);
  }

  if (adminActiveTab !== "Audit") area.appendChild(top);

  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");

  const thSel = document.createElement("th");
  thSel.style.width = "34px";
  thSel.innerHTML = `<input type="checkbox" id="selAll" />`;
  trh.appendChild(thSel);

  cols.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c;
    trh.appendChild(th);
  });

  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  rows.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.idx = idx;

    const tdSel = document.createElement("td");
    tdSel.innerHTML = `<input type="checkbox" class="rowSel" data-idx="${idx}">`;
    tr.appendChild(tdSel);

    cols.forEach(c => {
      const td = document.createElement("td");
      const isLong = ["desc","before","after"].includes(c);
      const inp = document.createElement(isLong ? "textarea" : "input");
      inp.className = "input";
      if (isLong) inp.style.minHeight = "42px";
      inp.value = (r && r[c] !== undefined) ? String(r[c]) : "";

      inp.oninput = (e) => { DB[dbKey][idx][c] = e.target.value; };
      if (adminActiveTab === "Audit") inp.disabled = true;

      td.appendChild(inp);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  area.appendChild(table);

  setTimeout(() => {
    const selAll = document.getElementById("selAll");
    if (selAll) {
      selAll.onchange = () => {
        document.querySelectorAll(".rowSel").forEach(cb => cb.checked = selAll.checked);
      };
    }
  }, 0);
}

function deleteSelectedRows() {
  const dbKey = getTabKeyToDBKey(adminActiveTab);
  const rows = DB?.[dbKey] || [];
  const selected = Array.from(document.querySelectorAll(".rowSel"))
    .filter(cb => cb.checked)
    .map(cb => Number(cb.dataset.idx))
    .sort((a,b)=>b-a);
  if (!selected.length) return toast("warn","Se√ßili satƒ±r yok");
  selected.forEach(i => rows.splice(i,1));
  DB[dbKey] = rows;
  toast("good","Silindi: " + selected.length);
  renderAdminTable();
}

/** =========================
 *  BACKUP / RESTORE / SEED
 *  ========================= */
function sanitizeDB(db) {
  const out = {};
  ["firms","aliases","roles","users","keyUsers","firmAccessRoles","reports","audit"].forEach(k => out[k] = Array.isArray(db?.[k]) ? db[k] : []);
  return out;
}

function refreshBackupInfo() {
  const metaRaw = localStorage.getItem(LS.backupMeta);
  let msg = "Local backup: yok";
  if (metaRaw) {
    try {
      const meta = JSON.parse(metaRaw);
      msg = `Local backup: ${meta.at} ¬∑ firms=${meta.counts?.firms||0}, users=${meta.counts?.users||0}, keyUsers=${meta.counts?.keyUsers||0}, reports=${meta.counts?.reports||0}`;
    } catch(_) {}
  }
  document.getElementById("backupInfo").textContent = msg;
}

function adminBackupLocal() {
  if (session?.mode !== "ADMIN") return toast("bad","Admin gerekli");
  if (!DB) return toast("warn","DB yok");

  const snap = sanitizeDB(DB);
  const counts = { firms:snap.firms.length, users:snap.users.length, keyUsers:snap.keyUsers.length, reports:snap.reports.length };
  localStorage.setItem(LS.backup, JSON.stringify(snap));
  localStorage.setItem(LS.backupMeta, JSON.stringify({ at: new Date().toISOString(), counts }));
  toast("good","Backup alƒ±ndƒ±.");
  refreshBackupInfo();
}

function adminRestoreLocal() {
  if (session?.mode !== "ADMIN") return toast("bad","Admin gerekli");
  const raw = localStorage.getItem(LS.backup);
  if (!raw) return toast("warn","Backup yok.");
  if (!confirm("Local yedeƒüi geri y√ºkle? (UI DB deƒüi≈üir)")) return;

  try {
    const snap = JSON.parse(raw);
    DB = sanitizeDB(snap);
    toast("good","Restore tamam. (Kaydet(saveDB) ile server‚Äôa bas)");
    renderAdminTable();
    hydrateCategories();
    renderReports();
    refreshBackupInfo();
  } catch(e) {
    toast("bad","Restore hata: " + e.message);
  }
}

function seedTemplatePlain() {
  return {
    firms: [
      { firmKey:"PSD", display:"Poseidon (Internal)", active:"true" },
      { firmKey:"SUD", display:"Sudesan", active:"true" },
      { firmKey:"ELI", display:"Elida", active:"true" },
      { firmKey:"DEGA", display:"DE-GA", active:"true" }
    ],
    aliases: [
      { alias:"Poseidon", firmKey:"PSD" },
      { alias:"Sudesan", firmKey:"SUD" },
      { alias:"Elida", firmKey:"ELI" },
      { alias:"DE-GA", firmKey:"DEGA" },
      { alias:"DEGA", firmKey:"DEGA" }
    ],
    roles: [
      { roleKey:"VIEWER", desc:"Read-only access", active:"true" },
      { roleKey:"PLANNER", desc:"Planning / inventory", active:"true" },
      { roleKey:"MANAGER", desc:"Management dashboards", active:"true" },
      { roleKey:"FIN", desc:"Finance reports", active:"true" }
    ],
    users_plain: [
      { username:"admin",  password:"admin123", display:"Admin", email:"", rolesCsv:"MANAGER", active:"true" },
      { username:"sud_user", password:"sud123", display:"Sudesan User", email:"", rolesCsv:"VIEWER,PLANNER", active:"true" }
    ],
    keyUsers_plain: [
      { username:"keyuser", password:"key123", display:"Super User", email:"", active:"true" }
    ],
    firmAccessRoles: [
      { firmKey:"SUD", requiredRolesCsv:"VIEWER,PLANNER,MANAGER,FIN" },
      { firmKey:"ELI", requiredRolesCsv:"VIEWER,MANAGER,FIN" },
      { firmKey:"DEGA", requiredRolesCsv:"VIEWER,PLANNER" }
    ],
    reports: [
      { id:"R-SUD-001", firmKey:"SUD", cat:"KPI", name:"Sudesan KPI Dashboard", url:"https://lookerstudio.google.com/", desc:"KPI overview", allowRolesCsv:"VIEWER,MANAGER", allowUsersCsv:"", active:"true" },
      { id:"R-GEN-001", firmKey:"", cat:"Genel", name:"Portal Kullanƒ±m Rehberi", url:"https://github.com/psd-poseidon/PSD-Portal", desc:"Readme", allowRolesCsv:"", allowUsersCsv:"", active:"true" }
    ],
    audit: []
  };
}

async function adminSeedDefaults() {
  if (session?.mode !== "ADMIN") return toast("bad","Admin gerekli");
  if (!confirm("Seed yapƒ±lacak. √ñnce backup alƒ±nacak. Devam?")) return;

  if (DB) adminBackupLocal();

  toast("warn","Seed hazƒ±rlanƒ±yor (hash)...");
  const tpl = seedTemplatePlain();
  const seeded = await buildSeedDBWithHashes(tpl);
  DB = sanitizeDB(seeded);

  adminActiveTab = "Firms";
  renderAdminTabs();
  renderAdminTable();
  hydrateCategories();
  renderReports();
  refreshBackupInfo();
  toast("good","Seed UI‚Äôya y√ºklendi. Kaydet(saveDB) ile server‚Äôa bas.");
}

async function buildSeedDBWithHashes(tpl) {
  const users = [];
  for (const u of (tpl.users_plain || [])) {
    users.push({
      username: String(u.username||"").trim(),
      passHash: await sha256Hex(u.password||""),
      display: u.display || "",
      email: u.email || "",
      rolesCsv: u.rolesCsv || "",
      active: u.active ?? "true"
    });
  }
  const keyUsers = [];
  for (const ku of (tpl.keyUsers_plain || [])) {
    keyUsers.push({
      username: String(ku.username||"").trim(),
      passHash: await sha256Hex(ku.password||""),
      display: ku.display || "",
      email: ku.email || "",
      active: ku.active ?? "true"
    });
  }
  return {
    firms: tpl.firms||[],
    aliases: tpl.aliases||[],
    roles: tpl.roles||[],
    users,
    keyUsers,
    firmAccessRoles: tpl.firmAccessRoles||[],
    reports: tpl.reports||[],
    audit: tpl.audit||[]
  };
}

async function sha256Hex(str) {
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const buf = await crypto.subtle.digest("SHA-256", data);
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

async function saveAdmin() {
  if (session?.mode !== "ADMIN") return toast("bad","Admin gerekli");
  if (!DB) return toast("bad","DB yok");

  adminBackupLocal(); // safety

  try {
    const res = await apiCall({ action:"saveDB", token: session.token, db: sanitizeDB(DB) });
    if (!res.ok) return toast("bad", res.error || "saveDB failed");
    toast("good","Kaydedildi. DB yenileniyor‚Ä¶");
    await refreshDB(true);
    renderAdminTable();
    hydrateCategories();
    renderReports();
  } catch (e) {
    toast("bad","saveAdmin hata: " + e.message);
  }
}

/** =========================
 *  HELPERS
 *  ========================= */
function csvToArr(csv){
  return String(csv||"").split(",").map(x=>x.trim()).filter(Boolean);
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================
 *  TOAST
 *  ========================= */
function toast(level, msg) {
  const t = document.getElementById("toast");
  const dot = document.getElementById("toastDot");
  const m = document.getElementById("toastMsg");
  dot.className = "dot " + (level === "good" ? "good" : level === "bad" ? "bad" : "warn");
  m.textContent = msg;
  t.classList.remove("hidden");
  clearTimeout(toast._timer);
  toast._timer = setTimeout(hideToast, 4200);
}
function hideToast() { document.getElementById("toast").classList.add("hidden"); }
</script>
</body>
</html>
