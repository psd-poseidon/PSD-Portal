/***********************
 *  PORTAL: KullanÄ±cÄ± / Rol / Yetki / Log / Export
 *  - TablarÄ± otomatik oluÅŸturur & baÅŸlÄ±klarÄ± dÃ¼zeltir
 *  - onOpen ile menÃ¼ ekler
 *  - onOpen ile giriÅŸ kaydÄ± (OPEN) loglar
 *  - KullanÄ±cÄ± listesini Excel (xlsx) export eder
 ************************/

/** ---- AYARLAR ---- **/
const CFG = {
  SHEETS: {
    USERS: "KullanÄ±cÄ±lar",
    COMPANY_ROLES: "Firma GiriÅŸ Roller",
    REPORT_PERMS: "Rapor Yetkileri",
    LOGIN_LOGS: "GiriÅŸ KayÄ±tlarÄ±",
  },
  HEADER_ROW: 1,
  TZ: Session.getScriptTimeZone() || "Europe/Istanbul",
};

/** ---- MENÃœ ---- **/
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu("Portal YÃ¶netim")
    .addItem("âœ… TablarÄ± Kur / DÃ¼zelt", "setupPortal")
    .addSeparator()
    .addItem("ğŸ“„ KullanÄ±cÄ±larÄ± Excel'e Aktar (xlsx)", "exportUsersToExcel")
    .addSeparator()
    .addItem("ğŸ§¾ GiriÅŸ KaydÄ± (Manuel) - LOGIN", "logManualLogin")
    .addToUi();

  // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nÄ± logla (kullanÄ±cÄ± e-posta izin veriyorsa)
  try {
    logLoginEvent_("OPEN");
  } catch (e) {
    // sessiz geÃ§
  }
}

/** ---- KURULUM / DÃœZELTME ---- **/
function setupPortal() {
  const ss = SpreadsheetApp.getActive();

  const shUsers = getOrCreateSheet_(ss, CFG.SHEETS.USERS);
  const shCompanyRoles = getOrCreateSheet_(ss, CFG.SHEETS.COMPANY_ROLES);
  const shReportPerms = getOrCreateSheet_(ss, CFG.SHEETS.REPORT_PERMS);
  const shLogs = getOrCreateSheet_(ss, CFG.SHEETS.LOGIN_LOGS);

  buildUsersSheet_(shUsers);
  buildCompanyRolesSheet_(shCompanyRoles, shUsers);
  buildReportPermsSheet_(shReportPerms);
  buildLoginLogsSheet_(shLogs);

  SpreadsheetApp.getUi().alert("Tablar kuruldu/dÃ¼zeltildi âœ…\n\n- KullanÄ±cÄ±lar\n- Firma GiriÅŸ Roller\n- Rapor Yetkileri\n- GiriÅŸ KayÄ±tlarÄ±\n\nMenÃ¼den Excel export'u kullanabilirsin.");
}

/** ---- TAB: KullanÄ±cÄ±lar ---- **/
function buildUsersSheet_(sh) {
  const headers = [
    "KullanÄ±cÄ± ID",
    "Ad Soyad",
    "E-posta",
    "Firma",
    "Rol",
    "Durum (Aktif/Pasif)",
    "OluÅŸturma Tarihi",
    "Not",
  ];

  resetSheet_(sh, headers);

  // Kolon geniÅŸlikleri
  sh.setColumnWidths(1, headers.length, 170);
  sh.setFrozenRows(1);

  // Durum dropdown
  const lastRow = Math.max(sh.getMaxRows(), 200);
  const statusRange = sh.getRange(2, 6, lastRow - 1, 1);
  const rule = SpreadsheetApp.newDataValidation()
    .requireValueInList(["Aktif", "Pasif"], true)
    .setAllowInvalid(false)
    .build();
  statusRange.setDataValidation(rule);

  // Ã–rnek satÄ±r (boÅŸsa ekle)
  if (sh.getLastRow() < 2) {
    sh.getRange(2, 1, 1, headers.length).setValues([[
      "U-0001",
      "Ã–rnek KullanÄ±cÄ±",
      Session.getActiveUser().getEmail() || "",
      "Ã–rnek Firma",
      "Admin",
      "Aktif",
      new Date(),
      "Ä°stersen sil",
    ]]);
  }
}

/** ---- TAB: Firma GiriÅŸ Roller ---- **/
function buildCompanyRolesSheet_(shCompanyRoles, shUsers) {
  const headers = [
    "Firma",
    "Rol",
    "AÃ§Ä±klama",
    "VarsayÄ±lan mÄ±?",
    "Aktif mi?",
    "OluÅŸturan",
    "OluÅŸturma Tarihi",
  ];

  resetSheet_(shCompanyRoles, headers);
  shCompanyRoles.setFrozenRows(1);
  shCompanyRoles.setColumnWidths(1, headers.length, 180);

  // Dropdown: VarsayÄ±lan mÄ±? / Aktif mi?
  const lastRow = Math.max(shCompanyRoles.getMaxRows(), 200);
  const defaultRange = shCompanyRoles.getRange(2, 4, lastRow - 1, 1);
  const activeRange = shCompanyRoles.getRange(2, 5, lastRow - 1, 1);

  const yesNoRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(["Evet", "HayÄ±r"], true)
    .setAllowInvalid(false)
    .build();
  defaultRange.setDataValidation(yesNoRule);
  activeRange.setDataValidation(yesNoRule);

  // Ã–rnek roller
  if (shCompanyRoles.getLastRow() < 2) {
    shCompanyRoles.getRange(2, 1, 3, headers.length).setValues([
      ["Ã–rnek Firma", "Admin", "TÃ¼m yetkiler", "Evet", "Evet", Session.getActiveUser().getEmail() || "", new Date()],
      ["Ã–rnek Firma", "Rapor GÃ¶rÃ¼ntÃ¼leyici", "Sadece rapor gÃ¶rÃ¼ntÃ¼ler", "HayÄ±r", "Evet", Session.getActiveUser().getEmail() || "", new Date()],
      ["Ã–rnek Firma", "Operasyon", "Operasyon ekranlarÄ±", "HayÄ±r", "Evet", Session.getActiveUser().getEmail() || "", new Date()],
    ]);
  }

  // KullanÄ±cÄ±lar tabÄ±ndaki Firma ve Rol kolonlarÄ±na dropdown kuralÄ± istersen:
  // - Firma: KullanÄ±cÄ±lar!D
  // - Rol: KullanÄ±cÄ±lar!E
  // Bu dropdownâ€™larÄ± otomatik baÄŸlayalÄ±m (Firma listesi ve rol listesi dinamik)
  try {
    applyUserDropdowns_(shUsers, shCompanyRoles);
  } catch (e) {
    // sessiz geÃ§
  }
}

function applyUserDropdowns_(shUsers, shCompanyRoles) {
  // Firma listesi: Firma GiriÅŸ Roller!A (benzersiz)
  // Rol listesi: Firma GiriÅŸ Roller!B (benzersiz)
  // Basit yaklaÅŸÄ±m: tÃ¼m A ve B sÃ¼tunlarÄ±nÄ± kaynak al
  const maxRows = Math.max(shCompanyRoles.getLastRow(), 2);
  const firmaSource = `'${CFG.SHEETS.COMPANY_ROLES}'!A2:A${maxRows}`;
  const rolSource = `'${CFG.SHEETS.COMPANY_ROLES}'!B2:B${maxRows}`;

  const usersMax = Math.max(shUsers.getMaxRows(), 200);

  const firmaRange = shUsers.getRange(2, 4, usersMax - 1, 1); // D
  const rolRange = shUsers.getRange(2, 5, usersMax - 1, 1);   // E

  const firmaRule = SpreadsheetApp.newDataValidation()
    .requireFormulaSatisfied(`=COUNTIF(${firmaSource},D2)>0`)
    .setAllowInvalid(true)
    .build();

  // NOT: requireFormulaSatisfied tek hÃ¼cre referansÄ± istediÄŸi iÃ§in bu yaklaÅŸÄ±m sÄ±nÄ±rlÄ±.
  // Bu yÃ¼zden en saÄŸlam yÃ¶ntem valueInRange:
  const firmaRule2 = SpreadsheetApp.newDataValidation()
    .requireValueInRange(shCompanyRoles.getRange(2, 1, Math.max(1, maxRows - 1), 1), true)
    .setAllowInvalid(true)
    .build();
  const rolRule2 = SpreadsheetApp.newDataValidation()
    .requireValueInRange(shCompanyRoles.getRange(2, 2, Math.max(1, maxRows - 1), 1), true)
    .setAllowInvalid(true)
    .build();

  firmaRange.setDataValidation(firmaRule2);
  rolRange.setDataValidation(rolRule2);
}

/** ---- TAB: Rapor Yetkileri ---- **/
function buildReportPermsSheet_(sh) {
  const headers = [
    "Rol",
    "Rapor Kodu",
    "Rapor AdÄ±",
    "GÃ¶rÃ¼ntÃ¼leme",
    "Export",
    "Filtre KullanÄ±mÄ±",
    "AÃ§Ä±klama",
    "GÃ¼ncelleyen",
    "GÃ¼ncelleme Tarihi",
  ];

  resetSheet_(sh, headers);
  sh.setFrozenRows(1);
  sh.setColumnWidths(1, headers.length, 170);

  // Evet/HayÄ±r dropdown
  const lastRow = Math.max(sh.getMaxRows(), 300);
  const yesNoRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(["Evet", "HayÄ±r"], true)
    .setAllowInvalid(false)
    .build();

  sh.getRange(2, 4, lastRow - 1, 3).setDataValidation(yesNoRule); // GÃ¶rÃ¼ntÃ¼leme/Export/Filtre

  // Ã–rnek
  if (sh.getLastRow() < 2) {
    sh.getRange(2, 1, 3, headers.length).setValues([
      ["Admin", "RPT-001", "Genel Dashboard", "Evet", "Evet", "Evet", "TÃ¼m eriÅŸim", Session.getActiveUser().getEmail() || "", new Date()],
      ["Rapor GÃ¶rÃ¼ntÃ¼leyici", "RPT-001", "Genel Dashboard", "Evet", "HayÄ±r", "Evet", "Sadece gÃ¶rÃ¼ntÃ¼leme", Session.getActiveUser().getEmail() || "", new Date()],
      ["Operasyon", "RPT-010", "Operasyon KPI", "Evet", "Evet", "Evet", "Operasyon raporu", Session.getActiveUser().getEmail() || "", new Date()],
    ]);
  }
}

/** ---- TAB: GiriÅŸ KayÄ±tlarÄ± ---- **/
function buildLoginLogsSheet_(sh) {
  const headers = [
    "Tarih-Saat",
    "Aksiyon",
    "KullanÄ±cÄ± E-posta",
    "Spreadsheet",
    "Sheet",
    "Not",
  ];

  resetSheet_(sh, headers);
  sh.setFrozenRows(1);
  sh.setColumnWidths(1, headers.length, 200);
}

/** ---- LOG YAZMA ---- **/
function logLoginEvent_(action, note) {
  const ss = SpreadsheetApp.getActive();
  const sh = getOrCreateSheet_(ss, CFG.SHEETS.LOGIN_LOGS);
  if (sh.getLastRow() === 0) buildLoginLogsSheet_(sh);

  const email = Session.getActiveUser().getEmail() || "UNKNOWN";
  const activeSheet = ss.getActiveSheet();
  const row = [
    new Date(),
    action || "",
    email,
    ss.getName(),
    activeSheet ? activeSheet.getName() : "",
    note || "",
  ];

  sh.appendRow(row);
}

/** MenÃ¼den manuel login log */
function logManualLogin() {
  logLoginEvent_("LOGIN", "Manuel tetikleme (menÃ¼)");
  SpreadsheetApp.getUi().alert("GiriÅŸ kaydÄ± eklendi âœ…");
}

/** ---- EXCEL EXPORT: KullanÄ±cÄ±lar ---- **/
function exportUsersToExcel() {
  const ss = SpreadsheetApp.getActive();
  const usersSheet = ss.getSheetByName(CFG.SHEETS.USERS);
  if (!usersSheet) {
    SpreadsheetApp.getUi().alert(`'${CFG.SHEETS.USERS}' tabÄ± bulunamadÄ±. Ã–nce 'TablarÄ± Kur / DÃ¼zelt' Ã§alÄ±ÅŸtÄ±r.`);
    return;
  }

  // Export edilecek aralÄ±k: KullanÄ±cÄ±lar tabÄ±ndaki dolu alan
  const lastRow = Math.max(usersSheet.getLastRow(), 1);
  const lastCol = Math.max(usersSheet.getLastColumn(), 1);

  // GeÃ§ici bir spreadsheet oluÅŸturup kullanÄ±cÄ±larÄ± oraya kopyalayÄ±p xlsx export almak en saÄŸlam yÃ¶ntem
  const temp = SpreadsheetApp.create(`KullanÄ±cÄ±lar Export - ${formatNow_()}`);
  const tempSs = SpreadsheetApp.openById(temp.getId());
  const tempSh = tempSs.getSheets()[0];
  tempSh.setName("KullanÄ±cÄ±lar");

  const values = usersSheet.getRange(1, 1, lastRow, lastCol).getValues();
  tempSh.getRange(1, 1, values.length, values[0].length).setValues(values);
  tempSh.setFrozenRows(1);

  // XLSX olarak Driveâ€™a export et
  const xlsxBlob = exportSpreadsheetAsXlsx_(tempSs.getId(), `KullanÄ±cÄ±lar_${formatNow_()}.xlsx`);
  const file = DriveApp.createFile(xlsxBlob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  // GeÃ§ici dosyayÄ± sil (Driveâ€™dan) â€” sadece spreadsheetâ€™i Ã§Ã¶pe at
  DriveApp.getFileById(tempSs.getId()).setTrashed(true);

  // Log
  logLoginEvent_("EXPORT_USERS_XLSX", `Dosya: ${file.getName()}`);

  SpreadsheetApp.getUi().alert(
    "Excel export hazÄ±r âœ…\n\nLink (Drive):\n" + file.getUrl() +
    "\n\nNot: Linki aÃ§Ä±p indir menÃ¼sÃ¼nden .xlsx indirebilirsin."
  );
}

function exportSpreadsheetAsXlsx_(spreadsheetId, filename) {
  const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx`;
  const token = ScriptApp.getOAuthToken();
  const resp = UrlFetchApp.fetch(url, {
    headers: { Authorization: "Bearer " + token },
    muteHttpExceptions: true,
  });

  const code = resp.getResponseCode();
  if (code !== 200) {
    throw new Error("XLSX export baÅŸarÄ±sÄ±z. HTTP " + code + " | " + resp.getContentText());
  }

  const blob = resp.getBlob().setName(filename);
  return blob;
}

/** ---- YARDIMCILAR ---- **/
function getOrCreateSheet_(ss, name) {
  let sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name);
  return sh;
}

function resetSheet_(sh, headers) {
  // Sheet boÅŸ deÄŸilse sadece header yapÄ±sÄ±nÄ± garanti edelim (tamamen silmek yerine gÃ¼venli)
  // Ä°stersen burada sh.clear() yapabilirsin; ben "tablar Ã§alÄ±ÅŸmÄ±yor" dediÄŸin iÃ§in kesin dÃ¼zeltmek adÄ±na clear yapÄ±yorum.
  sh.clear();

  sh.getRange(CFG.HEADER_ROW, 1, 1, headers.length).setValues([headers]);
  const headerRange = sh.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight("bold");
  headerRange.setWrap(true);
  sh.setFrozenRows(1);
}

function formatNow_() {
  const d = new Date();
  const pad = (n) => String(n).padStart(2, "0");
  return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}
